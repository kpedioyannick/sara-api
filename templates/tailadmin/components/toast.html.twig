<div 
    x-data="toastManager()"
    class="fixed top-4 right-4 z-[100] space-y-2"
>
    <template x-for="(toast, index) in toasts" :key="index">
        <div
            x-show="toast.visible"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform translate-x-full"
            x-transition:enter-end="opacity-100 transform translate-x-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            :class="{
                'bg-success-50 border-success-200 text-success-800 dark:bg-success-900/30 dark:border-success-800 dark:text-success-400': toast.type === 'success',
                'bg-error-50 border-error-200 text-error-800 dark:bg-error-900/30 dark:border-error-800 dark:text-error-400': toast.type === 'error',
                'bg-warning-50 border-warning-200 text-warning-800 dark:bg-warning-900/30 dark:border-warning-800 dark:text-warning-400': toast.type === 'warning',
                'bg-brand-50 border-brand-200 text-brand-800 dark:bg-brand-900/30 dark:border-brand-800 dark:text-brand-400': toast.type === 'info',
            }"
            class="flex items-center gap-3 rounded-lg border px-4 py-3 shadow-lg min-w-[300px] max-w-md"
        >
            <svg 
                x-show="toast.type === 'success'"
                class="h-5 w-5 flex-shrink-0" 
                fill="currentColor" 
                viewBox="0 0 20 20"
            >
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <svg 
                x-show="toast.type === 'error'"
                class="h-5 w-5 flex-shrink-0" 
                fill="currentColor" 
                viewBox="0 0 20 20"
            >
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div class="flex-1">
                <p class="text-sm font-medium" x-text="toast.message"></p>
            </div>
            <button
                @click="removeToast(index)"
                class="text-current opacity-70 hover:opacity-100"
            >
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </template>
</div>

<script>
// Queue pour stocker les toasts avant l'initialisation d'Alpine
window._toastQueue = window._toastQueue || [];

function toastManager() {
    return {
        toasts: [],
        init() {
            console.log('toastManager init() appelé');
            // Écouter les événements personnalisés pour afficher des toasts
            window.addEventListener('show-toast', (event) => {
                console.log('Événement show-toast reçu:', event.detail);
                this.show(event.detail.message, event.detail.type || 'info');
            });
            
            // Traiter les toasts en attente
            if (window._toastQueue && window._toastQueue.length > 0) {
                console.log('Traitement des toasts en queue:', window._toastQueue.length);
                window._toastQueue.forEach(({ message, type }) => {
                    this.show(message, type);
                });
                window._toastQueue = [];
            }
        },
        show(message, type = 'info') {
            console.log('toastManager.show() appelé avec:', message, type);
            const toast = {
                message,
                type,
                visible: true,
            };
            this.toasts.push(toast);
            console.log('Toast ajouté, total toasts:', this.toasts.length);
            setTimeout(() => {
                this.removeToast(this.toasts.indexOf(toast));
            }, 5000);
        },
        removeToast(index) {
            if (this.toasts[index]) {
                this.toasts[index].visible = false;
                setTimeout(() => {
                    this.toasts.splice(index, 1);
                }, 200);
            }
        }
    };
}

// Fonction globale pour faciliter l'accès depuis n'importe où
window.showToast = function(message, type = 'info') {
    console.log('window.showToast appelé avec:', message, type);
    
    const toastElement = document.querySelector('[x-data="toastManager()"]');
    console.log('toastElement dans showToast:', toastElement);
    console.log('toastElement.__x:', toastElement?.__x);
    console.log('toastElement.__x.$data:', toastElement?.__x?.$data);
    
    if (toastElement) {
        // Essayer d'accéder via Alpine.js
        if (toastElement.__x && toastElement.__x.$data) {
            console.log('Utilisation de __x.$data.show');
            try {
                const result = toastElement.__x.$data.show(message, type);
                console.log('show() appelé, résultat:', result);
                console.log('toasts après show:', toastElement.__x.$data.toasts);
                return;
            } catch (e) {
                console.error('Erreur lors de l\'appel à __x.$data.show:', e);
                console.error('Stack:', e.stack);
            }
        } else {
            console.log('toastElement.__x.$data non disponible, Alpine peut ne pas être initialisé');
        }
    } else {
        console.log('toastElement non trouvé dans le DOM');
    }
    
    // Utiliser un événement personnalisé
    console.log('Envoi de l\'événement personnalisé show-toast');
    try {
        const event = new CustomEvent('show-toast', { 
            detail: { message, type } 
        });
        window.dispatchEvent(event);
        console.log('Événement show-toast envoyé');
        
        // Ajouter aussi à la queue au cas où Alpine n'est pas encore initialisé
        if (!window._toastQueue) {
            window._toastQueue = [];
        }
        window._toastQueue.push({ message, type });
        console.log('Toast ajouté à la queue, taille:', window._toastQueue.length);
        
        // Vérifier après un court délai si le toast s'est affiché
        setTimeout(() => {
            const checkElement = document.querySelector('[x-data="toastManager()"]');
            if (checkElement?.__x?.$data) {
                const toastsCount = checkElement.__x.$data.toasts?.length || 0;
                console.log('Toasts dans le manager après événement:', toastsCount);
                if (toastsCount === 0) {
                    console.log('Aucun toast ajouté après événement, utilisation d\'alert');
                    alert(message);
                }
            } else {
                console.log('Toast manager non disponible après événement, utilisation d\'alert');
                alert(message);
            }
        }, 300);
    } catch (e) {
        console.error('Erreur lors de l\'envoi de l\'événement:', e);
        // Dernier recours: alert immédiat
        alert(message);
    }
};
</script>

