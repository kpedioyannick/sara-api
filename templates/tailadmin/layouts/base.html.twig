<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>{% block page_title %}{{ pageTitle|default('TailAdmin') }}{% endblock %}</title>
    <link rel="icon" href="{{ asset('tailadmin/favicon.ico') }}">
    <link href="{{ asset('tailadmin/style.css') }}" rel="stylesheet">
    <link href="{{ asset('styles/theme-colors.css') }}" rel="stylesheet">
    
    {# PWA Manifest - Permet d'installer l'app sur mobile/desktop #}
    <link rel="manifest" href="{{ asset('manifest.json') }}">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SARA">
    <link rel="apple-touch-icon" href="{{ asset('tailadmin/favicon.ico') }}">
    
    {# Firebase SDK - Utilis√© uniquement pour Firebase Cloud Messaging (notifications push) #}
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js"></script>
    
    {# Protection contre les erreurs Firebase #}
    <script>
        // Gestionnaire d'erreur global pour Firebase
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message && event.error.message.includes('insert is not a function')) {
                console.warn('‚ö†Ô∏è Erreur Firebase d√©tect√©e (e.insert is not a function) - Ignor√©e pour √©viter de casser l\'application');
                event.preventDefault(); // Emp√™cher l'erreur de remonter
                return false;
            }
        }, true);
        
        // Gestionnaire pour les erreurs non captur√©es
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && event.reason.message.includes('insert is not a function')) {
                console.warn('‚ö†Ô∏è Erreur Firebase Promise rejet√©e (e.insert is not a function) - Ignor√©e');
                event.preventDefault();
            }
        });
    </script>
    
    {% block stylesheets %}{% endblock %}
</head>
<body
    x-data="{ page: '{{ pageName|default('blank') }}', 'loaded': true, 'darkMode': false, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
        darkMode = JSON.parse(localStorage.getItem('darkMode'));
        $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark bg-gray-900': darkMode === true}"
>
    {% include 'tailadmin/components/preloader.html.twig' %}

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
        {% if app.user %}
            {% include 'tailadmin/components/sidebar.html.twig' %}
        {% endif %}

        <!-- ===== Content Area Start ===== -->
        <div class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto">
            {% if app.user %}
                {% include 'tailadmin/components/overlay.html.twig' %}
                {% include 'tailadmin/components/header.html.twig' %}
            {% endif %}

            <!-- ===== Main Content Start ===== -->
            <main>
                {% block content %}{% endblock %}
            </main>
            <!-- ===== Main Content End ===== -->
        </div>
        <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    {% include 'tailadmin/components/alert.html.twig' %}
    <script defer src="{{ asset('tailadmin/bundle.js') }}"></script>
    
    {% if app.user %}
    {# Initialisation Firebase Cloud Messaging pour les notifications push #}
    <script>
    (function() {
        // V√©rifier que Firebase est charg√©
        if (typeof firebase === 'undefined') {
            console.warn('Firebase non charg√©, notifications push d√©sactiv√©es');
            return;
        }

        // Enregistrer le Service Worker d'abord
        let serviceWorkerRegistration = null;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then((registration) => {
                    console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                    serviceWorkerRegistration = registration;
                    // Continuer l'initialisation FCM apr√®s l'enregistrement du SW
                    initializeFCM(serviceWorkerRegistration);
                })
                .catch((error) => {
                    console.error('‚ùå Erreur enregistrement Service Worker:', error);
                    // Essayer quand m√™me d'initialiser FCM sans SW
                    initializeFCM(null);
                });
        } else {
            // Pas de support Service Worker, initialiser FCM quand m√™me
            initializeFCM(null);
        }

        function initializeFCM(swRegistration) {
            // R√©cup√©rer la configuration Firebase
            fetch('/admin/firebase/config')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.config) {
                        console.error('Erreur r√©cup√©ration config Firebase');
                        return;
                    }

                    const firebaseConfig = data.config;
                    
                    // Initialiser Firebase
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }

                    const messaging = firebase.messaging();

                    // Demander la permission et obtenir le token
                    Notification.requestPermission()
                        .then((permission) => {
                            if (permission === 'granted') {
                                console.log('‚úÖ Permission accord√©e pour les notifications');
                                
                                // Pr√©parer les options pour getToken
                                // Firebase SDK g√®re automatiquement la cl√© VAPID avec la config du projet
                                const tokenOptions = {};
                                
                                // Si on a un Service Worker, l'utiliser
                                if (swRegistration) {
                                    tokenOptions.serviceWorkerRegistration = swRegistration;
                                }
                                
                                return messaging.getToken(tokenOptions);
                            } else {
                                console.warn('Permission refus√©e pour les notifications');
                                return null;
                            }
                        })
                        .then((token) => {
                            if (token) {
                                console.log('‚úÖ Token FCM obtenu:', token.substring(0, 20) + '...');
                                // Envoyer le token au serveur
                                fetch('/admin/firebase/register-token', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ token: token })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Token FCM enregistr√© avec succ√®s');
                                    } else {
                                        console.error('Erreur enregistrement token:', data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Erreur envoi token:', error);
                                });
                            } else {
                                console.warn('Aucun token FCM disponible');
                            }
                        })
                        .catch((error) => {
                            console.error('Erreur permission/token FCM:', error);
                        });

                    // √âcouter les messages en premier plan
                    messaging.onMessage((payload) => {
                        console.log('üì® Message re√ßu en premier plan:', payload);
                        
                        // Afficher une notification personnalis√©e
                        if (Notification.permission === 'granted') {
                            const notificationTitle = payload.notification?.title || payload.data?.title || 'Nouvelle notification';
                            const notificationOptions = {
                                body: payload.notification?.body || payload.data?.body || '',
                                icon: '/tailadmin/favicon.ico',
                                badge: '/tailadmin/favicon.ico',
                                vibrate: [200, 100, 200],
                                tag: payload.data?.tag || 'default',
                                data: payload.data || {}
                            };

                            new Notification(notificationTitle, notificationOptions);
                        }
                    });
                })
                .catch(error => {
                    console.error('Erreur initialisation FCM:', error);
                });
        }
    })();
    </script>
    {% endif %}
</body>
</html>

