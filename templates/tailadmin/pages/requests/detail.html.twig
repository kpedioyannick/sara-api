{% extends 'tailadmin/layouts/base.html.twig' %}

{% block content %}
<div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
    {% include 'tailadmin/components/breadcrumb.html.twig' with { items: breadcrumbs } %}

    <!-- Request Details Card -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mb-6">
        <div class="p-4 xl:p-6">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h3 class="text-2xl font-semibold text-gray-800 dark:text-white/90 mb-2">
                        {{ request.title }}
                    </h3>
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <span class="inline-flex rounded-full bg-brand-50 px-3 py-1 text-sm font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400">
                            {{ request.type|upper }}
                        </span>
                        {% if request.priority == 'high' %}
                        <span class="inline-flex items-center rounded-full bg-error-100 px-2.5 py-0.5 text-xs font-medium text-error-600 dark:bg-error-900/30 dark:text-error-400">
                            Priorité: Haute
                        </span>
                        {% elseif request.priority == 'medium' %}
                        <span class="inline-flex items-center rounded-full bg-warning-100 px-2.5 py-0.5 text-xs font-medium text-warning-600 dark:bg-warning-900/30 dark:text-warning-400">
                            Priorité: Moyenne
                        </span>
                        {% else %}
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 dark:bg-gray-800 dark:text-gray-400">
                            Priorité: Basse
                        </span>
                        {% endif %}
                        {% if request.status == 'resolved' %}
                        <span class="inline-flex items-center rounded-full bg-success-100 px-2.5 py-0.5 text-xs font-medium text-success-600 dark:bg-success-900/30 dark:text-success-400">
                            Résolue
                        </span>
                        {% elseif request.status == 'in_progress' %}
                        <span class="inline-flex items-center rounded-full bg-brand-100 px-2.5 py-0.5 text-xs font-medium text-brand-600 dark:bg-brand-900/30 dark:text-brand-400">
                            En cours
                        </span>
                        {% else %}
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 dark:bg-gray-800 dark:text-gray-400">
                            En attente
                        </span>
                        {% endif %}
                    </div>
                </div>
                <a href="{{ path('admin_requests_list') }}" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03]">
                    <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 16.7071C9.31658 17.0976 8.68342 17.0976 8.29289 16.7071L2.29289 10.7071C1.90237 10.3166 1.90237 9.68342 2.29289 9.29289L8.29289 3.29289C8.68342 2.90237 9.31658 2.90237 9.70711 3.29289C10.0976 3.68342 10.0976 4.31658 9.70711 4.70711L5.41421 9H17C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11H5.41421L9.70711 15.2929C10.0976 15.6834 10.0976 16.3166 9.70711 16.7071Z" fill=""/>
                    </svg>
                    Retour
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-50 dark:bg-brand-500/15">
                        <svg class="fill-current text-brand-500 dark:text-brand-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM9 11V9H11V11H9ZM9 13V11H11V13H9Z" fill=""/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Créée par</p>
                        <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ request.creatorName }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning-50 dark:bg-warning-500/15">
                        <svg class="fill-current text-warning-500 dark:text-warning-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM13.7071 8.29289C14.0976 7.90237 14.0976 7.26921 13.7071 6.87868C13.3166 6.48816 12.6834 6.48816 12.2929 6.87868L9 10.1716L7.70711 8.87868C7.31658 8.48816 6.68342 8.48816 6.29289 8.87868C5.90237 9.26921 5.90237 9.90237 6.29289 10.2929L8.29289 12.2929C8.68342 12.6834 9.31658 12.6834 9.70711 12.2929L13.7071 8.29289Z" fill=""/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Destinataire</p>
                        <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ request.recipientName }}</p>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</h4>
                <p class="text-base text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{{ request.description }}</p>
            </div>

            {% if request.response %}
            <div class="mt-4">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Réponse</h4>
                <p class="text-base text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{{ request.response }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ====== Chat Section Start ====== -->
    <div class="rounded-lg border border-gray-200 bg-white shadow-default dark:border-gray-800 dark:bg-gray-900">
        <!-- Header -->
        <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    {% if otherUser %}
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700">
                        <span class="font-semibold text-gray-600 dark:text-gray-300">
                            {{ otherUser.firstName|first|upper }}{{ otherUser.lastName|first|upper }}
                        </span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">
                            {{ otherUser.firstName }} {{ otherUser.lastName }}
                        </h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            {{ otherUser.email }}
                            {% if otherUser.userType %}
                                <span class="ml-2">({{ otherUser.userType|capitalize }})</span>
                            {% endif %}
                        </p>
                    </div>
                    {% else %}
                    <div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">Messages</h3>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div 
            class="flex h-[600px] flex-col"
            x-data="requestChatManager({{ requestId }})"
            x-init="init()"
        >
            <!-- Messages List -->
            <div
                id="messages-container"
                class="flex-1 space-y-4 overflow-y-auto p-6"
            >
                {% for message in messages %}
                    <div class="flex {% if message.isFromMe %}justify-end{% else %}justify-start{% endif %} gap-2" data-message-id="{{ message.id }}" data-message-type="{{ message.type|default('text') }}">
                        <!-- Checkbox pour sélection -->
                        <div class="flex items-start pt-6" x-show="aiAssistMode">
                            <input
                                type="checkbox"
                                :value="{{ message.id }}"
                                x-model="selectedMessageIds"
                                class="h-4 w-4 rounded border-gray-300 text-brand-500 focus:ring-brand-500 dark:border-gray-700"
                            />
                        </div>
                        <div class="flex max-w-[70%] flex-col {% if message.isFromMe %}items-end{% else %}items-start{% endif %}">
                            <span class="mb-1 text-xs text-gray-500 dark:text-gray-400">
                                {{ message.sender.firstName }} {{ message.sender.lastName }}
                                {% if message.sender.userType %}
                                    <span class="text-gray-400">({{ message.sender.userType|capitalize }})</span>
                                {% endif %}
                            </span>
                            <div
                                class="rounded-lg px-4 py-2 {% if message.isFromMe %}bg-brand-600{% else %}bg-gray-100 dark:bg-gray-700{% endif %}"
                            >
                                {% if message.type|default('') == 'image' and message.filePath %}
                                    <img 
                                        src="{{ message.filePath }}" 
                                        alt="Image" 
                                        class="max-w-full h-auto rounded cursor-pointer hover:opacity-90 transition-opacity"
                                        @click="openImageModal('{{ message.filePath }}')"
                                        style="max-height: 300px;"
                                    />
                                    {% if message.content %}
                                        <p class="text-sm mt-2 {% if message.isFromMe %}text-black{% else %}!text-gray-950 dark:!text-gray-100{% endif %}">{{ message.content }}</p>
                                    {% endif %}
                                {% elseif message.type|default('') == 'audio' %}
                                    {% if message.filePath %}
                                        <div class="flex items-center gap-2">
                                            <audio 
                                                controls 
                                                class="w-full max-w-xs" 
                                                style="min-width: 250px; height: 40px;"
                                                preload="metadata"
                                                data-audio-id="{{ message.id }}"
                                                onloadedmetadata="if (this.duration && !isNaN(this.duration) && this.duration > 0) { this.style.display = 'block'; }"
                                                oncanplay="if (this.duration && !isNaN(this.duration) && this.duration > 0) { this.style.display = 'block'; }"
                                            >
                                                <source src="{{ message.filePath }}" type="audio/webm">
                                                <source src="{{ message.filePath }}" type="audio/mpeg">
                                                <source src="{{ message.filePath }}" type="audio/wav">
                                                <source src="{{ message.filePath }}" type="audio/ogg">
                                                <source src="{{ message.filePath }}" type="audio/mp3">
                                                Votre navigateur ne supporte pas l'élément audio.
                                            </audio>
                                        </div>
                                    {% else %}
                                        <p class="text-sm text-red-500">⚠️ Fichier audio non disponible</p>
                                    {% endif %}
                                    {% if message.content %}
                                        <p class="text-sm mt-2 {% if message.isFromMe %}text-black{% else %}!text-gray-950 dark:!text-gray-100{% endif %}">{{ message.content }}</p>
                                    {% endif %}
                                {% else %}
                                    <p class="text-sm whitespace-pre-wrap {% if message.isFromMe %}text-black{% else %}!text-gray-950 dark:!text-gray-100{% endif %}">
                                        {% if message.content is defined and message.content is not null and message.content is not empty %}
                                            {{ message.content }}
                                        {% else %}
                                            <span class="italic opacity-75 {% if message.isFromMe %}text-black{% else %}text-gray-600 dark:text-gray-400{% endif %}">(Message vide)</span>
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                            <span class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                {% if message.createdAt %}
                                    {{ message.createdAt|date('d/m/Y H:i') }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                {% else %}
                    <div class="flex items-center justify-center h-full">
                        <p class="text-gray-500 dark:text-gray-400">Aucun message pour le moment</p>
                    </div>
                {% endfor %}
            </div>

            <!-- Zone d'Assistance IA -->
            <div 
                x-show="aiAssistMode" 
                class="border-t border-gray-200 bg-gray-50 dark:bg-gray-800/50 p-4 dark:border-gray-800"
                x-transition
            >
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                            Assistance IA
                        </h4>
                        <button
                            type="button"
                            @click="toggleAIAssist()"
                            class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                        >
                            Fermer
                        </button>
                    </div>
                    
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        <span x-show="selectedMessageIds.length === 0">Sélectionnez des messages pour donner le contexte</span>
                        <span x-show="selectedMessageIds.length > 0">
                            <span x-text="selectedMessageIds.length"></span> message(s) sélectionné(s)
                        </span>
                    </div>
                    
                    <textarea
                        x-model="aiUserQuestion"
                        placeholder="Posez votre question ou décrivez ce que vous souhaitez que l'IA fasse..."
                        rows="3"
                        class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
                    ></textarea>
                    
                    <div class="flex gap-2">
                        <button
                            type="button"
                            @click="requestAIAssist()"
                            :disabled="aiGenerating || selectedMessageIds.length === 0"
                            class="flex-1 rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span x-show="!aiGenerating">Demander à l'IA</span>
                            <span x-show="aiGenerating">Génération...</span>
                        </button>
                    </div>
                    
                    <!-- Réponse de l'IA -->
                    <div 
                        x-show="aiResponse"
                        class="rounded-lg border border-brand-200 bg-brand-50 p-4 dark:border-brand-800 dark:bg-brand-900/20"
                        x-transition
                    >
                        <div class="mb-2 flex items-center gap-2">
                            <svg class="h-4 w-4 text-brand-600 dark:text-brand-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <span class="text-xs font-medium text-brand-700 dark:text-brand-300">Réponse de l'IA</span>
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="aiResponse"></p>
                        <button
                            type="button"
                            @click="useAIResponse()"
                            class="mt-3 w-full rounded-lg border border-brand-500 bg-white px-4 py-2 text-sm font-medium text-brand-600 hover:bg-brand-50 dark:border-brand-400 dark:bg-gray-800 dark:text-brand-400 dark:hover:bg-gray-700"
                        >
                            Utiliser cette réponse
                        </button>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="border-t border-gray-200 p-4 dark:border-gray-800">
                <form @submit.prevent="sendMessage()" class="space-y-2">
                    <!-- Boutons d'upload - Ligne séparée sur mobile -->
                    <div class="flex flex-wrap gap-2 justify-center sm:justify-start">
                        <!-- Bouton Assistance IA -->
                        <button
                            type="button"
                            @click="toggleAIAssist()"
                            :class="aiAssistMode ? 'bg-brand-500 text-white' : 'border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700'"
                            class="rounded-lg p-2 transition-colors flex-shrink-0"
                            title="Assistance IA"
                        >
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </button>
                        <!-- Upload Image -->
                        <label class="cursor-pointer rounded-lg border border-gray-300 bg-white p-2 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 flex-shrink-0" title="Envoyer une image">
                            <input
                                type="file"
                                accept="image/*"
                                @change="handleImageUpload($event)"
                                class="hidden"
                            />
                            <svg class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </label>
                        <!-- Prendre une photo -->
                        <label class="cursor-pointer rounded-lg border border-gray-300 bg-white p-2 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 flex-shrink-0" title="Prendre une photo">
                            <input
                                type="file"
                                accept="image/*"
                                capture="environment"
                                @change="handleCameraCapture($event)"
                                class="hidden"
                            />
                            <svg class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A 2 0 0 1 10.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </label>
                        <!-- Upload Audio -->
                        <label class="cursor-pointer rounded-lg border border-gray-300 bg-white p-2 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 flex-shrink-0" title="Envoyer un fichier audio">
                            <input
                                type="file"
                                accept="audio/*"
                                @change="handleAudioUpload($event)"
                                class="hidden"
                            />
                            <svg class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                            </svg>
                        </label>
                        <!-- Enregistrer Audio -->
                        <button
                            type="button"
                            @click="toggleAudioRecording()"
                            :class="isRecording ? 'bg-error-500 text-white hover:bg-error-600' : 'border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700'"
                            class="rounded-lg p-2 transition-colors flex-shrink-0"
                            :title="isRecording ? 'Arrêter l\'enregistrement' : 'Enregistrer un audio'"
                        >
                            <svg x-show="!isRecording" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                            <svg x-show="isRecording" class="h-5 w-5 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" />
                            </svg>
                        </button>
                    </div>
                    <!-- Input et bouton Envoyer -->
                    <div class="flex gap-2 items-end">
                        <input
                            type="text"
                            x-model="messageContent"
                            placeholder="Tapez votre message..."
                            class="flex-1 min-w-0 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
                        />
                        <button
                            type="submit"
                            :disabled="sending || uploading"
                            class="rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 disabled:opacity-50 flex-shrink-0 sm:px-6"
                        >
                            <span x-show="!sending && !uploading" class="hidden sm:inline">Envoyer</span>
                            <span x-show="!sending && !uploading" class="sm:hidden">→</span>
                            <span x-show="sending || uploading">...</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Modal pour agrandir les images -->
            <div
                x-show="imageModalOpen"
                @click.away="closeImageModal()"
                @keydown.escape.window="closeImageModal()"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/75 backdrop-blur-sm"
                style="display: none;"
                x-cloak
            >
                <div class="relative max-w-7xl max-h-[90vh] p-4">
                    <button
                        @click="closeImageModal()"
                        class="absolute top-4 right-4 rounded-full bg-white/90 p-2 text-gray-800 hover:bg-white transition-colors"
                    >
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <img 
                        :src="imageModalSrc" 
                        alt="Image agrandie" 
                        class="max-w-full max-h-[90vh] rounded-lg shadow-2xl cursor-pointer"
                        @click="closeImageModal()"
                    />
                </div>
            </div>
            
            <!-- Modal pour prévisualiser l'audio enregistré -->
            <div
                x-show="recordedAudioUrl"
                @click.away="cancelRecordedAudio()"
                @keydown.escape.window="cancelRecordedAudio()"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
                style="display: none;"
                x-cloak
            >
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Prévisualiser l'enregistrement</h3>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            Durée: <span x-text="formatTime(recordingTime)"></span>
                        </p>
                        <audio :src="recordedAudioUrl" controls class="w-full"></audio>
                    </div>
                    <div class="flex gap-3">
                        <button
                            @click="cancelRecordedAudio()"
                            class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300"
                        >
                            Annuler
                        </button>
                        <button
                            @click="sendRecordedAudio()"
                            :disabled="uploading"
                            class="flex-1 rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span x-show="!uploading">Envoyer</span>
                            <span x-show="uploading">Envoi...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ====== Chat Section End ====== -->
</div>

<script>
function requestChatManager(requestId) {
    return {
        requestId: requestId,
        messageContent: '',
        messagesContainer: null,
        sending: false,
        uploading: false,
        pendingFile: null,
        imageModalOpen: false,
        imageModalSrc: '',
        // Enregistrement audio
        isRecording: false,
        mediaRecorder: null,
        audioStream: null,
        audioChunks: [],
        recordedAudioBlob: null,
        recordedAudioUrl: null,
        recordingTime: 0,
        recordingInterval: null,
        // Assistance IA
        aiAssistMode: false,
        selectedMessageIds: [],
        aiUserQuestion: '',
        aiResponse: '',
        aiGenerating: false,
        
        init() {
            // S'assurer que toutes les propriétés sont bien initialisées
            if (this.uploading === undefined) {
                this.uploading = false;
            }
            if (this.sending === undefined) {
                this.sending = false;
            }
            if (this.pendingFile === undefined) {
                this.pendingFile = null;
            }
            if (this.imageModalOpen === undefined) {
                this.imageModalOpen = false;
            }
            if (this.imageModalSrc === undefined) {
                this.imageModalSrc = '';
            }
            if (this.recordedAudioUrl === undefined) {
                this.recordedAudioUrl = null;
            }
            if (this.recordingTime === undefined) {
                this.recordingTime = 0;
            }
            
            this.messagesContainer = document.getElementById('messages-container');
            this.scrollToBottom();
            
            // Nettoyer l'enregistrement si l'utilisateur quitte la page
            window.addEventListener('beforeunload', () => {
                if (this.isRecording) {
                    this.stopAudioRecording();
                }
            });
        },
        
        scrollToBottom() {
            if (this.messagesContainer) {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        },
        
        async sendMessage() {
            if ((!this.messageContent.trim() && !this.pendingFile) || this.sending || this.uploading) return;
            
            const content = this.messageContent.trim();
            this.messageContent = '';
            this.sending = true;
            
            try {
                const response = await fetch('{{ path('admin_requests_messages_create', {id: requestId}) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        content: content || null,
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ success: false, message: 'Erreur lors de l\'envoi' }));
                    const errorMessage = errorData.message || `Erreur ${response.status}: ${response.statusText}`;
                    if (window.showToast) {
                        window.showToast(errorMessage, 'error');
                    }
                    this.messageContent = content;
                    return;
                }
                
                const result = await response.json().catch(() => ({ success: false, message: 'Erreur lors de l\'envoi' }));
                
                if (result.success) {
                    window.location.reload();
                } else {
                    const errorMessage = result.message || 'Erreur lors de l\'envoi du message';
                    if (window.showToast) {
                        window.showToast(errorMessage, 'error');
                    }
                    this.messageContent = content;
                }
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message:', error);
                if (window.showToast) {
                    window.showToast('Une erreur est survenue', 'error');
                }
                this.messageContent = content;
            } finally {
                this.sending = false;
            }
        },
        
        async handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            this.uploading = true;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('content', this.messageContent || '');
                
                const response = await fetch('{{ path('admin_requests_messages_create', {id: requestId}) }}', {
                    method: 'POST',
                    body: formData,
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    if (window.showToast) {
                        window.showToast('Erreur: ' + data.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                if (window.showToast) {
                    window.showToast('Erreur lors de l\'upload de l\'image', 'error');
                }
            } finally {
                this.uploading = false;
                event.target.value = '';
            }
        },
        
        async handleCameraCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                const fileExtension = file.name.split('.').pop() || 'jpg';
                
                this.uploading = true;
                
                try {
                    const response = await fetch('{{ path('admin_requests_messages_create', {id: requestId}) }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            fileData: base64Data,
                            fileType: 'image',
                            fileExtension: fileExtension,
                            content: this.messageContent || null,
                        }),
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.reload();
                    } else {
                        if (window.showToast) {
                            window.showToast('Erreur: ' + data.message, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    if (window.showToast) {
                        window.showToast('Erreur lors de l\'upload de la photo', 'error');
                    }
                } finally {
                    this.uploading = false;
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        },
        
        async handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            this.uploading = true;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('content', this.messageContent || '');
                
                const response = await fetch('{{ path('admin_requests_messages_create', {id: requestId}) }}', {
                    method: 'POST',
                    body: formData,
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    if (window.showToast) {
                        window.showToast('Erreur: ' + data.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Error uploading audio:', error);
                if (window.showToast) {
                    window.showToast('Erreur lors de l\'upload de l\'audio', 'error');
                }
            } finally {
                this.uploading = false;
                event.target.value = '';
            }
        },
        
        async toggleAudioRecording() {
            if (this.isRecording) {
                this.stopAudioRecording();
            } else {
                await this.startAudioRecording();
            }
        },
        
        async startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.audioStream = stream;
                
                this.mediaRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                this.recordingTime = 0;
                
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.audioChunks.push(event.data);
                    }
                };
                
                this.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                    this.recordedAudioBlob = audioBlob;
                    this.recordedAudioUrl = URL.createObjectURL(audioBlob);
                    
                    // Arrêter tous les tracks du stream
                    if (this.audioStream) {
                        this.audioStream.getTracks().forEach(track => track.stop());
                        this.audioStream = null;
                    }
                    
                    // Afficher un modal pour prévisualiser et envoyer
                    this.showAudioPreview();
                };
                
                this.mediaRecorder.onerror = (event) => {
                    console.error('Erreur lors de l\'enregistrement:', event);
                    if (window.showToast) {
                        window.showToast('Erreur lors de l\'enregistrement', 'error');
                    }
                    this.stopAudioRecording();
                };
                
                this.mediaRecorder.start();
                this.isRecording = true;
                
                // Démarrer le compteur de temps
                this.recordingInterval = setInterval(() => {
                    this.recordingTime++;
                }, 1000);
                
                if (window.showToast) {
                    window.showToast('Enregistrement démarré', 'info');
                }
            } catch (error) {
                console.error('Erreur lors du démarrage de l\'enregistrement:', error);
                if (window.showToast) {
                    window.showToast('Impossible d\'accéder au microphone. Vérifiez les permissions.', 'error');
                }
                this.isRecording = false;
            }
        },
        
        stopAudioRecording() {
            if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                this.mediaRecorder.stop();
            }
            this.isRecording = false;
            
            // Arrêter le stream si toujours actif
            if (this.audioStream) {
                this.audioStream.getTracks().forEach(track => track.stop());
                this.audioStream = null;
            }
            
            if (this.recordingInterval) {
                clearInterval(this.recordingInterval);
                this.recordingInterval = null;
            }
        },
        
        showAudioPreview() {
            // Le modal sera affiché automatiquement grâce à x-show="recordedAudioUrl"
            // Pas besoin de confirm(), le modal s'affiche
        },
        
        cancelRecordedAudio() {
            // Nettoyer
            if (this.recordedAudioUrl) {
                URL.revokeObjectURL(this.recordedAudioUrl);
            }
            this.recordedAudioBlob = null;
            this.recordedAudioUrl = null;
            this.recordingTime = 0;
        },
        
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        },
        
        async sendRecordedAudio() {
            if (!this.recordedAudioBlob) return;
            
            this.uploading = true;
            
            try {
                // Convertir le blob en File avec le bon MIME type
                const audioFile = new File([this.recordedAudioBlob], `recording-${Date.now()}.webm`, {
                    type: 'audio/webm'
                });
                
                // Vérifier que le fichier est valide
                if (!audioFile || audioFile.size === 0) {
                    if (window.showToast) {
                        window.showToast('Erreur: Fichier audio invalide', 'error');
                    }
                    this.uploading = false;
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', audioFile, audioFile.name);
                formData.append('content', this.messageContent || '');
                
                const response = await fetch('{{ path('admin_requests_messages_create', {id: requestId}) }}', {
                    method: 'POST',
                    body: formData,
                });
                
                // Vérifier si la réponse est OK avant de parser le JSON
                if (!response.ok) {
                    let errorMessage = 'Erreur lors de l\'envoi de l\'audio';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Erreur ${response.status}: ${response.statusText}`;
                    }
                    if (window.showToast) {
                        window.showToast(errorMessage, 'error');
                    }
                    this.uploading = false;
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Nettoyer
                    if (this.recordedAudioUrl) {
                        URL.revokeObjectURL(this.recordedAudioUrl);
                    }
                    this.recordedAudioBlob = null;
                    this.recordedAudioUrl = null;
                    this.recordingTime = 0;
                    this.messageContent = '';
                    
                    window.location.reload();
                } else {
                    if (window.showToast) {
                        window.showToast('Erreur: ' + (data.message || 'Erreur inconnue'), 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending recorded audio:', error);
                if (window.showToast) {
                    window.showToast('Erreur lors de l\'envoi de l\'audio: ' + error.message, 'error');
                }
            } finally {
                this.uploading = false;
            }
        },
        
        openImageModal(imageSrc) {
            this.imageModalSrc = imageSrc;
            this.imageModalOpen = true;
        },
        
        closeImageModal() {
            this.imageModalOpen = false;
            this.imageModalSrc = '';
        },
        
        // Fonctions pour l'Assistance IA
        toggleAIAssist() {
            this.aiAssistMode = !this.aiAssistMode;
            if (!this.aiAssistMode) {
                // Réinitialiser quand on ferme
                this.selectedMessageIds = [];
                this.aiUserQuestion = '';
                this.aiResponse = '';
            }
        },
        
        async requestAIAssist() {
            if (this.selectedMessageIds.length === 0 || this.aiGenerating) {
                return;
            }
            
            this.aiGenerating = true;
            this.aiResponse = '';
            
            try {
                const response = await fetch(`/admin/requests/${this.requestId}/ai-assist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        selectedMessageIds: this.selectedMessageIds.map(id => parseInt(id)),
                        userQuestion: this.aiUserQuestion || null,
                        additionalContext: null,
                    }),
                });
                
                const result = await response.json().catch(() => ({ success: false, message: 'Erreur lors de la génération' }));
                
                if (response.ok && result.success) {
                    this.aiResponse = result.content || '';
                    if (window.showToast) {
                        window.showToast('Réponse générée avec succès', 'success');
                    }
                } else {
                    const errorMessage = result.message || 'Erreur lors de la génération de l\'assistance';
                    if (window.showToast) {
                        window.showToast(errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la demande d\'assistance IA:', error);
                if (window.showToast) {
                    window.showToast('Erreur lors de la génération de l\'assistance', 'error');
                }
            } finally {
                this.aiGenerating = false;
            }
        },
        
        useAIResponse() {
            if (this.aiResponse) {
                this.messageContent = this.aiResponse;
                // Optionnel: fermer le mode assistance après utilisation
                // this.toggleAIAssist();
                if (window.showToast) {
                    window.showToast('Réponse copiée dans le champ de message', 'success');
                }
            }
        },
    };
}

// Script pour forcer le chargement de la durée des fichiers audio
document.addEventListener('DOMContentLoaded', function() {
    const audioElements = document.querySelectorAll('audio[data-audio-id]');
    audioElements.forEach(function(audio) {
        // Forcer le chargement des métadonnées
        audio.load();
        
        // Attendre que les métadonnées soient chargées
        audio.addEventListener('loadedmetadata', function() {
            if (this.duration && !isNaN(this.duration) && this.duration > 0) {
                console.log('Durée audio chargée:', this.duration, 'secondes pour audio ID:', this.dataset.audioId);
            }
        });
        
        // Si les métadonnées ne se chargent pas, essayer de charger un peu du fichier
        audio.addEventListener('canplay', function() {
            if (this.duration && !isNaN(this.duration) && this.duration > 0) {
                console.log('Durée audio disponible:', this.duration, 'secondes pour audio ID:', this.dataset.audioId);
            } else {
                // Si la durée n'est toujours pas disponible, essayer de jouer un peu
                const playPromise = this.play();
                if (playPromise !== undefined) {
                    playPromise.then(function() {
                        audio.pause();
                        audio.currentTime = 0;
                    }).catch(function(error) {
                        console.error('Erreur lors du chargement de la durée audio:', error);
                    });
                }
            }
        });
    });
});
</script>
{% endblock %}

