{% extends 'tailadmin/layouts/base.html.twig' %}

{% macro renderTask(task, objective) %}
  <div
    draggable="true"
    class="p-5 bg-white border border-gray-200 task rounded-xl shadow-theme-sm dark:border-gray-800 dark:bg-white/5 {% if task.status == 'completed' %}opacity-75{% endif %}"
  >
    <div class="flex flex-col gap-4">
      <!-- Ligne 1: Checkbox + Titre -->
      <div class="flex items-start gap-3">
        <label
          for="taskCheckbox{{ task.id }}"
          class="flex-shrink-0 {% if task.status != 'completed' %}cursor-pointer{% else %}cursor-not-allowed opacity-75{% endif %}"
          @click.stop
        >
          <input
            type="checkbox"
            id="taskCheckbox{{ task.id }}"
            class="sr-only taskCheckbox"
            data-task-id="{{ task.id }}"
            {% if task.status == 'completed' %}checked disabled{% endif %}
            data-task-title="{{ task.title|escape }}"
            data-task-status="{{ task.status }}"
            {% if task.status != 'completed' %}@change.stop="openProofModalFromCheckbox($event)"{% endif %}
            @click.stop
          />
          <div
            class="flex items-center justify-center w-5 h-5 border border-gray-300 rounded-md box dark:border-gray-700 {% if task.status == 'completed' %}bg-success-500 border-success-500{% else %}bg-white{% endif %}"
          >
            {% if task.status == 'completed' %}
            <span>
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.6668 3.5L5.25016 9.91667L2.3335 7"
                  stroke="white"
                  stroke-width="1.94437"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            {% else %}
            <span class="opacity-0">
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.6668 3.5L5.25016 9.91667L2.3335 7"
                  stroke="white"
                  stroke-width="1.94437"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            {% endif %}
          </div>
        </label>
        <div class="flex-1">
          <h4 class="text-base font-medium text-gray-800 dark:text-white/90 {% if task.status == 'completed' %}line-through opacity-50{% endif %}">
            {{ task.title }}
          </h4>
          
          <!-- Ligne 2: Affectation -->
          <div class="mt-1.5 flex items-center gap-1.5 text-sm text-gray-600 dark:text-gray-400">
            <span class="inline-flex items-center gap-1">
              {% if task.assignedType == 'student' and task.assignedTo %}
                <span class="text-base">üë§</span>
                <span>Affect√©e √† : {{ task.assignedTo.pseudo|default(task.assignedTo.firstName ~ ' ' ~ task.assignedTo.lastName) }}</span>
              {% elseif task.assignedType == 'parent' and task.assignedTo %}
                <span class="text-base">üë®‚Äçüë©</span>
                <span>Affect√©e √† : {{ task.assignedTo.firstName ~ ' ' ~ task.assignedTo.lastName }}</span>
              {% elseif task.assignedType == 'specialist' and task.assignedTo %}
                <span class="text-base">üë®‚Äç‚öïÔ∏è</span>
                <span>Affect√©e √† : {{ task.assignedTo.firstName ~ ' ' ~ task.assignedTo.lastName }}</span>
              {% else %}
                <span class="text-base">üë®‚Äçüè´</span>
                <span>Affect√©e √† : Coach</span>
              {% endif %}
            </span>
          </div>
          
          <!-- Ligne 3: Dates -->
          <div class="mt-1.5 text-sm text-gray-500 dark:text-gray-400">
            {% if task.createdAt and task.dueDate %}
              Du {{ task.createdAt|date('d/m/Y') }} au {{ task.dueDate|date('d/m/Y') }}
            {% elseif task.createdAt %}
              D√©but : {{ task.createdAt|date('d/m/Y') }}
            {% elseif task.dueDate %}
              Fin : {{ task.dueDate|date('d/m/Y') }}
            {% endif %}
          </div>
          
          <!-- Ligne 4: √âtoiles (preuves) -->
          {% if task.requiresProof %}
          <div class="mt-2 flex items-center gap-1">
            {% set proofCount = task.proofs|length %}
            {% for i in 1..proofCount %}
              <span class="text-yellow-400 text-lg">‚≠ê</span>
            {% endfor %}
            {% if proofCount == 0 %}
              <span class="text-xs text-gray-400 dark:text-gray-500">Aucune preuve</span>
            {% else %}
              <span class="ml-1 text-xs text-gray-500 dark:text-gray-400">{{ proofCount }} preuve{{ proofCount > 1 ? 's' : '' }}</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Ligne 5: Boutons d'action -->
      <div class="mt-3 flex flex-wrap gap-2 pt-3 border-t border-gray-200 dark:border-gray-800">
        <button
          data-task-id="{{ task.id }}"
          data-task-status="{{ task.status }}"
          data-task-frequency="{{ task.frequency|default('none') }}"
          data-task-requires-proof="{{ task.requiresProof ? 'true' : 'false' }}"
          data-task-title="{{ task.title|e('html_attr') }}"
          data-task-description="{{ task.description|e('html_attr') }}"
          data-task-assigned-type="{{ task.assignedType|default('coach') }}"
          data-task-student-id="{{ task.student ? task.student.id : '' }}"
          data-task-parent-id="{{ task.parent ? task.parent.id : '' }}"
          data-task-specialist-id="{{ task.specialist ? task.specialist.id : '' }}"
          data-task-activity-id="{{ task.activity ? task.activity.id : '' }}"
          data-task-created-at="{{ task.createdAt|default('') }}"
          data-task-due-date="{{ task.dueDate|default('') }}"
          @click="openTaskConfig($event)"
          class="inline-flex items-center gap-1.5 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 1C4.134 1 1 4.134 1 8s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12.5c-3.032 0-5.5-2.468-5.5-5.5S4.968 2.5 8 2.5 13.5 4.968 13.5 8 11.032 13.5 8 13.5z" fill=""/>
            <path d="M8 4.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm0 6a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill=""/>
          </svg>
          D√©tail
        </button>
        <button
          data-task-id="{{ task.id }}"
          data-task-status="{{ task.status }}"
          data-task-frequency="{{ task.frequency|default('none') }}"
          data-task-requires-proof="{{ task.requiresProof ? 'true' : 'false' }}"
          data-task-title="{{ task.title|e('html_attr') }}"
          data-task-description="{{ task.description|e('html_attr') }}"
          data-task-assigned-type="{{ task.assignedType|default('coach') }}"
          data-task-student-id="{{ task.student ? task.student.id : '' }}"
          data-task-parent-id="{{ task.parent ? task.parent.id : '' }}"
          data-task-specialist-id="{{ task.specialist ? task.specialist.id : '' }}"
          data-task-activity-id="{{ task.activity ? task.activity.id : '' }}"
          data-task-created-at="{{ task.createdAt|default('') }}"
          data-task-due-date="{{ task.dueDate|default('') }}"
          @click="openTaskConfig($event)"
          {% if not objective.canModifyTasks %}disabled{% endif %}
          class="inline-flex items-center gap-1.5 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 {% if not objective.canModifyTasks %}opacity-50 cursor-not-allowed{% endif %}"
        >
          <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.334 2.666a2.667 2.667 0 0 1 3.771 3.772l-8 8a2.667 2.667 0 0 1-1.886.781l-2.89.111a.667.667 0 0 1-.687-.687l.111-2.89a2.667 2.667 0 0 1 .78-1.886l8-8Zm2.39 2.39a1.333 1.333 0 0 0-1.886-1.886L10.667 4.61l1.886 1.886 1.171-1.44Z" fill=""/>
          </svg>
          Configurer
        </button>
        <button
          data-task-id="{{ task.id }}"
          data-task-proofs="{{ task.proofs|json_encode|e('html_attr') }}"
          data-task-title="{{ task.title|e('html_attr') }}"
          @click="showProofHistoryFromButton($event)"
          class="inline-flex items-center gap-1.5 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 1C4.134 1 1 4.134 1 8s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12.5c-3.032 0-5.5-2.468-5.5-5.5S4.968 2.5 8 2.5 13.5 4.968 13.5 8 11.032 13.5 8 13.5z" fill=""/>
            <path d="M8 4.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm0 6a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill=""/>
          </svg>
          Historique{% if task.proofs|length > 0 %} ({{ task.proofs|length }}){% endif %}
        </button>
        {% if objective.canModifyTasks and task.status != 'completed' %}
        <button
          data-task-id="{{ task.id }}"
          data-task-status="{{ task.status }}"
          @click="deleteTask({{ task.id }}, '{{ task.status }}')"
          class="inline-flex items-center gap-1.5 rounded-lg border border-red-200 bg-white px-3 py-1.5 text-sm font-medium text-red-600 shadow-theme-xs hover:bg-red-50 dark:border-red-800 dark:bg-gray-800 dark:text-red-400 dark:hover:bg-red-900/20"
        >
          <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M5.33333 2.66667V1.33333C5.33333 0.979711 5.47381 0.640573 5.72386 0.390524C5.97391 0.140476 6.31305 0 6.66667 0H9.33333C9.68696 0 10.0261 0.140476 10.2761 0.390524C10.5262 0.640573 10.6667 0.979711 10.6667 1.33333V2.66667H14.6667C15.0333 2.66667 15.3333 2.96667 15.3333 3.33333C15.3333 3.7 15.0333 4 14.6667 4H13.3333V14C13.3333 14.7072 12.7472 15.3333 12 15.3333H4C3.25281 15.3333 2.66667 14.7072 2.66667 14V4H1.33333C0.966667 4 0.666667 3.7 0.666667 3.33333C0.666667 2.96667 0.966667 2.66667 1.33333 2.66667H5.33333ZM6.66667 1.33333V2.66667H9.33333V1.33333H6.66667Z" fill="currentColor"/>
          </svg>
          Supprimer
        </button>
        {% endif %}
      </div>
    </div>
  </div>
{% endmacro %}

{% block content %}
<!-- ===== Main Content Start ===== -->
<main 
  x-data="taskManager()"
  data-students='{{ students|json_encode|e('html_attr') }}'
  data-parents='{{ parents|json_encode|e('html_attr') }}'
  data-specialists='{{ specialists|json_encode|e('html_attr') }}'
  data-objective='{{ objective|json_encode|e('html_attr') }}'
  data-regular-activities='{{ regularActivities|json_encode|e('html_attr') }}'
  data-school-activities='{{ schoolActivities|json_encode|e('html_attr') }}'
>
  <div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
    <!-- Breadcrumb Start -->
    <div x-data="{ pageName: 'D√©tail de l\'Objectif' }">
      <div class="flex flex-wrap items-center justify-between gap-3 pb-6">
        <h2
          class="text-xl font-semibold text-gray-800 dark:text-white/90"
          x-text="pageName"
        ></h2>
        <nav>
          <ol class="flex items-center gap-1.5">
            {% for breadcrumb in breadcrumbs %}
              <li>
                {% if breadcrumb.url %}
                  <a
                    class="inline-flex items-center gap-1.5 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                    href="{{ breadcrumb.url }}"
                  >
                    {{ breadcrumb.label }}
                    <svg
                      class="stroke-current"
                      width="17"
                      height="16"
                      viewBox="0 0 17 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M6.0765 12.667L10.2432 8.50033L6.0765 4.33366"
                        stroke=""
                        stroke-width="1.2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </a>
                {% else %}
                  <span class="text-sm text-gray-800 dark:text-white/90">{{ breadcrumb.label }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
        </nav>
      </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Objective Info Card -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mb-6">
      <div class="p-4 xl:p-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-2xl font-semibold text-gray-800 dark:text-white/90">
                {{ objective.title }}
              </h3>
              {% if app.user.isCoach() or (app.user.isParent() and objective.status not in ['validated', 'in_action', 'completed', 'paused']) %}
              <button
                @click="openObjectiveEdit()"
                class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-theme-xs transition-colors hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              >
                <svg class="fill-current" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M11.333 2.667a2.667 2.667 0 0 1 3.774 3.774l-8 8a2.667 2.667 0 0 1-1.886.78H2.667v-2.554a2.667 2.667 0 0 1 .78-1.886l8-8zm2.554 1.22L12.113 2.113a1.333 1.333 0 0 0-1.886 0L9.333 3.007l2.667 2.667 1.554-1.554a1.333 1.333 0 0 0 0-1.886z" fill=""/>
                </svg>
                Modifier
              </button>
              {% endif %}
            </div>
            <div class="flex flex-wrap items-center gap-3 mb-4">
              <span class="inline-flex rounded-full bg-brand-50 px-3 py-1 text-sm font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400">
                {{ objective.category }}
              </span>
              <div class="inline-flex items-center gap-2" x-data="{ 
                statusEditMode: false, 
                currentStatus: '{{ objective.status }}', 
                isUpdating: false,
                async updateStatus() {
                  if (this.isUpdating) return;
                  this.isUpdating = true;
                  
                  try {
                    const response = await fetch('/admin/objectives/{{ objective.id }}/update', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                      },
                      body: JSON.stringify({
                        status: this.currentStatus,
                      }),
                    });
                    
                    let result;
                    try {
                      result = await response.json();
                    } catch (e) {
                      result = { success: false, message: 'Erreur lors de la lecture de la r√©ponse' };
                    }
                    
                    if (response.ok && result.success) {
                      if (window.showToast) {
                        window.showToast('Statut mis √† jour avec succ√®s', 'success');
                      }
                      this.statusEditMode = false;
                      setTimeout(() => {
                        window.location.reload();
                      }, 500);
                    } else {
                      const errorMessage = result.message || 'Erreur lors de la mise √† jour du statut';
                      if (window.showToast) {
                        window.showToast(errorMessage, 'error');
                      } else {
                        alert(errorMessage);
                      }
                      this.isUpdating = false;
                    }
                  } catch (error) {
                    console.error('Erreur:', error);
                    const errorMessage = 'Une erreur est survenue lors de la mise √† jour du statut';
                    if (window.showToast) {
                      window.showToast(errorMessage, 'error');
                    } else {
                      alert(errorMessage);
                    }
                    this.isUpdating = false;
                  }
                }
              }">
                <template x-if="!statusEditMode">
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-medium
                    {% if objective.status == 'completed' %}bg-success-50 text-success-500 dark:bg-success-500/15 dark:text-success-400
                    {% elseif objective.status == 'in_action' %}bg-brand-50 text-brand-500 dark:bg-brand-500/15 dark:text-brand-400
                    {% elseif objective.status == 'validated' %}bg-blue-50 text-blue-500 dark:bg-blue-500/15 dark:text-blue-400
                    {% elseif objective.status == 'pending_validation' %}bg-warning-50 text-warning-500 dark:bg-warning-500/15 dark:text-warning-400
                    {% elseif objective.status == 'modification' %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80
                    {% elseif objective.status == 'paused' %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80
                    {% else %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80{% endif %}">
                    <span>{{ objective.statusLabel|default('Statut inconnu') }}</span>
                    {% if app.user.isCoach() %}
                    <button
                      @click="statusEditMode = true"
                      class="ml-1 rounded p-0.5 hover:bg-black/10 dark:hover:bg-white/10 transition-colors"
                      title="Modifier le statut"
                    >
                      <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                    </button>
                    {% endif %}
                  </span>
                </template>
                <template x-if="statusEditMode">
                  <div class="inline-flex items-center gap-2">
                    <select
                      x-model="currentStatus"
                      :disabled="isUpdating"
                      class="rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm font-medium text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90 disabled:opacity-50"
                    >
                      <option value="modification">En cours de Modification</option>
                      <option value="pending_validation">Attente de Validation par Coach</option>
                      <option value="validated">Valid√© par le coach</option>
                      <option value="in_action">En Action</option>
                      <option value="completed">Termin√©</option>
                      <option value="paused">En pause</option>
                    </select>
                    <button
                      @click="updateStatus()"
                      :disabled="isUpdating || currentStatus === '{{ objective.status }}'"
                      class="rounded-lg bg-brand-500 px-3 py-1 text-xs font-medium text-white hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <span x-show="!isUpdating">‚úì</span>
                      <span x-show="isUpdating">...</span>
                    </button>
                    <button
                      @click="statusEditMode = false; currentStatus = '{{ objective.status }}'"
                      :disabled="isUpdating"
                      class="rounded-lg border border-gray-200 bg-white px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 disabled:opacity-50"
                    >
                      ‚úï
                    </button>
                  </div>
                </template>
              </div>
            </div>
            
            <!-- Message de statut -->
            <div class="mb-4 rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-800 dark:bg-white/[0.02]">
              <div class="flex items-start gap-3">
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-sm text-gray-700 dark:text-gray-300">
                  {{ objective.statusMessage|default('') }}
                </p>
              </div>
            </div>
          </div>
          <a href="{{ path('admin_objectives_list') }}" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03]">
            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 16.7071C9.31658 17.0976 8.68342 17.0976 8.29289 16.7071L2.29289 10.7071C1.90237 10.3166 1.90237 9.68342 2.29289 9.29289L8.29289 3.29289C8.68342 2.90237 9.31658 2.90237 9.70711 3.29289C10.0976 3.68342 10.0976 4.31658 9.70711 4.70711L5.41421 9H17C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11H5.41421L9.70711 15.2929C10.0976 15.6834 10.0976 16.3166 9.70711 16.7071Z" fill=""/>
            </svg>
            Retour
          </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-50 dark:bg-brand-500/15">
              <svg class="fill-current text-brand-500 dark:text-brand-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM9 11V9H11V11H9ZM9 13V11H11V13H9Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">√âl√®ve</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.student.firstName }} {{ objective.student.lastName }}</p>
            </div>
          </div>
          {% if objective.createdAt %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-50 dark:bg-blue-500/15">
              <svg class="fill-current text-blue-500 dark:text-blue-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Date de d√©but</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.createdAt|date('d/m/Y') }}</p>
            </div>
          </div>
          {% endif %}
          {% if objective.deadline %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning-50 dark:bg-warning-500/15">
              <svg class="fill-current text-warning-500 dark:text-warning-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Date de fin</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.deadline|date('d/m/Y') }}</p>
            </div>
          </div>
          {% endif %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-success-50 dark:bg-success-500/15">
              <svg class="fill-current text-success-500 dark:text-success-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM13.7071 8.29289C14.0976 7.90237 14.0976 7.26921 13.7071 6.87868C13.3166 6.48816 12.6834 6.48816 12.2929 6.87868L9 10.1716L7.70711 8.87868C7.31658 8.48816 6.68342 8.48816 6.29289 8.87868C5.90237 9.26921 5.90237 9.90237 6.29289 10.2929L8.29289 12.2929C8.68342 12.6834 9.31658 12.6834 9.70711 12.2929L13.7071 8.29289Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Progression</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.progress }}%</p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progression</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">{{ objective.progress }}%</span>
          </div>
          <div class="h-2 bg-gray-200 rounded-full overflow-hidden dark:bg-gray-700">
            <div class="h-full bg-brand-500 transition-all duration-300" style="width: {{ objective.progress }}%"></div>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Description</h4>
            {% if app.user.isCoach() and objective.descriptionOrigin %}
            <button
              @click="generateFromOrigin()"
              :disabled="generatingFromOrigin"
              class="inline-flex items-center gap-2 rounded-lg border border-brand-500 bg-brand-50 px-3 py-1.5 text-xs font-medium text-brand-600 shadow-theme-xs hover:bg-brand-100 disabled:opacity-50 disabled:cursor-not-allowed dark:border-brand-400 dark:bg-brand-500/15 dark:text-brand-400 dark:hover:bg-brand-500/25"
              title="G√©n√©rer des t√¢ches et une description √† partir de la description originale"
            >
              <svg x-show="!generatingFromOrigin" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
              <svg x-show="generatingFromOrigin" class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span x-show="!generatingFromOrigin">G√©n√©rer depuis l'original</span>
              <span x-show="generatingFromOrigin">G√©n√©ration...</span>
            </button>
            {% endif %}
          </div>
          <p class="text-base text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{{ objective.description }}</p>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div
      class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
    >
      <!-- Task header Start -->
      <div class="flex flex-col items-center px-4 py-5 xl:px-6 xl:py-6">
        <div
          class="flex flex-col w-full gap-5 sm:justify-between xl:flex-row xl:items-center"
        >
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">T√¢ches</h3>
          <div class="flex flex-wrap items-center gap-3 xl:justify-end">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              Total: {{ tasks.pending|length + tasks.in_progress|length + tasks.completed|length }}
            </span>
            {% if canUseAI %}
            <button
              @click="openTaskCreate()"
              {% if not objective.canModifyTasks %}disabled{% endif %}
              class="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-white shadow-theme-xs transition-colors {% if objective.canModifyTasks %}bg-brand-500 hover:bg-brand-600{% else %}bg-gray-300 cursor-not-allowed dark:bg-gray-700{% endif %}"
              {% if not objective.canModifyTasks %}title="Impossible de cr√©er une t√¢che. {{ objective.statusMessage }}"{% endif %}
            >
              <svg class="fill-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 2.66667C8.36819 2.66667 8.66667 2.96514 8.66667 3.33333V7.33333H12.6667C13.0349 7.33333 13.3333 7.63181 13.3333 8C13.3333 8.36819 13.0349 8.66667 12.6667 8.66667H8.66667V12.6667C8.66667 13.0349 8.36819 13.3333 8 13.3333C7.63181 13.3333 7.33333 13.0349 7.33333 12.6667V8.66667H3.33333C2.96514 8.66667 2.66667 8.36819 2.66667 8C2.66667 7.63181 2.96514 7.33333 3.33333 7.33333H7.33333V3.33333C7.33333 2.96514 7.63181 2.66667 8 2.66667Z" fill=""/>
              </svg>
              Nouvelle t√¢che
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Task header End -->

      <!-- Task wrapper Start -->
      <div
        class="p-4 space-y-8 border-t border-gray-200 mt-7 dark:border-gray-800 sm:mt-0 xl:p-6"
      >
        <!-- To do list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              √Ä faire
              <span
                class="inline-flex rounded-full bg-gray-100 px-2 py-0.5 text-theme-xs font-medium text-gray-700 dark:bg-white/[0.03] dark:text-white/80"
              >
                {{ tasks.pending|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.pending %}
            {{ _self.renderTask(task, objective) }}
                  {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune t√¢che</p>
                      </div>
          {% endfor %}
                </div>

        <!-- Progress list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              En cours
                    <span
                class="inline-flex rounded-full bg-warning-50 px-2 py-0.5 text-theme-xs font-medium text-warning-700 dark:bg-warning-500/15 dark:text-orange-400"
              >
                {{ tasks.in_progress|length }}
                    </span>
            </h3>
                  </div>

          {% for task in tasks.in_progress %}
            {{ _self.renderTask(task, objective) }}
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune t√¢che</p>
          </div>
          {% endfor %}
        </div>

        <!-- Completed list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              Termin√©
              <span
                class="inline-flex rounded-full bg-success-50 px-2 py-0.5 text-theme-xs font-medium text-success-500 dark:bg-success-500/15 dark:text-success-400"
              >
                {{ tasks.completed|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.completed %}
            {{ _self.renderTask(task, objective) }}
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune t√¢che</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </main>

    <!-- Comments Section -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mt-6">
      <div class="p-4 xl:p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">Commentaires ({{ comments|length }})</h3>
          <button
            @click="openCommentCreate()"
            class="inline-flex items-center gap-2 rounded-lg bg-brand-500 px-3 py-1.5 text-xs font-medium text-white shadow-theme-xs hover:bg-brand-600"
          >
            <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none">
              <path d="M8 1a7 7 0 100 14A7 7 0 008 1zM7.5 4v4l3.5 2 .5-.866L8.5 7.5V4h-1z" fill=""/>
            </svg>
            Ajouter un commentaire
          </button>
        </div>
        
        <!-- Formulaire de cr√©ation/√©dition de commentaire -->
        <div x-show="commentFormOpen" x-cloak class="mb-4 p-4 bg-gray-50 rounded-lg dark:bg-white/[0.02] border border-gray-200 dark:border-gray-800">
          <form @submit.prevent="saveComment()" class="space-y-3">
            <div>
              <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-300">
                Commentaire <span class="text-error-500">*</span>
              </label>
              <textarea
                x-model="commentFormData.content"
                rows="3"
                required
                placeholder="√âcrivez votre commentaire..."
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              ></textarea>
            </div>
            <div class="flex gap-2">
              <button
                type="submit"
                :disabled="commentSubmitting"
                class="flex-1 rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50"
              >
                <span x-show="!commentSubmitting" x-text="commentEditMode ? 'Modifier' : 'Ajouter'"></span>
                <span x-show="commentSubmitting">En cours...</span>
              </button>
              <button
                type="button"
                @click="closeCommentForm()"
                class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              >
                Annuler
              </button>
            </div>
          </form>
        </div>
        
        <!-- Liste des commentaires -->
        <div class="space-y-4">
          {% for comment in comments %}
          <div class="rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-800 dark:text-white/90">
                  {{ comment.author.firstName }} {{ comment.author.lastName }}
                </span>
                <span class="text-xs text-gray-500 dark:text-gray-400">
                  {{ comment.createdAt|date('d/m/Y √† H:i') }}
                </span>
              </div>
              {% if app.user.id == comment.author.id %}
              <button
                @click="editComment({{ comment.id }}, '{{ comment.content|e('js') }}')"
                class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
              >
                Modifier
              </button>
              {% endif %}
            </div>
            <p class="text-sm text-gray-700 dark:text-gray-300">{{ comment.content }}</p>
          </div>
          {% else %}
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center">Aucun commentaire</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}

