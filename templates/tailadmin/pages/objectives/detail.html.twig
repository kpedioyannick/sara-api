{% extends 'tailadmin/layouts/base.html.twig' %}

{% block content %}
<script>
window.taskManager = function() {
  return {
    proofSheetOpen: false,
    rightSheetOpen: false,
    configSheetOpen: false,
    objectiveEditSheetOpen: false,
    shareSheetOpen: false,
    shareSheetContent: '',
    imageModalOpen: false,
    enlargedImageUrl: null,
    enlargedImageAlt: '',
    currentTaskId: null,
    currentTaskTitle: '',
    currentTaskStatus: null,
    currentTaskRequiresProof: true,
    currentTaskProofs: [],
    objectiveFormData: {
      title: '',
      description: '',
      category: '',
      status: 'modification',
      progress: 0,
      createdAt: '',
      deadline: '',
      studentId: '',
    },
    proofSubmitting: false,
    proofFormData: {
      type: 'photo',
      description: '',
      fileBase64: null,
      fileName: null,
      fileSize: null,
      mimeType: null,
      filePreview: null,
    },
    commentFormOpen: false,
    commentFormData: {
      content: '',
    },
    commentSubmitting: false,
    commentEditMode: false,
    commentEditId: null,
    configTaskTitle: '',
    configSubmitting: false,
    studentsData: [],
    parentsData: [],
    specialistsData: [],
    objective: null,
    regularActivities: [],
    schoolActivities: [],
    regularActivityChoicesInstance: null,
    schoolActivityChoicesInstance: null,
    taskFormHtml: '',
    taskFormLoading: false,
    workshopSpecialistsChoicesInstance: null,
    workshopStudentsChoicesInstance: null,
    workshopActivitiesChoicesInstance: null,
    studentsChoicesInstance: null,
    taskConfig: {
      isNew: false,
      type: 'task',
      title: '',
      description: '',
      status: 'pending',
      requiresProof: true,
      frequency: 'none',
      startDate: '',
      dueDate: '',
      repeatDaysOfWeek: [],
      assignedType: 'coach',
      studentId: '',
      parentId: '',
      specialistId: '',
      activityId: '',
      pathId: '',
      createdAt: '',
      location: '',
      familyId: '',
      assessmentNotes: '',
      requestId: '',
      specialistIds: [],
      studentIds: [],
      activityIds: [],
    },
    aiHelpSheetOpen: false,
    aiHelpDescription: '',
    updateObjectiveTitleAndDescription: false,
    isGeneratingAISuggestions: false,
    aiSuggestedTasks: [],
    aiSuggestedObjective: null,
    selectedAITaskIndices: [],
    objectiveId: {{ objective.id }},
    init() {
      // Écouter l'événement de fermeture depuis le rightsheet de partage
      this.$el.addEventListener('close-share-sheet', () => {
        this.closeShareSheet();
      });
      
      // Initialiser les données depuis les attributs data
      const studentsDataAttr = this.$el.getAttribute('data-students');
      const parentsDataAttr = this.$el.getAttribute('data-parents');
      const specialistsDataAttr = this.$el.getAttribute('data-specialists');
      const objectiveDataAttr = this.$el.getAttribute('data-objective');
      const regularActivitiesAttr = this.$el.getAttribute('data-regular-activities');
      const schoolActivitiesAttr = this.$el.getAttribute('data-school-activities');
      
      if (studentsDataAttr) {
        try {
          this.studentsData = JSON.parse(studentsDataAttr);
        } catch (e) {
          console.error('Erreur parsing studentsData:', e);
        }
      }
      
      if (parentsDataAttr) {
        try {
          this.parentsData = JSON.parse(parentsDataAttr);
        } catch (e) {
          console.error('Erreur parsing parentsData:', e);
        }
      }
      
      if (specialistsDataAttr) {
        try {
          this.specialistsData = JSON.parse(specialistsDataAttr);
        } catch (e) {
          console.error('Erreur parsing specialistsData:', e);
        }
      }
      
      if (objectiveDataAttr) {
        try {
          this.objective = JSON.parse(objectiveDataAttr);
          this.objectiveId = this.objective.id;
          this.aiHelpDescription = this.objective.description || '';
        } catch (e) {
          console.error('Erreur parsing objective:', e);
        }
      }
      
      if (regularActivitiesAttr) {
        try {
          this.regularActivities = JSON.parse(regularActivitiesAttr);
        } catch (e) {
          console.error('Erreur parsing regularActivities:', e);
        }
      }
      
      if (schoolActivitiesAttr) {
        try {
          this.schoolActivities = JSON.parse(schoolActivitiesAttr);
        } catch (e) {
          console.error('Erreur parsing schoolActivities:', e);
        }
      }
    },
    // ... autres méthodes seront ajoutées ci-dessous
  };
};
</script>
<!-- ===== Main Content Start ===== -->
<main 
  x-data="taskManager()"
  data-students='{{ students|json_encode|e('html_attr') }}'
  data-parents='{{ parents|json_encode|e('html_attr') }}'
  data-specialists='{{ specialists|json_encode|e('html_attr') }}'
  data-objective='{{ objective|json_encode|e('html_attr') }}'
  data-regular-activities='{{ regularActivities|json_encode|e('html_attr') }}'
  data-school-activities='{{ schoolActivities|json_encode|e('html_attr') }}'
>
  <div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
    <!-- Breadcrumb Start -->
    <div x-data="{ pageName: 'Détail de l\'Objectif' }">
      <div class="flex flex-wrap items-center justify-between gap-3 pb-6">
        <h2
          class="text-xl font-semibold text-gray-800 dark:text-white/90"
          x-text="pageName"
        ></h2>
        <nav>
          <ol class="flex items-center gap-1.5">
            {% for breadcrumb in breadcrumbs %}
              <li>
                {% if breadcrumb.url %}
                  <a
                    class="inline-flex items-center gap-1.5 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                    href="{{ breadcrumb.url }}"
                  >
                    {{ breadcrumb.label }}
                    <svg
                      class="stroke-current"
                      width="17"
                      height="16"
                      viewBox="0 0 17 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M6.0765 12.667L10.2432 8.50033L6.0765 4.33366"
                        stroke=""
                        stroke-width="1.2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </a>
                {% else %}
                  <span class="text-sm text-gray-800 dark:text-white/90">{{ breadcrumb.label }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
        </nav>
      </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Objective Info Card -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mb-6">
      <div class="p-4 xl:p-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-2xl font-semibold">
                <span class="inline-block rounded-lg bg-blue-100 dark:bg-blue-900/30 px-4 py-2 text-gray-800 dark:text-white/90">
                  {{ objective.title }}
                </span>
              </h3>
              {% if app.user.isCoach() or (app.user.isParent() and objective.status not in ['validated', 'in_action', 'completed', 'paused']) %}
              <div class="flex items-center gap-2">
                <button
                  @click="openAIHelpSheet()"
                  class="inline-flex items-center gap-1.5 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-600 shadow-theme-xs transition-colors hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700"
                  title="Aide IA pour générer des suggestions de tâches"
                >
                  <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                  </svg>
                  Aide IA
                </button>
              <button
                @click="openObjectiveEdit()"
                class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-theme-xs transition-colors hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              >
                <svg class="fill-current" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M11.333 2.667a2.667 2.667 0 0 1 3.774 3.774l-8 8a2.667 2.667 0 0 1-1.886.78H2.667v-2.554a2.667 2.667 0 0 1 .78-1.886l8-8zm2.554 1.22L12.113 2.113a1.333 1.333 0 0 0-1.886 0L9.333 3.007l2.667 2.667 1.554-1.554a1.333 1.333 0 0 0 0-1.886z" fill=""/>
                </svg>
                Modifier
              </button>
              {% if app.user.isCoach() %}
              <button
                @click="openShareSheet()"
                class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-theme-xs transition-colors hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              >
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                Partager
              </button>
              {% endif %}
              </div>
              {% endif %}
            </div>
            <div class="flex flex-wrap items-center gap-3 mb-4">
              <span class="inline-flex rounded-full bg-brand-50 px-3 py-1 text-sm font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400">
                {{ objective.category }}
              </span>
              <div class="inline-flex items-center gap-2" x-data="{ 
                statusEditMode: false, 
                currentStatus: '{{ objective.status }}', 
                isUpdating: false,
                async updateStatus() {
                  if (this.isUpdating) return;
                  this.isUpdating = true;
                  
                  try {
                    const response = await fetch('/admin/objectives/{{ objective.id }}/update', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                      },
                      body: JSON.stringify({
                        status: this.currentStatus,
                      }),
                    });
                    
                    let result;
                    try {
                      result = await response.json();
                    } catch (e) {
                      result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
                    }
                    
                    if (response.ok && result.success) {
                      if (window.showToast) {
                        window.showToast('Statut mis à jour avec succès', 'success');
                      }
                      this.statusEditMode = false;
                      setTimeout(() => {
                        window.location.reload();
                      }, 500);
                    } else {
                      const errorMessage = result.message || 'Erreur lors de la mise à jour du statut';
                      if (window.showToast) {
                        window.showToast(errorMessage, 'error');
                      } else {
                        alert(errorMessage);
                      }
                      this.isUpdating = false;
                    }
                  } catch (error) {
                    console.error('Erreur:', error);
                    const errorMessage = 'Une erreur est survenue lors de la mise à jour du statut';
                    if (window.showToast) {
                      window.showToast(errorMessage, 'error');
                    } else {
                      alert(errorMessage);
                    }
                    this.isUpdating = false;
                  }
                }
              }">
                <template x-if="!statusEditMode">
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-medium
                    {% if objective.status == 'completed' %}bg-success-50 text-success-500 dark:bg-success-500/15 dark:text-success-400
                    {% elseif objective.status == 'in_action' %}bg-brand-50 text-brand-500 dark:bg-brand-500/15 dark:text-brand-400
                    {% elseif objective.status == 'validated' %}bg-blue-50 text-blue-500 dark:bg-blue-500/15 dark:text-blue-400
                    {% elseif objective.status == 'pending_validation' %}bg-warning-50 text-warning-500 dark:bg-warning-500/15 dark:text-warning-400
                    {% elseif objective.status == 'modification' %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80
                    {% elseif objective.status == 'paused' %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80
                    {% else %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80{% endif %}">
                    <span>{{ objective.statusLabel|default('Statut inconnu') }}</span>
                    {% if app.user.isCoach() %}
                    <button
                      @click="statusEditMode = true"
                      class="ml-1 rounded p-0.5 hover:bg-black/10 dark:hover:bg-white/10 transition-colors"
                      title="Modifier le statut"
                    >
                      <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                    </button>
                    {% endif %}
                  </span>
                </template>
                <template x-if="statusEditMode">
                  <div class="inline-flex items-center gap-2">
                    <select
                      x-model="currentStatus"
                      :disabled="isUpdating"
                      class="rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm font-medium text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90 disabled:opacity-50"
                    >
                      <option value="modification">En cours de Modification</option>
                      <option value="pending_validation">Attente de Validation par Coach</option>
                      <option value="validated">Validé par le coach</option>
                      <option value="in_action">En Action</option>
                      <option value="completed">Terminé</option>
                      <option value="paused">En pause</option>
                    </select>
                    <button
                      @click="updateStatus()"
                      :disabled="isUpdating || currentStatus === '{{ objective.status }}'"
                      class="rounded-lg bg-brand-500 px-3 py-1 text-xs font-medium text-white hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <span x-show="!isUpdating">✓</span>
                      <span x-show="isUpdating">...</span>
                    </button>
                    <button
                      @click="statusEditMode = false; currentStatus = '{{ objective.status }}'"
                      :disabled="isUpdating"
                      class="rounded-lg border border-gray-200 bg-white px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 disabled:opacity-50"
                    >
                      ✕
                    </button>
                  </div>
                </template>
              </div>
            </div>
            
            <!-- Message de statut -->
            <div class="mb-4 rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-800 dark:bg-white/[0.02]">
              <div class="flex items-start gap-3">
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-sm text-gray-700 dark:text-gray-300">
                  {{ objective.statusMessage|default('') }}
                </p>
              </div>
            </div>
          </div>
          <a href="{{ path('admin_objectives_list') }}" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03]">
            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 16.7071C9.31658 17.0976 8.68342 17.0976 8.29289 16.7071L2.29289 10.7071C1.90237 10.3166 1.90237 9.68342 2.29289 9.29289L8.29289 3.29289C8.68342 2.90237 9.31658 2.90237 9.70711 3.29289C10.0976 3.68342 10.0976 4.31658 9.70711 4.70711L5.41421 9H17C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11H5.41421L9.70711 15.2929C10.0976 15.6834 10.0976 16.3166 9.70711 16.7071Z" fill=""/>
            </svg>
            Retour
          </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-50 dark:bg-brand-500/15">
              <svg class="fill-current text-brand-500 dark:text-brand-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM9 11V9H11V11H9ZM9 13V11H11V13H9Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Élève</p>
              <p class="text-base font-medium">
                <span class="inline-block rounded-md bg-purple-100 dark:bg-purple-900/30 px-2.5 py-0.5 text-purple-700 dark:text-purple-300">{{ objective.student.firstName }} {{ objective.student.lastName }}</span>
              </p>
            </div>
          </div>
          {% if objective.createdAt %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-50 dark:bg-blue-500/15">
              <svg class="fill-current text-blue-500 dark:text-blue-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Date de début</p>
              <p class="text-base font-medium">
                <span class="inline-block rounded-md bg-blue-100 dark:bg-blue-900/30 px-2.5 py-0.5 text-blue-700 dark:text-blue-300">{{ objective.createdAt|date('d/m/Y') }}</span>
              </p>
            </div>
          </div>
          {% endif %}
          {% if objective.deadline %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning-50 dark:bg-warning-500/15">
              <svg class="fill-current text-warning-500 dark:text-warning-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Date de fin</p>
              <p class="text-base font-medium">
                <span class="inline-block rounded-md bg-orange-100 dark:bg-orange-900/30 px-2.5 py-0.5 text-orange-700 dark:text-orange-300">{{ objective.deadline|date('d/m/Y') }}</span>
              </p>
            </div>
          </div>
          {% endif %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-success-50 dark:bg-success-500/15">
              <svg class="fill-current text-success-500 dark:text-success-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM13.7071 8.29289C14.0976 7.90237 14.0976 7.26921 13.7071 6.87868C13.3166 6.48816 12.6834 6.48816 12.2929 6.87868L9 10.1716L7.70711 8.87868C7.31658 8.48816 6.68342 8.48816 6.29289 8.87868C5.90237 9.26921 5.90237 9.90237 6.29289 10.2929L8.29289 12.2929C8.68342 12.6834 9.31658 12.6834 9.70711 12.2929L13.7071 8.29289Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Progression</p>
              <p class="text-base font-medium">
                <span class="inline-block rounded-md bg-green-100 dark:bg-green-900/30 px-2.5 py-0.5 text-green-700 dark:text-green-300">{{ objective.progress }}%</span>
              </p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progression</span>
            <span class="inline-block rounded-md bg-green-100 dark:bg-green-900/30 px-2.5 py-0.5 text-sm font-medium text-green-700 dark:text-green-300">{{ objective.progress }}%</span>
          </div>
          <div class="h-2 bg-gray-200 rounded-full overflow-hidden dark:bg-gray-700">
            <div class="h-full bg-brand-500 transition-all duration-300" style="width: {{ objective.progress }}%"></div>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Description</h4>
          </div>
          <p class="text-base whitespace-pre-wrap">
            <span class="inline-block rounded-lg bg-gray-100 dark:bg-gray-800 px-3 py-2 text-gray-700 dark:text-gray-300">{{ objective.description }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div
      class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
    >
      <!-- Task header Start -->
      <div class="flex flex-col items-center px-4 py-5 xl:px-6 xl:py-6">
        <div
          class="flex flex-col w-full gap-5 sm:justify-between xl:flex-row xl:items-center"
        >
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">Tâches</h3>
          <div class="flex flex-wrap items-center gap-3 xl:justify-end">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              Total: {{ tasks.pending|length + tasks.in_progress|length + tasks.completed|length }}
            </span>
            {% if canUseAI %}
            <button
              @click="openTaskCreate()"
              {% if not objective.canModifyTasks %}disabled{% endif %}
              class="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-white shadow-theme-xs transition-colors {% if objective.canModifyTasks %}bg-brand-500 hover:bg-brand-600{% else %}bg-gray-300 cursor-not-allowed dark:bg-gray-700{% endif %}"
              {% if not objective.canModifyTasks %}title="Impossible de créer une tâche. {{ objective.statusMessage }}"{% endif %}
            >
              <svg class="fill-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 2.66667C8.36819 2.66667 8.66667 2.96514 8.66667 3.33333V7.33333H12.6667C13.0349 7.33333 13.3333 7.63181 13.3333 8C13.3333 8.36819 13.0349 8.66667 12.6667 8.66667H8.66667V12.6667C8.66667 13.0349 8.36819 13.3333 8 13.3333C7.63181 13.3333 7.33333 13.0349 7.33333 12.6667V8.66667H3.33333C2.96514 8.66667 2.66667 8.36819 2.66667 8C2.66667 7.63181 2.96514 7.33333 3.33333 7.33333H7.33333V3.33333C7.33333 2.96514 7.63181 2.66667 8 2.66667Z" fill=""/>
              </svg>
              Nouvelle tâche
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Task header End -->

      <!-- Task wrapper Start -->
      <div
        class="p-4 space-y-8 border-t border-gray-200 mt-7 dark:border-gray-800 sm:mt-0 xl:p-6"
      >
        <!-- To do list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              À faire
              <span
                class="inline-flex rounded-full bg-gray-100 px-2 py-0.5 text-theme-xs font-medium text-gray-700 dark:bg-white/[0.03] dark:text-white/80"
              >
                {{ tasks.pending|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.pending %}
            {% include 'tailadmin/pages/objectives/_task_item.html.twig' with {'task': task, 'objective': objective} %}
                  {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune tâche</p>
                      </div>
          {% endfor %}
                </div>

        <!-- Progress list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              En cours
                    <span
                class="inline-flex rounded-full bg-warning-50 px-2 py-0.5 text-theme-xs font-medium text-warning-700 dark:bg-warning-500/15 dark:text-orange-400"
              >
                {{ tasks.in_progress|length }}
                    </span>
            </h3>
                  </div>

          {% for task in tasks.in_progress %}
            {% include 'tailadmin/pages/objectives/_task_item.html.twig' with {'task': task, 'objective': objective} %}
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune tâche</p>
          </div>
          {% endfor %}
        </div>

        <!-- Completed list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              Terminé
              <span
                class="inline-flex rounded-full bg-success-50 px-2 py-0.5 text-theme-xs font-medium text-success-500 dark:bg-success-500/15 dark:text-success-400"
              >
                {{ tasks.completed|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.completed %}
            {% include 'tailadmin/pages/objectives/_task_item.html.twig' with {'task': task, 'objective': objective} %}
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune tâche</p>
          </div>
          {% endfor %}
        </div>
      </div>
      <!-- Task wrapper End -->
    </div>

    <!-- Comments Section -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mt-6">
      <div class="p-4 xl:p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">Commentaires ({{ comments|length }})</h3>
          <button
            @click="openCommentCreate()"
            class="inline-flex items-center gap-2 rounded-lg bg-brand-500 px-3 py-1.5 text-xs font-medium text-white shadow-theme-xs hover:bg-brand-600"
          >
            <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none">
              <path d="M8 1a7 7 0 100 14A7 7 0 008 1zM7.5 4v4l3.5 2 .5-.866L8.5 7.5V4h-1z" fill=""/>
            </svg>
            Ajouter un commentaire
          </button>
        </div>
        
        <!-- Formulaire de création/édition de commentaire -->
        <div x-show="commentFormOpen" x-cloak class="mb-4 p-4 bg-gray-50 rounded-lg dark:bg-white/[0.02] border border-gray-200 dark:border-gray-800">
          <form @submit.prevent="saveComment()" class="space-y-3">
            <div>
              <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-300">
                Commentaire <span class="text-error-500">*</span>
              </label>
              <textarea
                x-model="commentFormData.content"
                rows="3"
                required
                placeholder="Écrivez votre commentaire..."
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              ></textarea>
            </div>
            <div class="flex gap-2">
              <button
                type="submit"
                :disabled="commentSubmitting"
                class="flex-1 rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50"
              >
                <span x-show="!commentSubmitting" x-text="commentEditMode ? 'Modifier' : 'Ajouter'"></span>
                <span x-show="commentSubmitting">En cours...</span>
              </button>
              <button
                type="button"
                @click="closeCommentForm()"
                class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              >
                Annuler
              </button>
            </div>
          </form>
        </div>
        
        <!-- Liste des commentaires -->
        {% if comments|length > 0 %}
        <div class="space-y-4">
          {% for comment in comments %}
          <div class="p-4 bg-gray-50 rounded-lg dark:bg-white/[0.02] border border-gray-200 dark:border-gray-800" data-comment-id="{{ comment.id }}">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <p class="text-sm font-medium text-gray-800 dark:text-white/90">
                  {% if comment.author %}
                  {{ comment.author.firstName }} {{ comment.author.lastName }}
                  {% else %}
                    Anonyme
                  {% endif %}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  {% if comment.createdAt %}
                    {{ comment.createdAt|date('d/m/Y \\à H:i') }}
                  {% endif %}
                </p>
              </div>
              <div class="flex items-center gap-2">
                {% if comment.author and comment.author.userType %}
                <span class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400">
                  {{ comment.author.userType|capitalize }}
                </span>
                {% endif %}
                {% if comment.author and (comment.author.userType == 'coach' or userType == 'coach') %}
                <button
                  @click="openCommentEdit({{ comment.id }}, '{{ comment.content|e('js') }}')"
                  class="inline-flex items-center gap-1 rounded-lg bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-200 dark:bg-white/[0.03] dark:text-white/80 dark:hover:bg-white/[0.05]"
                  title="Modifier"
                >
                  <svg class="fill-current" width="12" height="12" viewBox="0 0 16 16" fill="none">
                    <path d="M11.333 2.00004C11.5084 1.82467 11.7163 1.68607 11.9447 1.59233C12.1731 1.49859 12.4173 1.45178 12.6637 1.4549C12.91 1.45802 13.153 1.51102 13.3785 1.61042C13.6041 1.70982 13.8073 1.85368 13.9767 2.03307C14.1461 2.21246 14.278 2.42372 14.3649 2.65428C14.4518 2.88484 14.4917 3.12993 14.4822 3.37571C14.4727 3.62149 14.4139 3.86285 14.3092 4.08589C14.2045 4.30893 14.0562 4.50922 13.8733 4.67537L13.3333 5.21537L10.7847 2.66671L11.333 2.00004ZM9.78467 3.54837L2.33333 11H0.666667V9.33337L8.118 1.88204L9.78467 3.54837Z" fill="currentColor"/>
                  </svg>
                </button>
                <button
                  @click="deleteComment({{ comment.id }})"
                  class="inline-flex items-center gap-1 rounded-lg bg-error-50 px-2 py-1 text-xs font-medium text-error-600 hover:bg-error-100 dark:bg-error-900/30 dark:text-error-400 dark:hover:bg-error-900/50"
                  title="Supprimer"
                >
                  <svg class="fill-current" width="12" height="12" viewBox="0 0 16 16" fill="none">
                    <path d="M5.33333 2.66667V1.33333C5.33333 0.979711 5.47381 0.640573 5.72386 0.390524C5.97391 0.140476 6.31305 0 6.66667 0H9.33333C9.68696 0 10.0261 0.140476 10.2761 0.390524C10.5262 0.640573 10.6667 0.979711 10.6667 1.33333V2.66667H14.6667C15.0333 2.66667 15.3333 2.96667 15.3333 3.33333C15.3333 3.7 15.0333 4 14.6667 4H13.3333V14C13.3333 14.7072 12.7472 15.3333 12 15.3333H4C3.25281 15.3333 2.66667 14.7072 2.66667 14V4H1.33333C0.966667 4 0.666667 3.7 0.666667 3.33333C0.666667 2.96667 0.966667 2.66667 1.33333 2.66667H5.33333ZM6.66667 1.33333V2.66667H9.33333V1.33333H6.66667Z" fill="currentColor"/>
                  </svg>
                </button>
                {% endif %}
              </div>
            </div>
            <div x-show="!commentEditMode || currentCommentId !== {{ comment.id }}">
              <p class="text-base text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{{ comment.content }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
          <p class="text-sm text-gray-400 dark:text-gray-500">Aucun commentaire</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Sheet Overlay - Ajouter une preuve -->
  <div
    x-show="proofSheetOpen"
    @click="closeProofSheet()"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[100000] bg-black/50 backdrop-blur-sm"
    style="z-index: 100000;"
    x-cloak
  ></div>

  <!-- Right Sheet Panel - Ajouter une preuve -->
  <div
    x-show="proofSheetOpen"
    @click.away="closeProofSheet()"
    x-transition:enter="transition-transform ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition-transform ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    class="fixed right-0 top-0 h-full w-full max-w-md overflow-y-auto bg-white shadow-2xl dark:bg-gray-900"
    style="z-index: 100001;"
    x-cloak
  >
      <div class="flex h-full flex-col">
        <!-- Header -->
        <div class="sticky top-0 z-10 border-b border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
              Ajouter une preuve
            </h3>
            <button
              @click="closeProofSheet()"
              class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="currentTaskTitle"></p>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
          <div x-show="currentTaskStatus === 'completed'" class="mb-4 rounded-lg bg-red-50 border border-red-200 p-4 dark:bg-red-500/15 dark:border-red-500/30">
            <p class="text-sm text-red-600 dark:text-red-400">
              ⚠️ Impossible d'ajouter une preuve à une tâche terminée. Veuillez modifier le statut de la tâche pour pouvoir ajouter des preuves.
            </p>
          </div>
          <form @submit.prevent="submitProof()" class="space-y-4" x-bind:class="{ 'opacity-50 pointer-events-none': currentTaskStatus === 'completed' }">
            <!-- Description -->
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                Description
              </label>
              <textarea
                x-model="proofFormData.description"
                rows="3"
                placeholder="Description de la preuve"
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              ></textarea>
            </div>

            <!-- File Upload (Photo) -->
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                Prendre une photo <span x-show="currentTaskRequiresProof" class="text-error-500">*</span>
              </label>
              <input
                type="file"
                accept="image/*"
                @change="handleFileSelect($event)"
                :required="currentTaskRequiresProof"
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              />
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                Formats acceptés : JPG, PNG, GIF
                <span x-show="!currentTaskRequiresProof" class="block mt-1 text-gray-400 dark:text-gray-500">
                  (Optionnel - vous pouvez ajouter uniquement du texte)
                </span>
              </p>
              <div x-show="proofFormData.filePreview" class="mt-3">
                <img
                  :src="proofFormData.filePreview"
                  alt="Preview"
                  class="max-h-48 rounded-lg border border-gray-200 dark:border-gray-700"
                />
              </div>
            </div>

            <!-- Footer -->
            <div class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-800">
              <button
                type="button"
                @click="closeProofSheet()"
                class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              >
                Annuler
              </button>
              <button
                type="submit"
                :disabled="proofSubmitting"
                class="flex-1 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50"
              >
                <span x-show="!proofSubmitting">Envoyer une preuve</span>
                <span x-show="proofSubmitting">Envoi en cours...</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

  <!-- Right Sheet Overlay -->
  <div
    x-show="rightSheetOpen"
    @click="closeSheet()"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm"
    style="z-index: 100000;"
    x-cloak
  ></div>

  <!-- Right Sheet Panel - Historique des preuves -->
  <div
    x-show="rightSheetOpen"
    @click.away="closeSheet()"
    x-transition:enter="transition-transform ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition-transform ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    class="fixed right-0 top-0 h-full w-full max-w-md overflow-y-auto bg-white shadow-2xl dark:bg-gray-900"
    style="z-index: 100001;"
    x-cloak
  >
    <div class="flex h-full flex-col">
      <!-- Header -->
      <div class="sticky top-0 z-10 border-b border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
            Historique des preuves
          </h3>
          <button
            @click="closeSheet()"
            class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
          >
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="currentTaskTitle"></p>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-6">
        <template x-if="currentTaskProofs.length === 0">
          <div class="text-center py-8">
            <p class="text-gray-500 dark:text-gray-400">Aucune preuve enregistrée</p>
          </div>
        </template>
        
        <div class="space-y-4" x-show="currentTaskProofs.length > 0">
          <template x-for="(proof, index) in currentTaskProofs" :key="index">
            <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-800 dark:bg-white/[0.02]">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <h4 class="text-base font-semibold text-gray-800 dark:text-white/90" x-text="proof.title"></h4>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="formatDate(proof.createdAt)"></p>
                </div>
                <span class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400" x-text="proof.type"></span>
              </div>
              
              <template x-if="proof.description">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="proof.description"></p>
              </template>
              
              <template x-if="proof.type === 'text' && proof.content">
                <div class="bg-white rounded-lg p-3 mb-3 dark:bg-gray-800">
                  <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="proof.content"></p>
                </div>
              </template>
              
              <template x-if="(proof.type === 'photo' || proof.type === 'image') && proof.fileUrl">
                <div class="mb-3">
                  <img
                    :src="proof.fileUrl"
                    :alt="proof.fileName || 'Preuve'"
                    @click="openImageModal(proof.fileUrl, proof.fileName || 'Preuve')"
                    class="max-w-full h-auto rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer hover:opacity-90 transition-opacity"
                    @error="$el.src = '/tailadmin/src/images/default-image.png'"
                  />
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="proof.fileName"></p>
                  <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Cliquez sur l'image pour l'agrandir</p>
                </div>
              </template>
              
              <template x-if="proof.submittedBy">
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  Soumis par : <span x-text="proof.submittedBy.firstName + ' ' + proof.submittedBy.lastName"></span>
                </p>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
    </div>

  <!-- Right Sheet Overlay - Configuration -->
  <div
    x-show="configSheetOpen"
    @click="closeConfigSheet()"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm"
    style="z-index: 100000;"
    x-cloak
  ></div>

  <!-- Right Sheet Panel - Configuration de la tâche -->
  <div
    x-show="configSheetOpen"
    @click.away="closeConfigSheet()"
    x-transition:enter="transition-transform ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition-transform ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    class="fixed right-0 top-0 h-full w-full max-w-md overflow-y-auto bg-white shadow-2xl dark:bg-gray-900"
    style="z-index: 100001;"
    x-cloak
  >
    <div class="flex h-full flex-col">
      <!-- Header -->
      <div class="sticky top-0 z-10 border-b border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
            <span x-show="!taskConfig.isNew">Configuration de la tâche</span>
            <span x-show="taskConfig.isNew">Nouvelle tâche</span>
          </h3>
          <button
            @click="closeConfigSheet()"
            class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
          >
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-show="!taskConfig.isNew" x-text="configTaskTitle"></p>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-6" x-show="taskConfig">
        <!-- Type de tâche -->
        <div class="mb-6">
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Type <span class="text-error-500">*</span>
          </label>
          <select
            x-model="taskConfig.type"
            @change="onTaskTypeChange()"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          >
            <option value="task">Tâche</option>
            <option value="activity_task">Tâche activité</option>
            <option value="school_activity_task">Tâche activité scolaire</option>
            <option value="workshop">Atelier</option>
            <option value="assessment">Bilan</option>
            <option value="individual_work">Travail individuel</option>
            <option value="individual_work_remote">Travail individuel à distance</option>
            <option value="individual_work_on_site">Travail individuel dans un lieu</option>
          </select>
        </div>

        <!-- Conteneur pour le formulaire chargé dynamiquement -->
        <div>
          <div x-show="taskFormLoading" class="flex items-center justify-center py-8">
            <div class="text-gray-500 dark:text-gray-400">Chargement du formulaire...</div>
          </div>
          <div id="task-form-container" x-show="!taskFormLoading" x-html="taskFormHtml"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour agrandir l'image -->
  <div
    x-show="imageModalOpen"
    @click="closeImageModal()"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4"
    style="z-index: 100002;"
    @keydown.escape.window="closeImageModal()"
    x-cloak
  >
      <div
        class="relative max-w-7xl max-h-full w-full h-full flex items-center justify-center"
      >
        <!-- Bouton fermer -->
        <button
          @click.stop="closeImageModal()"
          class="absolute top-4 right-4 z-10 rounded-full bg-black/50 p-3 text-white hover:bg-black/70 transition-colors"
          title="Fermer (Échap)"
        >
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        
        <!-- Image agrandie - cliquable pour réduire -->
        <img
          x-show="enlargedImageUrl"
          :src="enlargedImageUrl"
          :alt="enlargedImageAlt"
          class="max-w-full max-h-full object-contain rounded-lg shadow-2xl cursor-pointer hover:opacity-90 transition-opacity"
          @click.stop="closeImageModal()"
          title="Cliquez pour réduire"
        />
        
        <!-- Titre de l'image -->
        <div
          x-show="enlargedImageAlt"
          class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-lg text-sm pointer-events-none"
        >
          <p x-text="enlargedImageAlt"></p>
        </div>
      </div>
    </div>

    <!-- Right Sheet Overlay - Modification Objectif -->
    <div
      x-show="objectiveEditSheetOpen"
      @click="closeObjectiveEditSheet()"
      x-transition:enter="transition-opacity ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition-opacity ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm"
      style="display: none;"
    ></div>

    <!-- Right Sheet Panel - Modification Objectif -->
    <div
      x-show="objectiveEditSheetOpen"
      @click.away="closeObjectiveEditSheet()"
      x-transition:enter="transition-transform ease-out duration-300"
      x-transition:enter-start="translate-x-full"
      x-transition:enter-end="translate-x-0"
      x-transition:leave="transition-transform ease-in duration-200"
      x-transition:leave-start="translate-x-0"
      x-transition:leave-end="translate-x-full"
      class="fixed right-0 top-0 z-50 h-full w-full max-w-md overflow-y-auto bg-white shadow-2xl dark:bg-gray-900"
      style="display: none;"
    >
      <div class="flex h-full flex-col">
        <!-- Header -->
        <div class="sticky top-0 z-10 border-b border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
              Modifier Objectif
            </h3>
            <button
              @click="closeObjectiveEditSheet()"
              class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="flex-1 p-6">
          <form @submit.prevent="saveObjective()" class="space-y-6">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Titre *</label>
              <input
                type="text"
                x-model="objectiveFormData.title"
                required
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              />
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Description *</label>
              <textarea
                x-model="objectiveFormData.description"
                required
                rows="4"
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              ></textarea>
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Catégorie *</label>
              <select
                x-model="objectiveFormData.category"
                required
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              >
                <option value="">Sélectionner...</option>
                <option value="academic">Académique</option>
                <option value="Comportement">Comportement</option>
                <option value="Autonomie">Autonomie</option>
                <option value="Social">Social</option>
                <option value="Émotionnel">Émotionnel</option>
              </select>
            </div>
            {% if app.user.isCoach() %}
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Statut *</label>
              <select
                x-model="objectiveFormData.status"
                required
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              >
                <option value="modification">En cours de Modification</option>
                <option value="pending_validation">Attente de Validation par Coach</option>
                <option value="validated">Validé par le coach</option>
                <option value="in_action">En Action</option>
                <option value="completed">Terminé</option>
                <option value="paused">En pause</option>
              </select>
            </div>
              {% endif %}
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Progression (%)</label>
              <input
                type="number"
                x-model="objectiveFormData.progress"
                min="0"
                max="100"
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              />
            </div>
            <!-- Dates -->
            <div class="grid grid-cols-2 gap-4">
              <!-- Date de début -->
              <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Date de début</label>
                <input
                  type="date"
                  x-model="objectiveFormData.createdAt"
                  class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                />
          </div>
              <!-- Date de fin -->
              <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Date de fin</label>
                <input
                  type="date"
                  x-model="objectiveFormData.deadline"
                  class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                />
        </div>
      </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Élève *</label>
              <select
                x-model="objectiveFormData.studentId"
                required
                class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
              >
                <option value="">Sélectionner un élève...</option>
                <template x-for="student in studentsData" :key="student.id">
                  <option :value="student.id" x-text="student.firstName + ' ' + student.lastName"></option>
                </template>
              </select>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="sticky bottom-0 border-t border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
          <div class="flex gap-3">
            <button
              @click="closeObjectiveEditSheet()"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
            >
              Annuler
            </button>
            <button
              @click="saveObjective()"
              class="flex-1 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600"
            >
              Enregistrer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sheet Overlay - Partage -->
    <div
      x-show="shareSheetOpen"
      @click="closeShareSheet()"
      x-transition:enter="transition-opacity ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition-opacity ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm"
      style="display: none;"
      x-cloak
    ></div>

    <!-- Right Sheet Panel - Partage -->
    <div
      x-show="shareSheetOpen"
      @click.away="closeShareSheet()"
      x-transition:enter="transition-transform ease-out duration-300"
      x-transition:enter-start="translate-x-full"
      x-transition:enter-end="translate-x-0"
      x-transition:leave="transition-transform ease-in duration-200"
      x-transition:leave-start="translate-x-0"
      x-transition:leave-end="translate-x-full"
      class="fixed right-0 top-0 z-50 h-full w-full max-w-md overflow-y-auto bg-white shadow-2xl dark:bg-gray-900"
      style="display: none;"
      x-cloak
    >
      <div x-html="shareSheetContent"></div>
    </div>

  <!-- AI Help Right Sheet -->
  <div
    x-show="aiHelpSheetOpen"
    @click="aiHelpSheetOpen = false"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[70] bg-black/50 backdrop-blur-sm"
    style="display: none;"
  ></div>

  <div
    x-show="aiHelpSheetOpen"
    @click.away="handleAIClickAway($event)"
    @click.stop
    x-transition:enter="transition-transform ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition-transform ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    class="fixed right-0 top-0 z-[70] h-full w-full max-w-2xl overflow-y-auto bg-white shadow-2xl dark:bg-gray-900"
    style="display: none;"
  >
    <div class="flex h-full flex-col" @click.stop>
      <div class="sticky top-0 z-10 border-b border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">Aide IA - Suggestions de tâches</h3>
          <div class="flex items-center gap-2">
            <button
              @click.stop="clearAIHistory()"
              class="rounded-lg p-2 text-xs text-gray-500 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
              title="Réinitialiser les suggestions"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
            <button
              @click="aiHelpSheetOpen = false"
              class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-6">
        <div class="space-y-6">
          <!-- Description -->
          <div>
            <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Description *</label>
            <textarea
              x-model="aiHelpDescription"
              required
              rows="6"
              placeholder="Décrivez l'objectif à atteindre..."
              @click.stop
              class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
            ></textarea>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Modifiez la description si nécessaire, puis cliquez sur "Générer les suggestions" pour voir les tâches proposées.
            </p>
          </div>

          <!-- Checkbox pour proposer une révision du titre et description -->
          <div class="flex items-start gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-800/50" @click.stop>
            <input
              type="checkbox"
              id="ai-update-objective"
              x-model="updateObjectiveTitleAndDescription"
              @click.stop
              class="mt-0.5 rounded border-gray-300 text-brand-600 focus:ring-brand-500"
            />
            <label for="ai-update-objective" class="flex-1 cursor-pointer text-sm text-gray-700 dark:text-gray-300" @click.stop>
              Proposer une révision du titre et de la description de l'objectif
            </label>
          </div>

          <!-- Bouton pour générer les suggestions -->
          <div>
            <button
              type="button"
              @click.stop="generateAISuggestions()"
              :disabled="!aiHelpDescription || !objective?.student?.id || isGeneratingAISuggestions"
              class="w-full rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span x-show="!isGeneratingAISuggestions">Générer les suggestions</span>
              <span x-show="isGeneratingAISuggestions">Génération en cours...</span>
            </button>
          </div>

          <!-- Affichage des propositions de titre et description -->
          <div x-show="aiSuggestedObjective" class="space-y-4 rounded-lg border border-brand-200 bg-brand-50 p-4 dark:border-brand-800 dark:bg-brand-500/10">
            <div>
              <label class="mb-2 block text-sm font-semibold text-brand-700 dark:text-brand-400">
                Propositions pour l'objectif
              </label>
              
              <div x-show="!updateObjectiveTitleAndDescription" class="mb-3 rounded-lg border border-brand-300 bg-brand-100 p-2 dark:border-brand-700 dark:bg-brand-500/20">
                <p class="text-xs text-brand-700 dark:text-brand-300">
                  💡 Cochez la case ci-dessus pour appliquer ces propositions lors de l'ajout des tâches
                </p>
              </div>
              
              <!-- Titre proposé -->
              <div class="mb-4">
                <label class="mb-1 block text-xs font-medium text-gray-600 dark:text-gray-400">Titre proposé</label>
                <div class="rounded-lg border border-gray-200 bg-white p-3 dark:border-gray-700 dark:bg-gray-800">
                  <p class="text-sm font-medium text-gray-800 dark:text-white" x-text="aiSuggestedObjective && aiSuggestedObjective.title ? aiSuggestedObjective.title : 'Aucun titre proposé'"></p>
                </div>
              </div>

              <!-- Description proposée -->
              <div>
                <label class="mb-1 block text-xs font-medium text-gray-600 dark:text-gray-400">Description proposée</label>
                <div class="rounded-lg border border-gray-200 bg-white p-3 dark:border-gray-700 dark:bg-gray-800">
                  <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="aiSuggestedObjective && aiSuggestedObjective.description ? aiSuggestedObjective.description : 'Aucune description proposée'"></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Affichage des tâches proposées -->
          <div x-show="aiSuggestedTasks && aiSuggestedTasks.length > 0" class="space-y-4">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                Tâches proposées (<span x-text="selectedAITasksCount"></span> sélectionnée(s))
              </label>
              <div class="max-h-96 space-y-2 overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-800/50">
                <template x-for="(task, index) in aiSuggestedTasks" :key="index">
                  <div class="flex items-start gap-3 rounded-lg border border-gray-200 bg-white p-3 dark:border-gray-700 dark:bg-gray-800" @click.stop>
                    <input
                      type="checkbox"
                      :id="'ai-task-' + index"
                      :value="index"
                      x-model="selectedAITaskIndices"
                      @click.stop
                      class="mt-1 rounded border-gray-300 text-brand-600 focus:ring-brand-500"
                    />
                    <label :for="'ai-task-' + index" class="flex-1 cursor-pointer" @click.stop>
                      <div class="font-medium text-gray-800 dark:text-white" x-text="task.title"></div>
                      <div class="mt-1 text-sm text-gray-600 dark:text-gray-400" x-text="task.description"></div>
                      <div class="mt-2 flex gap-2 text-xs text-gray-500 dark:text-gray-500">
                        <span x-show="task.frequency && task.frequency !== 'none'" x-text="'Fréquence: ' + task.frequency"></span>
                        <span x-show="task.proofType" x-text="'Preuve: ' + task.proofType"></span>
                      </div>
                    </label>
                  </div>
                </template>
              </div>
            </div>

            <!-- Bouton pour ajouter les tâches sélectionnées -->
            <div>
              <button
                type="button"
                @click.stop="addSelectedTasksToObjective()"
                :disabled="!selectedAITaskIndices || selectedAITaskIndices.length === 0"
                class="w-full rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Ajouter les tâches sélectionnées à l'objectif
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<!-- ===== Main Content End ===== -->

<style>
  [x-cloak] { display: none !important; }
</style>

<script>
window.taskManager = function() {
  return {
    proofSheetOpen: false,
    rightSheetOpen: false,
    configSheetOpen: false,
    objectiveEditSheetOpen: false,
    shareSheetOpen: false,
    shareSheetContent: '',
    imageModalOpen: false,
    enlargedImageUrl: null,
    enlargedImageAlt: '',
    currentTaskId: null,
    currentTaskTitle: '',
    currentTaskStatus: null,
    currentTaskRequiresProof: true,
    currentTaskProofs: [],
    objectiveFormData: {
      title: '',
      description: '',
      category: '',
      status: 'modification',
      progress: 0,
      createdAt: '',
      deadline: '',
      studentId: '',
    },
    proofSubmitting: false,
    proofFormData: {
      type: 'photo',
      description: '',
      fileBase64: null,
      fileName: null,
      fileSize: null,
      mimeType: null,
      filePreview: null,
    },
    configSubmitting: false,
    configTaskTitle: '',
    students: [],
    parents: [],
    specialists: [],
    regularActivities: [],
    schoolActivities: [],
    regularActivityChoicesInstance: null,
    schoolActivityChoicesInstance: null,
    taskFormHtml: '', // HTML du formulaire chargé via AJAX
    taskFormLoading: false,
    // Instances Choices.js pour les nouveaux types
    workshopSpecialistsChoicesInstance: null,
    workshopStudentsChoicesInstance: null,
    workshopActivitiesChoicesInstance: null,
    studentsChoicesInstance: null,
    taskConfig: {
      isNew: false,
      type: 'task',
      title: '',
      description: '',
      status: 'pending',
      requiresProof: true,
      frequency: 'none',
      assignedType: 'coach',
      studentId: '',
      parentId: '',
      specialistId: '',
      activityId: '',
      pathId: '',
    },
    commentFormOpen: false,
    commentEditMode: false,
    currentCommentId: null,
    commentSubmitting: false,
    commentFormData: {
      content: '',
    },
    objectiveId: {{ objective.id }},
    objective: null,
    studentsData: [],
    canUseAI: {{ canUseAI ? 'true' : 'false' }},
    aiHelpSheetOpen: false,
    aiHelpDescription: '',
    isGeneratingAISuggestions: false,
    aiSuggestedTasks: [],
    selectedAITaskIndices: [],
    updateObjectiveTitleAndDescription: false,
    aiSuggestedObjective: null,
    
    init() {
      const studentsJson = this.$el.getAttribute('data-students');
      const parentsJson = this.$el.getAttribute('data-parents');
      const specialistsJson = this.$el.getAttribute('data-specialists');
      const objectiveJson = this.$el.getAttribute('data-objective');
      const regularActivitiesJson = this.$el.getAttribute('data-regular-activities');
      const schoolActivitiesJson = this.$el.getAttribute('data-school-activities');
      
      if (studentsJson) {
        this.students = JSON.parse(studentsJson);
        this.studentsData = JSON.parse(studentsJson);
      }
      if (parentsJson) {
        this.parents = JSON.parse(parentsJson);
      }
      if (specialistsJson) {
        this.specialists = JSON.parse(specialistsJson);
      }
      if (objectiveJson) {
        this.objective = JSON.parse(objectiveJson);
      }
      if (regularActivitiesJson) {
        this.regularActivities = JSON.parse(regularActivitiesJson);
      }
      if (schoolActivitiesJson) {
        this.schoolActivities = JSON.parse(schoolActivitiesJson);
      }
    },
    initActivityChoices() {
      // Charger Choices.js si pas déjà chargé
      if (typeof Choices === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js';
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css';
        document.head.appendChild(link);
        script.onload = () => {
          this.$nextTick(() => {
            this.initActivityChoices();
          });
        };
        document.head.appendChild(script);
        return;
      }
      
      // Attendre que le sheet soit visible dans le DOM
      this.$nextTick(() => {
        // Détruire les instances existantes si elles existent
        if (this.regularActivityChoicesInstance) {
          try {
            this.regularActivityChoicesInstance.destroy();
          } catch (e) {
            console.warn('Erreur lors de la destruction de ChoiceJS (activités):', e);
          }
          this.regularActivityChoicesInstance = null;
        }
        
        if (this.schoolActivityChoicesInstance) {
          try {
            this.schoolActivityChoicesInstance.destroy();
          } catch (e) {
            console.warn('Erreur lors de la destruction de ChoiceJS (activités scolaires):', e);
          }
          this.schoolActivityChoicesInstance = null;
        }
        
        // Initialiser ChoiceJS sur le select des activités normales
        const regularActivitySelect = document.getElementById('regular-activity-select');
        if (regularActivitySelect && this.regularActivities && this.regularActivities.length > 0) {
          try {
            this.regularActivityChoicesInstance = new Choices(regularActivitySelect, {
              searchEnabled: true,
              searchChoices: true,
              searchFields: ['label', 'value'],
              placeholder: true,
              placeholderValue: 'Sélectionner une activité',
              shouldSort: false,
              itemSelectText: '',
            });
            
            // Synchroniser avec Alpine.js
            this.regularActivityChoicesInstance.passedElement.element.addEventListener('change', () => {
              const value = this.regularActivityChoicesInstance.getValue(true);
              this.taskConfig.activityId = value || '';
              // Réinitialiser l'autre select si une valeur est sélectionnée
              if (value && this.schoolActivityChoicesInstance) {
                this.schoolActivityChoicesInstance.setChoiceByValue('');
              }
            });
          } catch (e) {
            console.error('Erreur lors de l\'initialisation de ChoiceJS (activités):', e);
          }
        }
        
        // Initialiser ChoiceJS sur le select des activités scolaires
        const schoolActivitySelect = document.getElementById('school-activity-select');
        if (schoolActivitySelect && this.schoolActivities && this.schoolActivities.length > 0) {
          try {
            this.schoolActivityChoicesInstance = new Choices(schoolActivitySelect, {
              searchEnabled: true,
              searchChoices: true,
              searchFields: ['label', 'value'],
              placeholder: true,
              placeholderValue: 'Sélectionner une activité scolaire',
              shouldSort: false,
              itemSelectText: '',
            });
            
            // Synchroniser avec Alpine.js
            this.schoolActivityChoicesInstance.passedElement.element.addEventListener('change', () => {
              const value = this.schoolActivityChoicesInstance.getValue(true);
              this.taskConfig.activityId = value || '';
              // Réinitialiser l'autre select si une valeur est sélectionnée
              if (value && this.regularActivityChoicesInstance) {
                this.regularActivityChoicesInstance.setChoiceByValue('');
              }
            });
          } catch (e) {
            console.error('Erreur lors de l\'initialisation de ChoiceJS (activités scolaires):', e);
          }
        }
        
        // Mettre à jour les valeurs si elles sont déjà définies
        if (this.taskConfig.activityId) {
          setTimeout(() => {
            try {
              // Vérifier si c'est une activité normale ou scolaire
              const isRegular = this.regularActivities.some(a => a.id == this.taskConfig.activityId);
              const isSchool = this.schoolActivities.some(a => a.id == this.taskConfig.activityId);
              
              if (isRegular && this.regularActivityChoicesInstance) {
                this.regularActivityChoicesInstance.setChoiceByValue(String(this.taskConfig.activityId));
              } else if (isSchool && this.schoolActivityChoicesInstance) {
                this.schoolActivityChoicesInstance.setChoiceByValue(String(this.taskConfig.activityId));
              }
            } catch (e) {
              console.warn('Erreur lors de la mise à jour initiale de ChoiceJS:', e);
            }
          }, 50);
        }
      });
    },
    openObjectiveEdit() {
      // Remplir le formulaire avec les données de l'objectif actuel
      this.objectiveFormData = {
        title: this.objective?.title || '',
        description: this.objective?.description || '',
        category: this.objective?.category || '',
        status: this.objective?.status || 'modification',
        progress: this.objective?.progress || 0,
        createdAt: this.objective?.createdAt || '',
        deadline: this.objective?.deadline || '',
        studentId: this.objective?.student?.id || '',
      };
      this.objectiveEditSheetOpen = true;
    },
    closeObjectiveEditSheet() {
      this.objectiveEditSheetOpen = false;
    },
    async openShareSheet() {
      // Fermer les autres rightSheets
      this.objectiveEditSheetOpen = false;
      this.rightSheetOpen = false;
      this.proofSheetOpen = false;
      
      // Charger le contenu du rightsheet de partage via AJAX
      try {
        const response = await fetch(`/admin/objectives/{{ objective.id }}/share-sheet`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        
        if (response.ok) {
          const html = await response.text();
          
          // Extraire et exécuter les scripts AVANT d'injecter le HTML
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          const scripts = tempDiv.querySelectorAll('script');
          const htmlWithoutScripts = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
          
          // Exécuter les scripts de manière synchrone
          scripts.forEach(script => {
            if (script.src) {
              // Pour les scripts externes, créer un élément script
              const newScript = document.createElement('script');
              newScript.src = script.src;
              document.head.appendChild(newScript);
            } else {
              // Pour les scripts inline, utiliser eval() pour exécution synchrone
              try {
                eval(script.textContent);
              } catch (e) {
                console.error('Erreur lors de l\'exécution du script:', e);
              }
            }
          });
          
          // Maintenant injecter le HTML (sans les scripts) et initialiser Alpine.js
          this.shareSheetContent = htmlWithoutScripts;
          this.shareSheetOpen = true;
          
          // Attendre que la fonction shareManager soit disponible et initialiser Alpine.js
          await this.$nextTick();
          setTimeout(() => {
            // Vérifier que shareManager est disponible
            if (typeof window.shareManager === 'undefined') {
              console.error('shareManager n\'est pas défini');
              return;
            }
            
            const container = document.querySelector('[x-show="shareSheetOpen"]');
            if (container && typeof Alpine !== 'undefined') {
              Alpine.initTree(container);
            }
          }, 100);
        } else {
          console.error('Erreur lors du chargement du rightsheet de partage');
          alert('Erreur lors du chargement du formulaire de partage');
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion');
      }
    },
    closeShareSheet() {
      this.shareSheetOpen = false;
      this.shareSheetContent = '';
    },
    init() {
      // Écouter l'événement de fermeture depuis le rightsheet de partage
      this.$el.addEventListener('close-share-sheet', () => {
        this.closeShareSheet();
      });
      
      // Écouter l'événement de mise à jour du contenu du rightsheet de partage
      document.addEventListener('update-share-sheet', (event) => {
        this.shareSheetContent = event.detail.html;
        this.$nextTick(() => {
          const container = document.querySelector('[x-show="shareSheetOpen"]');
          if (container && typeof Alpine !== 'undefined') {
            Alpine.initTree(container);
          }
        });
      });
      
      // Initialiser les données depuis les attributs data
      const studentsDataAttr = this.$el.getAttribute('data-students');
      const parentsDataAttr = this.$el.getAttribute('data-parents');
      const specialistsDataAttr = this.$el.getAttribute('data-specialists');
      const objectiveDataAttr = this.$el.getAttribute('data-objective');
      const regularActivitiesAttr = this.$el.getAttribute('data-regular-activities');
      const schoolActivitiesAttr = this.$el.getAttribute('data-school-activities');
      
      if (studentsDataAttr) {
        try {
          this.studentsData = JSON.parse(studentsDataAttr);
        } catch (e) {
          console.error('Erreur parsing studentsData:', e);
        }
      }
      
      if (parentsDataAttr) {
        try {
          this.parentsData = JSON.parse(parentsDataAttr);
        } catch (e) {
          console.error('Erreur parsing parentsData:', e);
        }
      }
      
      if (specialistsDataAttr) {
        try {
          this.specialistsData = JSON.parse(specialistsDataAttr);
        } catch (e) {
          console.error('Erreur parsing specialistsData:', e);
        }
      }
      
      if (objectiveDataAttr) {
        try {
          this.objective = JSON.parse(objectiveDataAttr);
          this.objectiveId = this.objective.id;
          this.aiHelpDescription = this.objective.description || '';
        } catch (e) {
          console.error('Erreur parsing objective:', e);
        }
      }
      
      if (regularActivitiesAttr) {
        try {
          this.regularActivities = JSON.parse(regularActivitiesAttr);
        } catch (e) {
          console.error('Erreur parsing regularActivities:', e);
        }
      }
      
      if (schoolActivitiesAttr) {
        try {
          this.schoolActivities = JSON.parse(schoolActivitiesAttr);
        } catch (e) {
          console.error('Erreur parsing schoolActivities:', e);
        }
      }
    },
    async saveObjective() {
      try {
        const response = await fetch(`/admin/objectives/${this.objectiveId}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify(this.objectiveFormData),
        });
        
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
        }
        
        if (response.ok && result.success) {
          if (window.showToast) {
            window.showToast('Objectif mis à jour avec succès', 'success');
          } else {
            alert('Objectif mis à jour avec succès');
          }
          this.closeObjectiveEditSheet();
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          const errorMessage = result.message || 'Erreur lors de la mise à jour';
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
        }
      } catch (error) {
        console.error('Erreur:', error);
        const errorMessage = 'Une erreur est survenue lors de la mise à jour de l\'objectif';
        if (window.showToast) {
          window.showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      }
    },
    
    openProofModal(event, taskId, taskTitle) {
      // Récupérer la checkbox par taskId si event.target n'est pas disponible
      let checkbox = event?.target;
      if (!checkbox && taskId) {
        checkbox = document.querySelector(`input[data-task-id="${taskId}"]`);
      }
      
      const isChecked = checkbox ? checkbox.checked : false;
      console.log('openProofModal appelé', { taskId, taskTitle, checked: isChecked, checkbox });
      
      // Empêcher la propagation de l'événement
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      
      if (!checkbox) {
        console.error('Checkbox non trouvée pour la tâche', taskId);
        return;
      }
      
      // Récupérer le statut de la tâche depuis la checkbox
      const taskStatus = checkbox.getAttribute('data-task-status');
      const taskRequiresProof = checkbox.getAttribute('data-task-requires-proof') === 'true';
      
      // Vérifier que la tâche n'est pas terminée - on ne peut ajouter des preuves que si la tâche est "pending" ou "in_progress"
      if (taskStatus === 'completed') {
        if (window.showToast) {
          window.showToast('Impossible d\'ajouter une preuve à une tâche terminée', 'error');
        }
        // Remettre la checkbox dans son état précédent
        checkbox.checked = false;
        return;
      }
      
      // Fermer les autres rightSheets s'ils sont ouverts
      this.rightSheetOpen = false;
      this.configSheetOpen = false;
      
      if (isChecked) {
        // Ouvrir le rightSheet pour ajouter une preuve
        console.log('Ouverture du rightSheet de preuve');
        this.currentTaskId = taskId;
        this.currentTaskTitle = taskTitle;
        this.currentTaskStatus = taskStatus;
        this.currentTaskRequiresProof = taskRequiresProof;
        this.proofSheetOpen = true;
        // Réinitialiser le formulaire
        this.proofFormData = {
          type: 'photo',
          description: '',
          fileBase64: null,
          fileName: null,
          fileSize: null,
          mimeType: null,
          filePreview: null,
        };
      } else {
        // Décocher sans action (la tâche reste completed jusqu'à la réinitialisation par période)
        console.log('Décocher sans action');
      }
    },
    
    openProofModalFromCheckbox(event) {
      // Empêcher la propagation de l'événement
      event.stopPropagation();
      event.preventDefault();
      
      const checkbox = event.target;
      const taskId = parseInt(checkbox.getAttribute('data-task-id'));
      const taskTitle = checkbox.getAttribute('data-task-title') || 'Tâche #' + taskId;
      const taskStatus = checkbox.getAttribute('data-task-status');
      const taskRequiresProof = checkbox.getAttribute('data-task-requires-proof') === 'true';
      
      // Vérifier que la tâche n'est pas terminée - on ne peut ajouter des preuves que si la tâche est "pending" ou "in_progress"
      if (taskStatus === 'completed') {
        if (window.showToast) {
          window.showToast('Impossible d\'ajouter une preuve à une tâche terminée', 'error');
        }
        // Remettre la checkbox dans son état précédent
        checkbox.checked = false;
        return;
      }
      
      // Cocher la checkbox manuellement (car preventDefault empêche le comportement par défaut)
      // On vérifiera les permissions côté serveur lors de la soumission
      checkbox.checked = true;
      
      // Stocker le statut avant d'ouvrir le modal
      checkbox.setAttribute('data-task-status', taskStatus);
      
      // Créer un nouvel événement avec checked = true pour openProofModal
      const syntheticEvent = {
        target: checkbox,
        stopPropagation: () => {},
        preventDefault: () => {}
      };
      this.openProofModal(syntheticEvent, taskId, taskTitle);
    },
    
    handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Vérifier le type
        if (!file.type.startsWith('image/')) {
          if (window.showToast) {
            window.showToast('Veuillez sélectionner un fichier image', 'error');
          }
          event.target.value = '';
          return;
        }
        
        // Vérifier la taille (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          if (window.showToast) {
            window.showToast('Le fichier est trop volumineux (max 5MB)', 'error');
          }
          event.target.value = '';
          return;
        }
      
      // Lire le fichier en base64
      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result;
        this.proofFormData.fileBase64 = base64.split(',')[1]; // Retirer le préfixe data:image/...
        this.proofFormData.fileName = file.name;
        this.proofFormData.fileSize = file.size;
        this.proofFormData.mimeType = file.type;
        this.proofFormData.filePreview = base64;
      };
      reader.readAsDataURL(file);
    },
    
    async submitProof() {
      if (!this.currentTaskId) return;
      
      // Vérifier que la tâche n'est pas terminée - double sécurité
      if (this.currentTaskStatus === 'completed') {
        if (window.showToast) {
          window.showToast('Impossible d\'ajouter une preuve à une tâche terminée', 'error');
        }
        this.proofSheetOpen = false;
        return;
      }
      
      this.proofSubmitting = true;
      
      try {
        // Vérifier qu'un fichier a été sélectionné si requiresProof = true
        if (this.currentTaskRequiresProof && !this.proofFormData.fileBase64) {
          if (window.showToast) {
            window.showToast('Veuillez sélectionner une photo', 'error');
          }
          this.proofSubmitting = false;
          return;
        }
        
        // Si requiresProof = false, au moins une description est requise
        if (!this.currentTaskRequiresProof && !this.proofFormData.description) {
          if (window.showToast) {
            window.showToast('Veuillez ajouter au moins une description', 'error');
          }
          this.proofSubmitting = false;
          return;
        }
        
        // Déterminer le type de preuve
        const proofType = this.proofFormData.fileBase64 ? 'photo' : 'text';
        
        // Préparer les données
        const data = {
          type: proofType,
          title: `Preuve - ${this.currentTaskTitle}`,
          description: this.proofFormData.description || null,
        };
        
        // Ajouter les données du fichier seulement si présent
        if (this.proofFormData.fileBase64) {
          data.fileBase64 = this.proofFormData.fileBase64;
          data.fileName = this.proofFormData.fileName;
          data.fileSize = this.proofFormData.fileSize;
          data.mimeType = this.proofFormData.mimeType;
        } else if (this.proofFormData.description) {
          // Si pas de fichier mais description, utiliser le contenu comme texte
          data.content = this.proofFormData.description;
        }
        
        // Envoyer la preuve
        const response = await fetch(`/admin/tasks/${this.currentTaskId}/proofs/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
        }
        
        if (response.ok && result.success) {
          // La checkbox est déjà cochée, on la garde cochée
          // Afficher un message de succès
          if (window.showToast) {
            window.showToast(result.message || 'Preuve envoyée avec succès', 'success');
          } else {
            alert(result.message || 'Preuve envoyée avec succès');
          }
          
          // Fermer le rightSheet
          this.proofSheetOpen = false;
          
          // Recharger la page pour mettre à jour l'affichage
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          // Afficher un message d'erreur
          const errorMessage = result.message || 'Erreur lors de l\'envoi de la preuve';
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
          
          // Décocher la checkbox en cas d'erreur
          const taskCheckbox = document.querySelector(`input[data-task-id="${this.currentTaskId}"]`);
          if (taskCheckbox) {
            taskCheckbox.checked = false;
          }
          
          // Fermer le rightSheet
          this.proofSheetOpen = false;
        }
      } catch (error) {
        console.error('Erreur lors de l\'envoi de la preuve:', error);
        if (window.showToast) {
          window.showToast('Une erreur est survenue', 'error');
        }
        
        // Décocher la checkbox en cas d'erreur
        const taskCheckbox = document.querySelector(`input[data-task-id="${this.currentTaskId}"]`);
        if (taskCheckbox) {
          taskCheckbox.checked = false;
        }
        
        // Fermer le rightSheet
        this.proofSheetOpen = false;
      } finally {
        this.proofSubmitting = false;
      }
    },
    
    showProofHistory(taskId, proofs, taskTitle) {
      console.log('showProofHistory appelé', { taskId, proofs, taskTitle });
      
      // Fermer les autres rightSheets s'ils sont ouverts
      this.proofSheetOpen = false;
      this.configSheetOpen = false;
      
      this.currentTaskId = taskId;
      this.currentTaskProofs = Array.isArray(proofs) ? proofs : [];
      // Récupérer le titre de la tâche
      if (taskTitle) {
        this.currentTaskTitle = taskTitle;
      } else {
        // Essayer de récupérer depuis le DOM
        const taskCheckbox = document.querySelector(`input[data-task-id="${taskId}"]`);
        if (taskCheckbox) {
          const taskCard = taskCheckbox.closest('.task') || taskCheckbox.closest('[class*="task"]');
          if (taskCard) {
            // Chercher le titre dans la structure de la carte
            const titleElement = taskCard.querySelector('h4, h3, .task-title, [class*="title"]');
            if (titleElement) {
              this.currentTaskTitle = titleElement.textContent.trim();
            }
          }
        }
      }
      if (!this.currentTaskTitle) {
        this.currentTaskTitle = 'Tâche #' + taskId;
      }
      console.log('Ouverture du rightSheet - avant:', { rightSheetOpen: this.rightSheetOpen, currentTaskProofs: this.currentTaskProofs });
      this.rightSheetOpen = true;
      console.log('Ouverture du rightSheet - après:', { rightSheetOpen: this.rightSheetOpen });
      
      // Forcer le re-render
      setTimeout(() => {
        console.log('After timeout:', { rightSheetOpen: this.rightSheetOpen });
        const sheet = document.querySelector('[x-show="rightSheetOpen"]');
        if (sheet) {
          console.log('RightSheet trouvé dans le DOM:', sheet);
        } else {
          console.error('RightSheet non trouvé dans le DOM');
        }
      }, 100);
    },
    
    showProofHistoryFromButton(event) {
      event.preventDefault();
      event.stopPropagation();
      
      // S'assurer que les autres rightSheets sont fermés
      this.proofSheetOpen = false;
      
      const button = event.currentTarget || event.target.closest('button');
      const taskId = parseInt(button.getAttribute('data-task-id'));
      const proofsJson = button.getAttribute('data-task-proofs');
      const taskTitle = button.getAttribute('data-task-title');
      
      let proofs = [];
      try {
        if (proofsJson) {
          proofs = JSON.parse(proofsJson);
        }
      } catch (e) {
        console.error('Erreur lors du parsing des preuves:', e);
        proofs = [];
      }
      
      console.log('showProofHistoryFromButton - Données:', { taskId, proofs, taskTitle });
      this.showProofHistory(taskId, proofs, taskTitle);
    },
    
    closeSheet() {
      console.log('Fermer');
      this.rightSheetOpen = false;
    },
    
    closeProofSheet() {
      this.proofSheetOpen = false;
      // Réinitialiser le formulaire
      this.proofFormData = {
        type: 'photo',
        description: '',
        fileBase64: null,
        fileName: null,
        fileSize: null,
        mimeType: null,
        filePreview: null,
      };
    },
    
    openImageModal(imageUrl, imageAlt) {
      this.enlargedImageUrl = imageUrl;
      this.enlargedImageAlt = imageAlt;
      this.imageModalOpen = true;
      // Empêcher le scroll du body quand la modal est ouverte
      document.body.style.overflow = 'hidden';
    },
    
    closeImageModal() {
      this.imageModalOpen = false;
      this.enlargedImageUrl = null;
      this.enlargedImageAlt = '';
      // Réactiver le scroll du body
      document.body.style.overflow = '';
    },
    
    async openTaskConfig(event) {
      console.log('openTaskConfig appelé', event);
      event.preventDefault();
      event.stopPropagation();
      
      // Vérifier si on peut modifier des tâches
      if (!this.objective || !this.objective.canModifyTasks) {
        if (window.showToast) {
          window.showToast(this.objective?.statusMessage || 'Impossible de modifier cette tâche', 'error');
        }
        return;
      }
      
      // Fermer les autres rightSheets
      this.proofSheetOpen = false;
      this.rightSheetOpen = false;
      
      const button = event.currentTarget || event.target.closest('button');
      if (!button) {
        console.error('Bouton non trouvé');
        return;
      }
      
      const taskId = parseInt(button.getAttribute('data-task-id'));
      const taskStatus = button.getAttribute('data-task-status');
      const taskFrequency = button.getAttribute('data-task-frequency') || 'none';
      const taskRequiresProof = button.getAttribute('data-task-requires-proof') === 'true';
      const taskTitle = button.getAttribute('data-task-title');
      const taskDescription = button.getAttribute('data-task-description') || '';
      const taskAssignedType = button.getAttribute('data-task-assigned-type') || 'coach';
      const taskStudentId = button.getAttribute('data-task-student-id') || '';
      const taskParentId = button.getAttribute('data-task-parent-id') || '';
      const taskSpecialistId = button.getAttribute('data-task-specialist-id') || '';
      const taskStartDate = button.getAttribute('data-task-start-date') || '';
      const taskDueDate = button.getAttribute('data-task-due-date') || '';
      const taskRepeatDaysOfWeek = button.getAttribute('data-task-repeat-days') || '';
      const taskActivityId = button.getAttribute('data-task-activity-id') || '';
      const taskPathId = button.getAttribute('data-task-path-id') || '';
      const taskType = button.getAttribute('data-task-type') || 'task';
      
      console.log('Données de la tâche:', { taskId, taskStatus, taskFrequency, taskRequiresProof, taskTitle, taskDescription, taskAssignedType, taskStartDate, taskDueDate, taskActivityId, taskPathId, taskType });
      
      this.currentTaskId = taskId;
      this.configTaskTitle = taskTitle || 'Tâche #' + taskId;
      
      // Formater les dates pour datetime-local ou date selon le type
      let formattedStartDate = '';
      let formattedDueDate = '';
      if (taskStartDate) {
        if (taskType === 'task') {
          // Pour datetime-local, format: YYYY-MM-DDTHH:mm
          const date = new Date(taskStartDate);
          formattedStartDate = date.toISOString().slice(0, 16);
        } else {
          formattedStartDate = taskStartDate.split(' ')[0]; // Format YYYY-MM-DD pour input date
        }
      }
      if (taskDueDate) {
        if (taskType === 'task') {
          const date = new Date(taskDueDate);
          formattedDueDate = date.toISOString().slice(0, 16);
        } else {
          formattedDueDate = taskDueDate.split(' ')[0];
        }
      }
      
      // Parser repeatDaysOfWeek depuis JSON
      let repeatDaysOfWeek = [];
      if (taskRepeatDaysOfWeek) {
        try {
          repeatDaysOfWeek = JSON.parse(taskRepeatDaysOfWeek);
        } catch (e) {
          console.error('Erreur parsing repeatDaysOfWeek:', e);
        }
      }
      
      this.taskConfig = {
        isNew: false,
        type: taskType,
        title: taskTitle || '',
        description: taskDescription || '',
        status: taskStatus || 'pending',
        requiresProof: taskRequiresProof,
        frequency: taskFrequency || 'none',
        startDate: formattedStartDate,
        dueDate: formattedDueDate,
        repeatDaysOfWeek: repeatDaysOfWeek,
        assignedType: taskAssignedType,
        studentId: taskStudentId,
        parentId: taskParentId,
        specialistId: taskSpecialistId,
        activityId: taskActivityId,
        pathId: taskPathId,
        createdAt: formattedStartDate || '',
      };
      
      this.configSheetOpen = true;
      
      // Charger le formulaire correspondant au type
      await this.onTaskTypeChange();
    },
    
    async openTaskCreate() {
      // Vérifier si on peut créer des tâches
      if (!this.objective || !this.objective.canModifyTasks) {
        if (window.showToast) {
          window.showToast(this.objective?.statusMessage || 'Impossible de créer une tâche pour cet objectif', 'error');
        }
        return;
      }
      
      // Fermer les autres rightSheets
      this.proofSheetOpen = false;
      this.rightSheetOpen = false;
      
      this.currentTaskId = null;
      this.configTaskTitle = '';
      
      // Initialiser les dates avec la date/heure actuelle pour les champs datetime-local
      const now = new Date();
      now.setHours(9, 0, 0, 0); // 9h00 par défaut
      const nowFormatted = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:mm
      
      // Date de fin par défaut: +1 jour à 17h00
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(17, 0, 0, 0); // 17h00 par défaut
      const tomorrowFormatted = tomorrow.toISOString().slice(0, 16);
      
      this.taskConfig = {
        isNew: true,
        type: 'task',
        title: '',
        description: '',
        status: 'pending',
        requiresProof: true,
        frequency: 'none',
        startDate: nowFormatted,
        dueDate: tomorrowFormatted,
        repeatDaysOfWeek: [],
        assignedType: 'coach',
        studentId: '',
        parentId: '',
        specialistId: '',
        activityId: '',
        pathId: '',
        createdAt: nowFormatted,
      };
      
      this.configSheetOpen = true;
      
      // Charger le formulaire correspondant au type
      await this.onTaskTypeChange();
    },
    
    onAssignedTypeChange() {
      // Réinitialiser tous les IDs d'affectation
      this.taskConfig.studentId = '';
      this.taskConfig.parentId = '';
      this.taskConfig.specialistId = '';
      
      // Définir les valeurs par défaut selon le type d'affectation
      if (this.taskConfig.assignedType === 'student' && this.objective?.student?.id) {
        // Si "Élève" est sélectionné, définir l'élève de l'objectif par défaut
        this.taskConfig.studentId = this.objective.student.id;
      } else if (this.taskConfig.assignedType === 'parent' && this.objective?.parent?.id) {
        // Si "Parent" est sélectionné, définir le parent de l'élève de l'objectif par défaut
        this.taskConfig.parentId = this.objective.parent.id;
      }
      // Pour "specialist", on laisse vide (pas de valeur par défaut)
    },
    
    onFrequencyChange() {
      // Si la fréquence n'est pas "weekly", réinitialiser les jours de la semaine
      if (this.taskConfig.frequency !== 'weekly') {
        this.taskConfig.repeatDaysOfWeek = [];
      }
    },
    
    closeConfigSheet() {
      // Détruire toutes les instances ChoiceJS avant de fermer
      const choicesInstances = [
        this.regularActivityChoicesInstance,
        this.schoolActivityChoicesInstance,
        this.workshopSpecialistsChoicesInstance,
        this.workshopStudentsChoicesInstance,
        this.workshopActivitiesChoicesInstance,
        this.studentsChoicesInstance,
      ];

      choicesInstances.forEach(instance => {
        if (instance) {
          try {
            instance.destroy();
          } catch (e) {
            console.warn('Erreur lors de la destruction de ChoiceJS:', e);
          }
        }
      });

      // Réinitialiser toutes les instances
      this.regularActivityChoicesInstance = null;
      this.schoolActivityChoicesInstance = null;
      this.workshopSpecialistsChoicesInstance = null;
      this.workshopStudentsChoicesInstance = null;
      this.workshopActivitiesChoicesInstance = null;
      this.studentsChoicesInstance = null;
      
      this.configSheetOpen = false;
      this.currentTaskId = null;
      this.configTaskTitle = '';
      this.taskFormHtml = '';
      this.taskConfig = {
        isNew: false,
        type: 'task',
        title: '',
        description: '',
        status: 'pending',
        requiresProof: true,
        frequency: 'none',
        assignedType: 'coach',
        studentId: '',
        parentId: '',
        specialistId: '',
        activityId: '',
        pathId: '',
        createdAt: '',
        dueDate: '',
        // Nouveaux champs
        location: '',
        familyId: '',
        assessmentNotes: '',
        requestId: '',
        specialistIds: [],
        studentIds: [],
        activityIds: [],
      };
    },
    
    async onTaskTypeChange() {
      // Charger le formulaire correspondant au type via AJAX
      if (!this.taskConfig.type) {
        this.taskFormHtml = '';
        return;
      }

      this.taskFormLoading = true;
      
      try {
        const objectiveId = this.objective?.id;
        const taskId = this.currentTaskId;
        
        let url = `/admin/tasks/form/${this.taskConfig.type}?objectiveId=${objectiveId}`;
        if (taskId) {
          url += `&taskId=${taskId}`;
        }

        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement du formulaire');
        }

        const html = await response.text();
        this.taskFormHtml = html;

        // Réinitialiser Alpine.js sur le nouveau contenu
        await this.$nextTick();
        Alpine.initTree(document.getElementById('task-form-container'));

        // Initialiser Choices.js si nécessaire (pour les selects multiples)
        setTimeout(() => {
          this.initChoicesForTaskType();
        }, 100);

      } catch (error) {
        console.error('Erreur lors du chargement du formulaire:', error);
        if (window.showToast) {
          window.showToast('Erreur lors du chargement du formulaire', 'error');
        }
        this.taskFormHtml = '<p class="text-red-500">Erreur lors du chargement du formulaire</p>';
      } finally {
        this.taskFormLoading = false;
      }
    },

    initChoicesForTaskType() {
      // Initialiser Choices.js pour les selects multiples selon le type
      const type = this.taskConfig.type;
      
      if (type === 'workshop') {
        // Spécialistes
        const specialistsSelect = this.$el.querySelector('#workshop-specialists-select');
        if (specialistsSelect && typeof Choices !== 'undefined') {
          if (this.workshopSpecialistsChoicesInstance) {
            this.workshopSpecialistsChoicesInstance.destroy();
          }
          this.workshopSpecialistsChoicesInstance = new Choices(specialistsSelect, {
            removeItemButton: true,
            searchEnabled: true,
          });
        }

        // Étudiants
        const studentsSelect = this.$el.querySelector('#workshop-students-select');
        if (studentsSelect && typeof Choices !== 'undefined') {
          if (this.workshopStudentsChoicesInstance) {
            this.workshopStudentsChoicesInstance.destroy();
          }
          this.workshopStudentsChoicesInstance = new Choices(studentsSelect, {
            removeItemButton: true,
            searchEnabled: true,
          });
        }

        // Activités
        const activitiesSelect = this.$el.querySelector('#workshop-activities-select');
        if (activitiesSelect && typeof Choices !== 'undefined') {
          if (this.workshopActivitiesChoicesInstance) {
            this.workshopActivitiesChoicesInstance.destroy();
          }
          this.workshopActivitiesChoicesInstance = new Choices(activitiesSelect, {
            removeItemButton: true,
            searchEnabled: true,
          });
        }
      } else if (type === 'assessment' || type === 'individual_work' || type === 'individual_work_remote' || type === 'individual_work_on_site') {
        // Étudiants pour assessment et individual_work*
        const studentsSelectId = type === 'assessment' ? '#assessment-students-select' :
                                 type === 'individual_work' ? '#individual-work-students-select' :
                                 type === 'individual_work_remote' ? '#individual-work-remote-students-select' :
                                 '#individual-work-on-site-students-select';
        
        const studentsSelect = this.$el.querySelector(studentsSelectId);
        if (studentsSelect && typeof Choices !== 'undefined') {
          if (this.studentsChoicesInstance) {
            this.studentsChoicesInstance.destroy();
          }
          this.studentsChoicesInstance = new Choices(studentsSelect, {
            removeItemButton: true,
            searchEnabled: true,
          });
        }
      }
    },
    
    onActivitySelected() {
      // Préremplir titre et description depuis l'activité sélectionnée
      if (!this.taskConfig.activityId) {
        return;
      }
      
      const activityId = parseInt(this.taskConfig.activityId);
      const activity = this.regularActivities.find(a => a.id === activityId);
      
      if (activity) {
        this.taskConfig.title = activity.title || '';
        this.taskConfig.description = activity.description || '';
      }
    },
    
    onPathSelected() {
      // Préremplir titre et description depuis l'activité scolaire sélectionnée
      if (!this.taskConfig.pathId) {
        return;
      }
      
      const pathId = parseInt(this.taskConfig.pathId);
      const path = this.schoolActivities.find(p => p.id === pathId);
      
      if (path) {
        this.taskConfig.title = path.title || '';
        this.taskConfig.description = path.description || '';
      }
    },
    
    async saveTaskConfig() {
      // Validation du titre
      if (!this.taskConfig.title || this.taskConfig.title.trim() === '') {
        if (window.showToast) {
          window.showToast('Le titre est requis', 'error');
        }
        this.configSubmitting = false;
        return;
      }
      
      // Validation selon le type de tâche
      if (this.taskConfig.type === 'activity_task' && !this.taskConfig.activityId) {
        if (window.showToast) {
          window.showToast('Veuillez sélectionner une activité', 'error');
        }
        this.configSubmitting = false;
        return;
      }
      
      if (this.taskConfig.type === 'school_activity_task' && !this.taskConfig.pathId) {
        if (window.showToast) {
          window.showToast('Veuillez sélectionner une activité scolaire', 'error');
        }
        this.configSubmitting = false;
        return;
      }
      
      // Validation : si fréquence hebdomadaire, au moins un jour doit être sélectionné
      if (this.taskConfig.frequency === 'weekly' && (!this.taskConfig.repeatDaysOfWeek || this.taskConfig.repeatDaysOfWeek.length === 0)) {
        if (window.showToast) {
          window.showToast('Veuillez sélectionner au moins un jour de la semaine', 'error');
        }
        this.configSubmitting = false;
        return;
      }
      
      // Validation : date de fin >= date de début
      if (this.taskConfig.startDate && this.taskConfig.dueDate) {
        const startDate = new Date(this.taskConfig.startDate);
        const dueDate = new Date(this.taskConfig.dueDate);
        if (dueDate < startDate) {
          if (window.showToast) {
            window.showToast('La date de fin doit être supérieure ou égale à la date de début', 'error');
          }
          this.configSubmitting = false;
          return;
        }
      }
      
      // Validation : en mode édition, currentTaskId doit être défini
      if (!this.taskConfig.isNew && !this.currentTaskId) {
        if (window.showToast) {
          window.showToast('Erreur : ID de tâche manquant', 'error');
        }
        this.configSubmitting = false;
        return;
      }
      
      this.configSubmitting = true;
      
      try {
        // Préparer les données à envoyer
        const dataToSend = {
          type: this.taskConfig.type,
          title: this.taskConfig.title,
          description: this.taskConfig.description || '',
          status: this.taskConfig.status,
          requiresProof: this.taskConfig.requiresProof,
          frequency: this.taskConfig.frequency,
          assignedType: this.taskConfig.assignedType,
        };
        
        // Ajouter les dates si elles sont définies
        if (this.taskConfig.startDate) {
          dataToSend.startDate = this.taskConfig.startDate;
        }
        if (this.taskConfig.dueDate) {
          dataToSend.dueDate = this.taskConfig.dueDate;
        }
        if (this.taskConfig.repeatDaysOfWeek && this.taskConfig.repeatDaysOfWeek.length > 0) {
          dataToSend.repeatDaysOfWeek = this.taskConfig.repeatDaysOfWeek;
        }
        // Garder createdAt pour compatibilité (utiliser startDate si disponible)
        if (this.taskConfig.createdAt) {
          dataToSend.createdAt = this.taskConfig.createdAt;
        }
        
        // Ajouter l'ID selon le type d'affectation
        if (this.taskConfig.assignedType === 'student' && this.taskConfig.studentId) {
          dataToSend.studentId = parseInt(this.taskConfig.studentId);
        } else if (this.taskConfig.assignedType === 'parent' && this.taskConfig.parentId) {
          dataToSend.parentId = parseInt(this.taskConfig.parentId);
        } else if (this.taskConfig.assignedType === 'specialist' && this.taskConfig.specialistId) {
          dataToSend.specialistId = parseInt(this.taskConfig.specialistId);
        }
        
        // Ajouter l'activité liée selon le type de tâche
        if (this.taskConfig.type === 'activity_task' && this.taskConfig.activityId) {
          dataToSend.activityId = parseInt(this.taskConfig.activityId);
        }
        
        // Ajouter l'activité scolaire liée selon le type de tâche
        if (this.taskConfig.type === 'school_activity_task' && this.taskConfig.pathId) {
          dataToSend.pathId = parseInt(this.taskConfig.pathId);
        }
        
        // Champs spécifiques pour WORKSHOP
        if (this.taskConfig.type === 'workshop') {
          if (this.taskConfig.location) {
            dataToSend.location = this.taskConfig.location;
          }
          if (this.taskConfig.familyId) {
            dataToSend.familyId = parseInt(this.taskConfig.familyId);
          }
        }
        
        // Champs spécifiques pour ASSESSMENT
        if (this.taskConfig.type === 'assessment') {
          if (this.taskConfig.assessmentNotes) {
            dataToSend.assessmentNotes = this.taskConfig.assessmentNotes;
          }
        }
        
        // Champs spécifiques pour INDIVIDUAL_WORK_ON_SITE
        if (this.taskConfig.type === 'individual_work_on_site') {
          if (this.taskConfig.location) {
            dataToSend.location = this.taskConfig.location;
          }
        }
        
        // Champs spécifiques pour INDIVIDUAL_WORK_REMOTE
        if (this.taskConfig.type === 'individual_work_remote') {
          if (this.taskConfig.requestId) {
            dataToSend.requestId = parseInt(this.taskConfig.requestId);
          }
        }
        
        // Déterminer l'URL selon le mode (création ou édition)
        const url = this.taskConfig.isNew 
          ? `/admin/objectives/${this.objectiveId}/tasks/create`
          : `/admin/tasks/${this.currentTaskId}/update`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(dataToSend),
        });
        
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
        }
        
        if (response.ok && result.success) {
          const message = this.taskConfig.isNew 
            ? (result.message || 'Tâche créée avec succès')
            : (result.message || 'Configuration enregistrée avec succès');
          if (window.showToast) {
            window.showToast(message, 'success');
          } else {
            alert(message);
          }
          
          // Fermer le rightSheet
          this.closeConfigSheet();
          
          // Recharger la page pour mettre à jour l'affichage
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          const errorMessage = result.message || (this.taskConfig.isNew 
            ? 'Erreur lors de la création de la tâche'
            : 'Erreur lors de l\'enregistrement de la configuration');
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
          this.configSubmitting = false;
        }
      } catch (error) {
        console.error('Erreur lors de l\'enregistrement:', error);
        const errorMessage = this.taskConfig.isNew 
          ? 'Erreur lors de la création de la tâche'
          : 'Erreur lors de l\'enregistrement de la configuration';
        if (window.showToast) {
          window.showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        this.configSubmitting = false;
      }
    },
    
    formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    },
    
    // Fonctions pour les commentaires
    openCommentCreate() {
      this.commentFormOpen = true;
      this.commentEditMode = false;
      this.currentCommentId = null;
      this.commentFormData = {
        content: '',
      };
    },
    
    openCommentEdit(commentId, content) {
      this.commentFormOpen = true;
      this.commentEditMode = true;
      this.currentCommentId = commentId;
      this.commentFormData = {
        content: content,
      };
    },
    
    closeCommentForm() {
      this.commentFormOpen = false;
      this.commentEditMode = false;
      this.currentCommentId = null;
      this.commentFormData = {
        content: '',
      };
    },
    
    async saveComment() {
      if (!this.commentFormData.content || this.commentFormData.content.trim() === '') {
        if (window.showToast) {
          window.showToast('Le commentaire ne peut pas être vide', 'error');
        }
        return;
      }
      
      this.commentSubmitting = true;
      
      try {
        const url = this.commentEditMode
          ? `/admin/objectives/${this.objectiveId}/comments/${this.currentCommentId}/update`
          : `/admin/objectives/${this.objectiveId}/comments/create`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify(this.commentFormData),
        });
        
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
        }
        
        if (response.ok && result.success) {
          if (window.showToast) {
            window.showToast(result.message || 'Commentaire enregistré avec succès', 'success');
          } else {
            alert(result.message || 'Commentaire enregistré avec succès');
          }
          
          // Fermer le formulaire
          this.closeCommentForm();
          
          // Recharger la page pour mettre à jour l'affichage
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          const errorMessage = result.message || 'Erreur lors de l\'enregistrement du commentaire';
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
        }
      } catch (error) {
        console.error('Erreur lors de l\'enregistrement du commentaire:', error);
        const errorMessage = 'Une erreur est survenue lors de l\'enregistrement du commentaire';
        if (window.showToast) {
          window.showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        this.commentSubmitting = false;
      }
    },
    
    async deleteTask(taskId, taskStatus = null) {
      // Vérifier que l'objectif peut être modifié avant de permettre la suppression
      const canModify = this.objective?.canModifyTasks !== false;
      
      if (!canModify) {
        if (window.showToast) {
          window.showToast('Impossible de supprimer cette tâche. L\'objectif est validé par le coach.', 'error');
        }
        return;
      }
      
      // Vérifier que la tâche n'est pas terminée
      // Les tâches terminées ne peuvent pas être supprimées
      if (taskStatus === 'completed') {
        if (window.showToast) {
          window.showToast('Impossible de supprimer une tâche terminée.', 'error');
        }
        return;
      }
      
      if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')) {
        return;
      }
      
      try {
        const response = await fetch(`/admin/tasks/${taskId}/delete`, {
          method: 'DELETE',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
        }
        
        if (response.ok && result.success) {
          if (window.showToast) {
            window.showToast(result.message || 'Tâche supprimée avec succès', 'success');
          } else {
            alert(result.message || 'Tâche supprimée avec succès');
          }
          
          // Recharger la page pour mettre à jour l'affichage
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          const errorMessage = result.message || 'Erreur lors de la suppression de la tâche';
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
        }
      } catch (error) {
        console.error('Erreur lors de la suppression de la tâche:', error);
        const errorMessage = 'Une erreur est survenue lors de la suppression de la tâche';
        if (window.showToast) {
          window.showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      }
    },
    
    async deleteComment(commentId) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?')) {
        return;
      }
      
      try {
        const response = await fetch(`/admin/objectives/${this.objectiveId}/comments/${commentId}/delete`, {
          method: 'DELETE',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { success: false, message: 'Erreur lors de la lecture de la réponse' };
        }
        
        if (response.ok && result.success) {
          if (window.showToast) {
            window.showToast(result.message || 'Commentaire supprimé avec succès', 'success');
          } else {
            alert(result.message || 'Commentaire supprimé avec succès');
          }
          
          // Recharger la page pour mettre à jour l'affichage
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          const errorMessage = result.message || 'Erreur lors de la suppression du commentaire';
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
        }
      } catch (error) {
        console.error('Erreur lors de la suppression du commentaire:', error);
        const errorMessage = 'Une erreur est survenue lors de la suppression du commentaire';
        if (window.showToast) {
          window.showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      }
    },
    
    openAIHelpSheet() {
      // Initialiser avec la description de l'objectif seulement si elle n'est pas déjà définie
      if (!this.aiHelpDescription) {
        this.aiHelpDescription = this.objective?.descriptionOrigin || this.objective?.description || '';
      }
      
      // Ne pas réinitialiser les suggestions pour garder l'historique
      // Les suggestions restent disponibles même après fermeture du right sheet
      // Seulement réinitialiser si on n'a jamais généré de suggestions
      if (!this.aiSuggestedTasks || this.aiSuggestedTasks.length === 0) {
        this.aiSuggestedTasks = [];
        this.selectedAITaskIndices = [];
      }
      
      // Ne pas réinitialiser la checkbox et les suggestions d'objectif pour garder l'historique
      // this.updateObjectiveTitleAndDescription reste à sa valeur actuelle
      // this.aiSuggestedObjective reste à sa valeur actuelle
      
      this.aiHelpSheetOpen = true;
    },
    
    handleAIClickAway(event) {
      // Vérifier si du texte est sélectionné
      if (window.getSelection().toString().length > 0) {
        return; // Ne pas fermer si du texte est sélectionné
      }
      
      // Vérifier si le clic est sur un élément interactif
      const target = event.target;
      const isInteractive = target.closest('input, select, textarea, button, label, .choices') !== null;
      
      if (isInteractive) {
        return; // Ne pas fermer si c'est un élément interactif
      }
      
      // Fermer le right sheet
      this.aiHelpSheetOpen = false;
    },
    
    async generateAISuggestions() {
      if (!this.aiHelpDescription || !this.objective?.student?.id) {
        if (window.showToast) {
          window.showToast('Veuillez remplir la description et vérifier que l\'élève est défini', 'error');
        }
        return;
      }

      this.isGeneratingAISuggestions = true;
      this.aiSuggestedTasks = [];
      this.selectedAITaskIndices = [];

      try {
        // Récupérer la classe de l'élève
        const student = this.studentsData.find(s => s.id === this.objective.student.id);
        const studentClass = student?.class || '';

        const response = await fetch('/admin/objectives/generate-suggestions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({
            description: this.aiHelpDescription,
            studentId: this.objective.student.id,
            studentClass: studentClass,
            category: this.objective.category || 'general',
            generateObjective: this.updateObjectiveTitleAndDescription, // Ne générer l'objectif que si la checkbox est cochée
          }),
        });

        const data = await response.json();

        if (data.success && data.suggestions) {
          // Stocker les suggestions de l'objectif SEULEMENT si la checkbox est cochée
          if (this.updateObjectiveTitleAndDescription && data.suggestions.objective) {
            this.aiSuggestedObjective = data.suggestions.objective;
            console.log('Suggestions objectif reçues:', this.aiSuggestedObjective);
          } else {
            // Si la checkbox n'est pas cochée, ne pas stocker les suggestions d'objectif
            this.aiSuggestedObjective = null;
          }
          
          if (data.suggestions.tasks) {
            this.aiSuggestedTasks = data.suggestions.tasks;
            // Sélectionner toutes les tâches par défaut
            this.selectedAITaskIndices = this.aiSuggestedTasks.map((_, index) => index);
          }
        } else {
          if (window.showToast) {
            window.showToast(data.message || 'Erreur lors de la génération des suggestions', 'error');
          }
        }
      } catch (error) {
        console.error('Erreur:', error);
        if (window.showToast) {
          window.showToast('Erreur de connexion', 'error');
        }
      } finally {
        this.isGeneratingAISuggestions = false;
      }
    },
    
    async addSelectedTasksToObjective() {
      if (!this.selectedAITaskIndices || this.selectedAITaskIndices.length === 0) {
        if (window.showToast) {
          window.showToast('Veuillez sélectionner au moins une tâche', 'error');
        }
        return;
      }

      const selectedTasks = this.selectedAITaskIndices.map(index => this.aiSuggestedTasks[index]).filter(task => task !== undefined);
      
      if (selectedTasks.length === 0) {
        if (window.showToast) {
          window.showToast('Aucune tâche valide sélectionnée', 'error');
        }
        return;
      }

      try {
        // Si la checkbox est cochée et qu'on a des suggestions pour l'objectif, mettre à jour le titre et la description
        if (this.updateObjectiveTitleAndDescription && this.aiSuggestedObjective) {
          const updateResponse = await fetch(`/admin/objectives/${this.objectiveId}/update`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
              title: this.aiSuggestedObjective.title || this.objective.title,
              description: this.aiSuggestedObjective.description || this.objective.description,
            }),
          });
          
          const updateResult = await updateResponse.json();
          if (!updateResult.success) {
            console.warn('Erreur lors de la mise à jour de l\'objectif:', updateResult.message);
          }
        }

        // Créer toutes les tâches sélectionnées
        const createPromises = selectedTasks.map(taskData => {
          return fetch(`/admin/objectives/${this.objectiveId}/tasks/create`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
              title: taskData.title || '',
              description: taskData.description || '',
              status: 'pending',
              frequency: taskData.frequency || 'none',
              requiresProof: taskData.requiresProof !== false,
              proofType: taskData.proofType || '',
              assignedType: 'coach',
            }),
          });
        });

        const responses = await Promise.all(createPromises);
        const results = await Promise.all(responses.map(r => r.json()));

        const successCount = results.filter(r => r.success).length;
        
        if (successCount > 0) {
          const message = this.updateObjectiveTitleAndDescription && this.aiSuggestedObjective
            ? `${successCount} tâche(s) ajoutée(s) et objectif mis à jour avec succès`
            : `${successCount} tâche(s) ajoutée(s) avec succès`;
          
          if (window.showToast) {
            window.showToast(message, 'success');
          }
          
          // Fermer le right sheet et recharger la page
          this.aiHelpSheetOpen = false;
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          if (window.showToast) {
            window.showToast('Erreur lors de l\'ajout des tâches', 'error');
          }
        }
      } catch (error) {
        console.error('Erreur:', error);
        if (window.showToast) {
          window.showToast('Erreur de connexion', 'error');
        }
      }
    },
    
    get selectedAITasksCount() {
      return this.selectedAITaskIndices ? this.selectedAITaskIndices.length : 0;
    },
    
    clearAIHistory() {
      // Réinitialiser toutes les données de l'aide IA
      this.aiHelpDescription = this.objective?.descriptionOrigin || this.objective?.description || '';
      this.aiSuggestedTasks = [];
      this.selectedAITaskIndices = [];
      this.updateObjectiveTitleAndDescription = false;
      this.aiSuggestedObjective = null;
      
      if (window.showToast) {
        window.showToast('Suggestions réinitialisées', 'success');
      }
    },
  };
}
</script>
{% endblock %}
