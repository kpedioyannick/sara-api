{% extends 'tailadmin/layouts/base.html.twig' %}

{% block content %}
<!-- ===== Main Content Start ===== -->
<main x-data="taskManager()">
  <div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
    <!-- Breadcrumb Start -->
    <div x-data="{ pageName: 'Détail de l\'Objectif' }">
      <div class="flex flex-wrap items-center justify-between gap-3 pb-6">
        <h2
          class="text-xl font-semibold text-gray-800 dark:text-white/90"
          x-text="pageName"
        ></h2>
        <nav>
          <ol class="flex items-center gap-1.5">
            {% for breadcrumb in breadcrumbs %}
              <li>
                {% if breadcrumb.url %}
                  <a
                    class="inline-flex items-center gap-1.5 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                    href="{{ breadcrumb.url }}"
                  >
                    {{ breadcrumb.label }}
                    <svg
                      class="stroke-current"
                      width="17"
                      height="16"
                      viewBox="0 0 17 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M6.0765 12.667L10.2432 8.50033L6.0765 4.33366"
                        stroke=""
                        stroke-width="1.2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </a>
                {% else %}
                  <span class="text-sm text-gray-800 dark:text-white/90">{{ breadcrumb.label }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
        </nav>
      </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Objective Info Card -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mb-6">
      <div class="p-4 xl:p-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <h3 class="text-2xl font-semibold text-gray-800 dark:text-white/90 mb-2">
              {{ objective.title }}
            </h3>
            <div class="flex flex-wrap items-center gap-3 mb-4">
              <span class="inline-flex rounded-full bg-brand-50 px-3 py-1 text-sm font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400">
                {{ objective.category }}
              </span>
              <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-medium
                {% if objective.status == 'completed' %}bg-success-50 text-success-500 dark:bg-success-500/15 dark:text-success-400
                {% elseif objective.status == 'in_progress' %}bg-warning-50 text-warning-500 dark:bg-warning-500/15 dark:text-warning-400
                {% else %}bg-gray-100 text-gray-700 dark:bg-white/[0.03] dark:text-white/80{% endif %}">
                {% if objective.status == 'completed' %}Terminé
                {% elseif objective.status == 'in_progress' %}En cours
                {% else %}En attente{% endif %}
              </span>
            </div>
          </div>
          <a href="{{ path('admin_objectives_list') }}" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03]">
            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 16.7071C9.31658 17.0976 8.68342 17.0976 8.29289 16.7071L2.29289 10.7071C1.90237 10.3166 1.90237 9.68342 2.29289 9.29289L8.29289 3.29289C8.68342 2.90237 9.31658 2.90237 9.70711 3.29289C10.0976 3.68342 10.0976 4.31658 9.70711 4.70711L5.41421 9H17C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11H5.41421L9.70711 15.2929C10.0976 15.6834 10.0976 16.3166 9.70711 16.7071Z" fill=""/>
            </svg>
            Retour
          </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-50 dark:bg-brand-500/15">
              <svg class="fill-current text-brand-500 dark:text-brand-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM9 11V9H11V11H9ZM9 13V11H11V13H9Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Élève</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.student.firstName }} {{ objective.student.lastName }}</p>
            </div>
          </div>
          {% if objective.deadline %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning-50 dark:bg-warning-500/15">
              <svg class="fill-current text-warning-500 dark:text-warning-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Échéance</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.deadline|date('d/m/Y') }}</p>
            </div>
          </div>
          {% endif %}
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-success-50 dark:bg-success-500/15">
              <svg class="fill-current text-success-500 dark:text-success-400" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16ZM13.7071 8.29289C14.0976 7.90237 14.0976 7.26921 13.7071 6.87868C13.3166 6.48816 12.6834 6.48816 12.2929 6.87868L9 10.1716L7.70711 8.87868C7.31658 8.48816 6.68342 8.48816 6.29289 8.87868C5.90237 9.26921 5.90237 9.90237 6.29289 10.2929L8.29289 12.2929C8.68342 12.6834 9.31658 12.6834 9.70711 12.2929L13.7071 8.29289Z" fill=""/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Progression</p>
              <p class="text-base font-medium text-gray-800 dark:text-white/90">{{ objective.progress }}%</p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progression</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">{{ objective.progress }}%</span>
          </div>
          <div class="h-2 bg-gray-200 rounded-full overflow-hidden dark:bg-gray-700">
            <div class="h-full bg-brand-500 transition-all duration-300" style="width: {{ objective.progress }}%"></div>
          </div>
        </div>

        <div>
          <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</h4>
          <p class="text-base text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{{ objective.description }}</p>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div
      class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
    >
      <!-- Task header Start -->
      <div class="flex flex-col items-center px-4 py-5 xl:px-6 xl:py-6">
        <div
          class="flex flex-col w-full gap-5 sm:justify-between xl:flex-row xl:items-center"
        >
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">Tâches</h3>
          <div class="flex flex-wrap items-center gap-3 xl:justify-end">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              Total: {{ tasks.pending|length + tasks.in_progress|length + tasks.completed|length }}
            </span>
          </div>
        </div>
      </div>
      <!-- Task header End -->

      <!-- Task wrapper Start -->
      <div
        class="p-4 space-y-8 border-t border-gray-200 mt-7 dark:border-gray-800 sm:mt-0 xl:p-6"
      >
        <!-- To do list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              To Do
              <span
                class="inline-flex rounded-full bg-gray-100 px-2 py-0.5 text-theme-xs font-medium text-gray-700 dark:bg-white/[0.03] dark:text-white/80"
              >
                {{ tasks.pending|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.pending %}
          <!-- task item -->
          <div
            draggable="true"
            class="p-5 bg-white border border-gray-200 task rounded-xl shadow-theme-sm dark:border-gray-800 dark:bg-white/5"
          >
            <div
              class="flex flex-col gap-5 xl:flex-row xl:items-center xl:justify-between"
            >
              <div class="flex items-start w-full gap-4">
                <span class="text-gray-400">
                  <svg
                    class="fill-current"
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M2.43311 5.0001C2.43311 4.50304 2.83605 4.1001 3.33311 4.1001L16.6664 4.1001C17.1635 4.1001 17.5664 4.50304 17.5664 5.0001C17.5664 5.49715 17.1635 5.9001 16.6664 5.9001L3.33311 5.9001C2.83605 5.9001 2.43311 5.49716 2.43311 5.0001ZM2.43311 15.0001C2.43311 14.503 2.83605 14.1001 3.33311 14.1001L16.6664 14.1001C17.1635 14.1001 17.5664 14.503 17.5664 15.0001C17.5664 15.4972 17.1635 15.9001 16.6664 15.9001L3.33311 15.9001C2.83605 15.9001 2.43311 15.4972 2.43311 15.0001ZM3.33311 9.1001C2.83605 9.1001 2.43311 9.50304 2.43311 10.0001C2.43311 10.4972 2.83605 10.9001 3.33311 10.9001L16.6664 10.9001C17.1635 10.9001 17.5664 10.4972 17.5664 10.0001C17.5664 9.50304 17.1635 9.1001 16.6664 9.1001L3.33311 9.1001Z"
                      fill=""
                    />
                  </svg>
                </span>

                <label
                  for="taskCheckbox{{ task.id }}"
                  class="w-full cursor-pointer"
                >
                  <div class="relative flex items-start">
                    <input
                      type="checkbox"
                      id="taskCheckbox{{ task.id }}"
                      class="sr-only taskCheckbox"
                      data-task-id="{{ task.id }}"
                      {% if task.status == 'completed' %}checked{% endif %}
                      @change="openProofModal($event, {{ task.id }}, '{{ task.title|escape('js') }}')"
                    />
                    <div
                      class="flex items-center justify-center w-full h-5 mr-3 border border-gray-300 rounded-md box max-w-5 dark:border-gray-700"
                    >
                      <span class="opacity-0">
                        <svg
                          width="14"
                          height="14"
                          viewBox="0 0 14 14"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M11.6668 3.5L5.25016 9.91667L2.3335 7"
                            stroke="white"
                            stroke-width="1.94437"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </span>
                    </div>
                    <p
                      class="-mt-0.5 text-base text-gray-800 dark:text-white/90"
                    >
                      {{ task.title }}
                    </p>
                  </div>
                </label>
              </div>

              <div
                class="flex flex-col-reverse items-start justify-end w-full gap-3 xl:flex-row xl:items-center xl:gap-5"
              >
                <div class="flex items-center gap-2">
                  <span
                    class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-theme-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400"
                  >
                    Preuve requise
                  </span>
                  {% if task.proofs|length > 0 %}
                  <button
                    @click="showProofHistory({{ task.id }}, {{ task.proofs|json_encode|raw }})"
                    class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-theme-xs font-medium text-gray-700 hover:bg-gray-200 dark:bg-white/[0.03] dark:text-white/80 dark:hover:bg-white/[0.05]"
                    title="Voir l'historique des preuves"
                  >
                    <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8 1C4.134 1 1 4.134 1 8s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12.5c-3.032 0-5.5-2.468-5.5-5.5S4.968 2.5 8 2.5 13.5 4.968 13.5 8 11.032 13.5 8 13.5z" fill=""/>
                      <path d="M8 4.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm0 6a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill=""/>
                    </svg>
                    {{ task.proofs|length }}
                  </button>
                  {% endif %}
                </div>

                <div
                  class="flex items-center justify-between w-full gap-5 xl:w-auto xl:justify-normal"
                >
                  <div class="flex items-center gap-3">
                    {% if task.dueDate %}
                    <span
                      class="flex items-center gap-1 text-sm text-gray-500 cursor-pointer dark:text-gray-400"
                    >
                      <svg
                        class="fill-current"
                        width="16"
                        height="16"
                        viewBox="0 0 16 16"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM5.33329 3.75016L3.66663 3.75016C3.52855 3.75016 3.41663 3.86209 3.41663 4.00016V5.25016L12.5833 5.25016V4.00016C12.5833 3.86209 12.4714 3.75016 12.3333 3.75016L10.6666 3.75016L5.33329 3.75016ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z"
                          fill=""
                        />
                      </svg>
                      {{ task.dueDate|date('d/m/Y') }}
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune tâche</p>
          </div>
          {% endfor %}
        </div>

        <!-- Progress list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              In Progress
              <span
                class="inline-flex rounded-full bg-warning-50 px-2 py-0.5 text-theme-xs font-medium text-warning-700 dark:bg-warning-500/15 dark:text-orange-400"
              >
                {{ tasks.in_progress|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.in_progress %}
          <!-- task item -->
          <div
            draggable="true"
            class="p-5 bg-white border border-gray-200 task rounded-xl shadow-theme-sm dark:border-gray-800 dark:bg-white/5"
          >
            <div
              class="flex flex-col gap-5 xl:flex-row xl:items-center xl:justify-between"
            >
              <div class="flex items-start w-full gap-4">
                <span class="text-gray-400">
                  <svg
                    class="fill-current"
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M2.43311 5.0001C2.43311 4.50304 2.83605 4.1001 3.33311 4.1001L16.6664 4.1001C17.1635 4.1001 17.5664 4.50304 17.5664 5.0001C17.5664 5.49715 17.1635 5.9001 16.6664 5.9001L3.33311 5.9001C2.83605 5.9001 2.43311 5.49716 2.43311 5.0001ZM2.43311 15.0001C2.43311 14.503 2.83605 14.1001 3.33311 14.1001L16.6664 14.1001C17.1635 14.1001 17.5664 14.503 17.5664 15.0001C17.5664 15.4972 17.1635 15.9001 16.6664 15.9001L3.33311 15.9001C2.83605 15.9001 2.43311 15.4972 2.43311 15.0001ZM3.33311 9.1001C2.83605 9.1001 2.43311 9.50304 2.43311 10.0001C2.43311 10.4972 2.83605 10.9001 3.33311 10.9001L16.6664 10.9001C17.1635 10.9001 17.5664 10.4972 17.5664 10.0001C17.5664 9.50304 17.1635 9.1001 16.6664 9.1001L3.33311 9.1001Z"
                      fill=""
                    />
                  </svg>
                </span>

                <label
                  for="taskCheckbox{{ task.id }}"
                  class="w-full cursor-pointer"
                >
                  <div class="relative flex items-start">
                    <input
                      type="checkbox"
                      id="taskCheckbox{{ task.id }}"
                      class="sr-only taskCheckbox"
                      data-task-id="{{ task.id }}"
                      checked
                      @change="openProofModal($event, {{ task.id }}, '{{ task.title|escape('js') }}')"
                    />
                    <div
                      class="flex items-center justify-center w-full h-5 mr-3 border border-gray-300 rounded-md box max-w-5 bg-brand-500 dark:bg-brand-400"
                    >
                      <span>
                        <svg
                          width="14"
                          height="14"
                          viewBox="0 0 14 14"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M11.6668 3.5L5.25016 9.91667L2.3335 7"
                            stroke="white"
                            stroke-width="1.94437"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </span>
                    </div>
                    <p
                      class="-mt-0.5 text-base text-gray-800 dark:text-white/90"
                    >
                      {{ task.title }}
                    </p>
                  </div>
                </label>
              </div>

              <div
                class="flex flex-col-reverse items-start justify-end w-full gap-3 xl:flex-row xl:items-center xl:gap-5"
              >
                <div class="flex items-center gap-2">
                  <span
                    class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-theme-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400"
                  >
                    Preuve requise
                  </span>
                  {% if task.proofs|length > 0 %}
                  <button
                    @click="showProofHistory({{ task.id }}, {{ task.proofs|json_encode|raw }})"
                    class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-theme-xs font-medium text-gray-700 hover:bg-gray-200 dark:bg-white/[0.03] dark:text-white/80 dark:hover:bg-white/[0.05]"
                    title="Voir l'historique des preuves"
                  >
                    <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8 1C4.134 1 1 4.134 1 8s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12.5c-3.032 0-5.5-2.468-5.5-5.5S4.968 2.5 8 2.5 13.5 4.968 13.5 8 11.032 13.5 8 13.5z" fill=""/>
                      <path d="M8 4.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm0 6a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill=""/>
                    </svg>
                    {{ task.proofs|length }}
                  </button>
                  {% endif %}
                </div>

                <div
                  class="flex items-center justify-between w-full gap-5 xl:w-auto xl:justify-normal"
                >
                  <div class="flex items-center gap-3">
                    {% if task.dueDate %}
                    <span
                      class="flex items-center gap-1 text-sm text-gray-500 cursor-pointer dark:text-gray-400"
                    >
                      <svg
                        class="fill-current"
                        width="16"
                        height="16"
                        viewBox="0 0 16 16"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM5.33329 3.75016L3.66663 3.75016C3.52855 3.75016 3.41663 3.86209 3.41663 4.00016V5.25016L12.5833 5.25016V4.00016C12.5833 3.86209 12.4714 3.75016 12.3333 3.75016L10.6666 3.75016L5.33329 3.75016ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z"
                          fill=""
                        />
                      </svg>
                      {{ task.dueDate|date('d/m/Y') }}
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune tâche</p>
          </div>
          {% endfor %}
        </div>

        <!-- Completed list -->
        <div class="flex flex-col gap-4 swim-lane">
          <div class="flex items-center justify-between mb-2">
            <h3
              class="flex items-center gap-3 text-base font-medium text-gray-800 dark:text-white/90"
            >
              Completed
              <span
                class="inline-flex rounded-full bg-success-50 px-2 py-0.5 text-theme-xs font-medium text-success-500 dark:bg-success-500/15 dark:text-success-400"
              >
                {{ tasks.completed|length }}
              </span>
            </h3>
          </div>

          {% for task in tasks.completed %}
          <!-- task item -->
          <div
            draggable="true"
            class="p-5 bg-white border border-gray-200 task rounded-xl shadow-theme-sm dark:border-gray-800 dark:bg-white/5 opacity-75"
          >
            <div
              class="flex flex-col gap-5 xl:flex-row xl:items-center xl:justify-between"
            >
              <div class="flex items-start w-full gap-4">
                <span class="text-gray-400">
                  <svg
                    class="fill-current"
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M2.43311 5.0001C2.43311 4.50304 2.83605 4.1001 3.33311 4.1001L16.6664 4.1001C17.1635 4.1001 17.5664 4.50304 17.5664 5.0001C17.5664 5.49715 17.1635 5.9001 16.6664 5.9001L3.33311 5.9001C2.83605 5.9001 2.43311 5.49716 2.43311 5.0001ZM2.43311 15.0001C2.43311 14.503 2.83605 14.1001 3.33311 14.1001L16.6664 14.1001C17.1635 14.1001 17.5664 14.503 17.5664 15.0001C17.5664 15.4972 17.1635 15.9001 16.6664 15.9001L3.33311 15.9001C2.83605 15.9001 2.43311 15.4972 2.43311 15.0001ZM3.33311 9.1001C2.83605 9.1001 2.43311 9.50304 2.43311 10.0001C2.43311 10.4972 2.83605 10.9001 3.33311 10.9001L16.6664 10.9001C17.1635 10.9001 17.5664 10.4972 17.5664 10.0001C17.5664 9.50304 17.1635 9.1001 16.6664 9.1001L3.33311 9.1001Z"
                      fill=""
                    />
                  </svg>
                </span>

                <label
                  for="taskCheckbox{{ task.id }}"
                  class="w-full cursor-pointer"
                >
                  <div class="relative flex items-start">
                    <input
                      type="checkbox"
                      id="taskCheckbox{{ task.id }}"
                      class="sr-only taskCheckbox"
                      data-task-id="{{ task.id }}"
                      checked
                      @change="openProofModal($event, {{ task.id }}, '{{ task.title|escape('js') }}')"
                    />
                    <div
                      class="flex items-center justify-center w-full h-5 mr-3 border border-gray-300 rounded-md box max-w-5 bg-success-500 dark:bg-success-400"
                    >
                      <span>
                        <svg
                          width="14"
                          height="14"
                          viewBox="0 0 14 14"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M11.6668 3.5L5.25016 9.91667L2.3335 7"
                            stroke="white"
                            stroke-width="1.94437"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </span>
                    </div>
                    <p
                      class="-mt-0.5 text-base text-gray-800 dark:text-white/90 line-through"
                    >
                      {{ task.title }}
                    </p>
                  </div>
                </label>
              </div>

              <div
                class="flex flex-col-reverse items-start justify-end w-full gap-3 xl:flex-row xl:items-center xl:gap-5"
              >
                <div class="flex items-center gap-2">
                  <span
                    class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-theme-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400"
                  >
                    Preuve requise
                  </span>
                  {% if task.proofs|length > 0 %}
                  <button
                    @click="showProofHistory({{ task.id }}, {{ task.proofs|json_encode|raw }})"
                    class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-theme-xs font-medium text-gray-700 hover:bg-gray-200 dark:bg-white/[0.03] dark:text-white/80 dark:hover:bg-white/[0.05]"
                    title="Voir l'historique des preuves"
                  >
                    <svg class="fill-current" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8 1C4.134 1 1 4.134 1 8s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12.5c-3.032 0-5.5-2.468-5.5-5.5S4.968 2.5 8 2.5 13.5 4.968 13.5 8 11.032 13.5 8 13.5z" fill=""/>
                      <path d="M8 4.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm0 6a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill=""/>
                    </svg>
                    {{ task.proofs|length }}
                  </button>
                  {% endif %}
                </div>

                <div
                  class="flex items-center justify-between w-full gap-5 xl:w-auto xl:justify-normal"
                >
                  <div class="flex items-center gap-3">
                    {% if task.dueDate %}
                    <span
                      class="flex items-center gap-1 text-sm text-gray-500 cursor-pointer dark:text-gray-400"
                    >
                      <svg
                        class="fill-current"
                        width="16"
                        height="16"
                        viewBox="0 0 16 16"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M5.33329 1.0835C5.74751 1.0835 6.08329 1.41928 6.08329 1.8335V2.25016L9.91663 2.25016V1.8335C9.91663 1.41928 10.2524 1.0835 10.6666 1.0835C11.0808 1.0835 11.4166 1.41928 11.4166 1.8335V2.25016L12.3333 2.25016C13.2998 2.25016 14.0833 3.03366 14.0833 4.00016V12.6668C14.0833 13.6333 13.2998 14.4168 12.3333 14.4168L3.66663 14.4168C2.70013 14.4168 1.91663 13.6333 1.91663 12.6668V4.00016C1.91663 3.03366 2.70013 2.25016 3.66663 2.25016L4.58329 2.25016V1.8335C4.58329 1.41928 4.91908 1.0835 5.33329 1.0835ZM5.33329 3.75016L3.66663 3.75016C3.52855 3.75016 3.41663 3.86209 3.41663 4.00016V5.25016L12.5833 5.25016V4.00016C12.5833 3.86209 12.4714 3.75016 12.3333 3.75016L10.6666 3.75016L5.33329 3.75016ZM12.5833 6.75016L3.41663 6.75016L3.41663 12.6668C3.41663 12.8049 3.52855 12.9168 3.66663 12.9168L12.3333 12.9168C12.4714 12.9168 12.5833 12.8049 12.5833 12.6668L12.5833 6.75016Z"
                          fill=""
                        />
                      </svg>
                      {{ task.dueDate|date('d/m/Y') }}
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="p-5 bg-gray-50 border border-gray-200 rounded-xl dark:bg-white/[0.02] dark:border-gray-800 text-center">
            <p class="text-sm text-gray-400 dark:text-gray-500">Aucune tâche</p>
          </div>
          {% endfor %}
        </div>
      </div>
      <!-- Task wrapper End -->
    </div>

    <!-- Comments Section -->
    {% if comments|length > 0 %}
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] mt-6">
      <div class="p-4 xl:p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90 mb-4">Commentaires ({{ comments|length }})</h3>
        <div class="space-y-4">
          {% for comment in comments %}
          <div class="p-4 bg-gray-50 rounded-lg dark:bg-white/[0.02] border border-gray-200 dark:border-gray-800">
            <div class="flex items-start justify-between mb-2">
              <div>
                <p class="text-sm font-medium text-gray-800 dark:text-white/90">
                  {% if comment.author %}
                    {{ comment.author.firstName }} {{ comment.author.lastName }}
                  {% else %}
                    Anonyme
                  {% endif %}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  {% if comment.createdAt %}
                    {{ comment.createdAt|date('d/m/Y \\à H:i') }}
                  {% endif %}
                </p>
              </div>
              <span class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400">
                {{ comment.authorType|capitalize }}
              </span>
            </div>
            <p class="text-base text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{{ comment.content }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Proof Modal -->
  <div
    x-show="proofModalOpen"
  @click.away="proofModalOpen = false"
  x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
>
  <div
    @click.stop
    class="w-full max-w-2xl rounded-2xl border border-gray-200 bg-white shadow-theme-lg dark:border-gray-800 dark:bg-gray-900 mx-4"
  >
    <!-- Modal Header -->
    <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4 dark:border-gray-800">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
        Ajouter une preuve
      </h3>
      <button
        @click="proofModalOpen = false"
        class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="p-6">
      <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        Tâche : <span class="font-medium text-gray-800 dark:text-white/90" x-text="currentTaskTitle"></span>
      </p>

      <form @submit.prevent="submitProof()" class="space-y-4">
        <!-- Proof Type -->
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Type de preuve <span class="text-error-500">*</span>
          </label>
          <select
            x-model="proofFormData.type"
            @change="proofFormData.fileBase64 = null; proofFormData.content = null"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          >
            <option value="text">Texte</option>
            <option value="photo">Photo</option>
            <option value="image">Image</option>
          </select>
        </div>

        <!-- Title -->
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Titre <span class="text-error-500">*</span>
          </label>
          <input
            type="text"
            x-model="proofFormData.title"
            required
            placeholder="Titre de la preuve"
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          />
        </div>

        <!-- Description -->
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Description
          </label>
          <textarea
            x-model="proofFormData.description"
            rows="3"
            placeholder="Description de la preuve"
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          ></textarea>
        </div>

        <!-- Content (Text) -->
        <div x-show="proofFormData.type === 'text'">
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Contenu <span class="text-error-500">*</span>
          </label>
          <textarea
            x-model="proofFormData.content"
            rows="5"
            required
            placeholder="Contenu de la preuve"
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          ></textarea>
        </div>

        <!-- File Upload (Photo/Image) -->
        <div x-show="proofFormData.type === 'photo' || proofFormData.type === 'image'">
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Fichier <span class="text-error-500">*</span>
          </label>
          <input
            type="file"
            accept="image/*"
            @change="handleFileSelect($event)"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          />
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Formats acceptés : JPG, PNG, GIF
          </p>
          <div x-show="proofFormData.filePreview" class="mt-3">
            <img
              :src="proofFormData.filePreview"
              alt="Preview"
              class="max-h-48 rounded-lg border border-gray-200 dark:border-gray-700"
            />
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex gap-3 pt-4">
          <button
            type="button"
            @click="proofModalOpen = false"
            class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
          >
            Annuler
          </button>
          <button
            type="submit"
            :disabled="proofSubmitting"
            class="flex-1 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50"
          >
            <span x-show="!proofSubmitting">Envoyer la preuve</span>
            <span x-show="proofSubmitting">Envoi en cours...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Proof History Modal -->
  <div
    x-show="proofHistoryModalOpen"
    @click.away="proofHistoryModalOpen = false"
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
  >
    <div
      @click.stop
      class="w-full max-w-3xl rounded-2xl border border-gray-200 bg-white shadow-theme-lg dark:border-gray-800 dark:bg-gray-900 mx-4 max-h-[90vh] overflow-hidden flex flex-col"
    >
      <!-- Modal Header -->
      <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4 dark:border-gray-800">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
          Historique des preuves
        </h3>
        <button
          @click="proofHistoryModalOpen = false"
          class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="flex-1 overflow-y-auto p-6">
        <template x-if="currentTaskProofs.length === 0">
          <div class="text-center py-8">
            <p class="text-gray-500 dark:text-gray-400">Aucune preuve enregistrée</p>
          </div>
        </template>
        
        <div class="space-y-4" x-show="currentTaskProofs.length > 0">
          <template x-for="(proof, index) in currentTaskProofs" :key="index">
            <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-800 dark:bg-white/[0.02]">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <h4 class="text-base font-semibold text-gray-800 dark:text-white/90" x-text="proof.title"></h4>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="formatDate(proof.createdAt)"></p>
                </div>
                <span class="inline-flex rounded-full bg-brand-50 px-2 py-0.5 text-xs font-medium text-brand-500 dark:bg-brand-500/15 dark:text-brand-400" x-text="proof.type"></span>
              </div>
              
              <template x-if="proof.description">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="proof.description"></p>
              </template>
              
              <template x-if="proof.type === 'text' && proof.content">
                <div class="bg-white rounded-lg p-3 mb-3 dark:bg-gray-800">
                  <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="proof.content"></p>
                </div>
              </template>
              
              <template x-if="(proof.type === 'photo' || proof.type === 'image') && proof.fileUrl">
                <div class="mb-3">
                  <img
                    :src="proof.fileUrl"
                    :alt="proof.fileName || 'Preuve'"
                    class="max-w-full h-auto rounded-lg border border-gray-200 dark:border-gray-700"
                    @error="$el.src = '/tailadmin/src/images/default-image.png'"
                  />
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="proof.fileName"></p>
                </div>
              </template>
              
              <template x-if="proof.submittedBy">
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  Soumis par : <span x-text="proof.submittedBy.firstName + ' ' + proof.submittedBy.lastName"></span>
                </p>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="border-t border-gray-200 px-6 py-4 dark:border-gray-800">
        <button
          @click="proofHistoryModalOpen = false"
          class="w-full rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>
</main>
<!-- ===== Main Content End ===== -->

<script>
function taskManager() {
  return {
    proofModalOpen: false,
    proofHistoryModalOpen: false,
    currentTaskId: null,
    currentTaskTitle: '',
    currentTaskProofs: [],
    proofSubmitting: false,
    proofFormData: {
      type: 'text',
      title: '',
      description: '',
      content: '',
      fileBase64: null,
      fileName: null,
      fileSize: null,
      mimeType: null,
      filePreview: null,
    },
    
    openProofModal(event, taskId, taskTitle) {
      console.log('openProofModal appelé', { taskId, taskTitle, checked: event.target.checked });
      const checkbox = event.target;
      const isChecked = checkbox.checked;
      
      if (isChecked) {
        // Ouvrir le modal pour ajouter une preuve
        console.log('Ouverture du modal de preuve');
        this.currentTaskId = taskId;
        this.currentTaskTitle = taskTitle;
        this.proofModalOpen = true;
        // Réinitialiser le formulaire
        this.proofFormData = {
          type: 'text',
          title: '',
          description: '',
          content: '',
          fileBase64: null,
          fileName: null,
          fileSize: null,
          mimeType: null,
          filePreview: null,
        };
      } else {
        // Décocher sans action (la tâche reste completed jusqu'à la réinitialisation par période)
        console.log('Décocher sans action');
      }
    },
    
    handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Vérifier le type
      if (!file.type.startsWith('image/')) {
        if (window.showToast) {
          window.showToast('Veuillez sélectionner un fichier image', 'error');
        } else {
          alert('Veuillez sélectionner un fichier image');
        }
        event.target.value = '';
        return;
      }
      
      // Vérifier la taille (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        if (window.showToast) {
          window.showToast('Le fichier est trop volumineux (max 5MB)', 'error');
        } else {
          alert('Le fichier est trop volumineux (max 5MB)');
        }
        event.target.value = '';
        return;
      }
      
      // Lire le fichier en base64
      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result;
        this.proofFormData.fileBase64 = base64.split(',')[1]; // Retirer le préfixe data:image/...
        this.proofFormData.fileName = file.name;
        this.proofFormData.fileSize = file.size;
        this.proofFormData.mimeType = file.type;
        this.proofFormData.filePreview = base64;
      };
      reader.readAsDataURL(file);
    },
    
    async submitProof() {
      if (!this.currentTaskId) return;
      
      this.proofSubmitting = true;
      
      try {
        // Préparer les données
        const data = {
          type: this.proofFormData.type,
          title: this.proofFormData.title,
          description: this.proofFormData.description || null,
        };
        
        if (this.proofFormData.type === 'text') {
          data.content = this.proofFormData.content;
        } else if (this.proofFormData.fileBase64) {
          data.fileBase64 = this.proofFormData.fileBase64;
          data.fileName = this.proofFormData.fileName;
          data.fileSize = this.proofFormData.fileSize;
          data.mimeType = this.proofFormData.mimeType;
        }
        
        // Envoyer la preuve
        const response = await fetch(`/admin/tasks/${this.currentTaskId}/proofs/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        const result = await response.json().catch(() => ({ success: false, message: 'Erreur lors de l\'envoi' }));
        
        if (response.ok && result.success) {
          // Afficher un message de succès
          if (window.showToast) {
            window.showToast(result.message || 'Preuve envoyée avec succès', 'success');
          } else {
            alert(result.message || 'Preuve envoyée avec succès');
          }
          
          // Fermer le modal
          this.proofModalOpen = false;
          
          // Recharger la page pour mettre à jour l'affichage
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          // Afficher un message d'erreur
          const errorMessage = result.message || 'Erreur lors de l\'envoi de la preuve';
          if (window.showToast) {
            window.showToast(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
        }
      } catch (error) {
        console.error('Erreur lors de l\'envoi de la preuve:', error);
        if (window.showToast) {
          window.showToast('Une erreur est survenue', 'error');
        } else {
          alert('Une erreur est survenue');
        }
      } finally {
        this.proofSubmitting = false;
      }
    },
    
    showProofHistory(taskId, proofs) {
      this.currentTaskId = taskId;
      this.currentTaskProofs = proofs || [];
      this.proofHistoryModalOpen = true;
    },
    
    formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    },
  };
}
</script>
{% endblock %}
