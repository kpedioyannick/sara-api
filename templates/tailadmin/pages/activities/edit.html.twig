{% extends 'tailadmin/layouts/base.html.twig' %}

{% block stylesheets %}
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div 
    x-data="activityEditManager()"
    data-activity='{{ activity|json_encode|e('html_attr') }}'
    data-categories='{{ categories|json_encode|e('html_attr') }}'
    class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6"
>
    {% include 'tailadmin/components/breadcrumb.html.twig' %}

    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
        <div class="px-6 py-5 border-b border-gray-100 dark:border-gray-800">
            <div class="flex items-center justify-between">
                <h3 class="text-base font-medium text-gray-800 dark:text-white/90">Modifier l'activité</h3>
                <a href="{{ path('admin_activities_detail', {id: activity.id}) }}" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03]">
                    <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 16.7071C9.31658 17.0976 8.68342 17.0976 8.29289 16.7071L2.29289 10.7071C1.90237 10.3166 1.90237 9.68342 2.29289 9.29289L8.29289 3.29289C8.68342 2.90237 9.31658 2.90237 9.70711 3.29289C10.0976 3.68342 10.0976 4.31658 9.70711 4.70711L5.41421 9H17C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11H5.41421L9.70711 15.2929C10.0976 15.6834 10.0976 16.3166 9.70711 16.7071Z" fill=""/>
                    </svg>
                    Retour
                </a>
            </div>
        </div>

        <form @submit.prevent="updateActivity()" class="p-6 space-y-6">
            <!-- Titre -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Titre <span class="text-error-500">*</span>
                </label>
                <input
                    type="text"
                    x-model="editForm.title"
                    required
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                    placeholder="Titre de l'activité"
                />
            </div>

            <!-- Description avec éditeur WYSIWYG -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Description <span class="text-error-500">*</span>
                </label>
                <div 
                    x-ref="descriptionEditor"
                    class="min-h-[400px] rounded-lg border border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800"
                ></div>
                <input type="hidden" x-model="editForm.description" id="description-hidden">
            </div>

            <!-- Durée -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Durée <span class="text-error-500">*</span>
                </label>
                <select
                    x-model="editForm.duration"
                    required
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                >
                    <option value="">Sélectionner une durée</option>
                    <option value="15 minutes">15 minutes</option>
                    <option value="30 minutes">30 minutes</option>
                    <option value="45 minutes">45 minutes</option>
                    <option value="1 heure">1 heure</option>
                    <option value="1h30">1h30</option>
                    <option value="2 heures">2 heures</option>
                    <option value="15-30 minutes">15-30 minutes</option>
                    <option value="30-45 minutes">30-45 minutes</option>
                    <option value="45-60 minutes">45-60 minutes</option>
                </select>
            </div>

            <!-- Tranche d'âges -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Tranche d'âges <span class="text-error-500">*</span>
                </label>
                <select
                    x-model="editForm.ageRange"
                    required
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                >
                    <option value="">Sélectionner une tranche d'âges</option>
                    <option value="3-5 ans">3-5 ans</option>
                    <option value="6-8 ans">6-8 ans</option>
                    <option value="9-11 ans">9-11 ans</option>
                    <option value="12-14 ans">12-14 ans</option>
                    <option value="15-17 ans">15-17 ans</option>
                    <option value="18+ ans">18+ ans</option>
                    <option value="Tous âges">Tous âges</option>
                </select>
            </div>

            <!-- Type -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Type <span class="text-error-500">*</span>
                </label>
                <select
                    x-model="editForm.type"
                    required
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                >
                    <option value="">Sélectionner un type</option>
                    <option value="individual">Individuel</option>
                    <option value="with_adult">Avec un adulte</option>
                </select>
            </div>

            <!-- Catégorie -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Catégorie <span class="text-error-500">*</span>
                </label>
                <select
                    x-model="editForm.categoryId"
                    required
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                >
                    <option value="">Sélectionner une catégorie</option>
                    <template x-for="category in categories" :key="category.id">
                        <option :value="category.id" x-text="category.name"></option>
                    </template>
                </select>
            </div>

            <!-- Objectifs -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Objectifs
                </label>
                <div class="space-y-2">
                    <template x-for="(objective, index) in (editForm.objectives || [])" :key="index">
                        <div class="flex gap-2">
                            <input
                                type="text"
                                x-model="editForm.objectives[index]"
                                class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                                placeholder="Objectif"
                            />
                            <button
                                type="button"
                                @click="editForm.objectives.splice(index, 1)"
                                class="rounded-lg border border-error-500 bg-error-50 px-3 py-2 text-sm text-error-600 hover:bg-error-100 dark:border-error-400 dark:bg-error-900/30 dark:text-error-400"
                            >
                                Supprimer
                            </button>
                        </div>
                    </template>
                    <button
                        type="button"
                        @click="editForm.objectives = editForm.objectives || []; editForm.objectives.push('')"
                        class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300"
                    >
                        + Ajouter un objectif
                    </button>
                </div>
            </div>

            <!-- Points travaillés -->
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Points travaillés
                </label>
                <div class="space-y-2">
                    <template x-for="(point, index) in (editForm.workedPoints || [])" :key="index">
                        <div class="flex gap-2">
                            <input
                                type="text"
                                x-model="editForm.workedPoints[index]"
                                class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                                placeholder="Point travaillé"
                            />
                            <button
                                type="button"
                                @click="editForm.workedPoints.splice(index, 1)"
                                class="rounded-lg border border-error-500 bg-error-50 px-3 py-2 text-sm text-error-600 hover:bg-error-100 dark:border-error-400 dark:bg-error-900/30 dark:text-error-400"
                            >
                                Supprimer
                            </button>
                        </div>
                    </template>
                    <button
                        type="button"
                        @click="editForm.workedPoints = editForm.workedPoints || []; editForm.workedPoints.push('')"
                        class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300"
                    >
                        + Ajouter un point travaillé
                    </button>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex gap-3 justify-end pt-4 border-t border-gray-200 dark:border-gray-800">
                <a href="{{ path('admin_activities_detail', {id: activity.id}) }}" class="rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700">
                    Annuler
                </a>
                <button
                    type="submit"
                    :disabled="saving"
                    class="rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span x-show="!saving">Enregistrer</span>
                    <span x-show="saving">Enregistrement...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function activityEditManager() {
    return {
        activity: {},
        categories: [],
        editForm: {},
        quillEditor: null,
        quillLoaded: false,
        saving: false,
        
        init() {
            // Initialiser les données depuis les attributs data
            this.activity = JSON.parse(this.$el.dataset.activity || '{}');
            this.categories = JSON.parse(this.$el.dataset.categories || '[]');
            this.editForm = { ...this.activity };
            
            // Convertir category en categoryId si nécessaire
            if (this.editForm.category && this.editForm.category.id) {
                this.editForm.categoryId = this.editForm.category.id;
            }
            
            // Charger Quill.js si pas déjà chargé
            if (typeof Quill === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.quilljs.com/1.3.6/quill.js';
                script.onload = () => {
                    this.quillLoaded = true;
                    this.$nextTick(() => {
                        this.initQuillEditor();
                    });
                };
                document.head.appendChild(script);
            } else {
                this.quillLoaded = true;
                this.$nextTick(() => {
                    this.initQuillEditor();
                });
            }
        },
        
        initQuillEditor() {
            const editorElement = this.$refs.descriptionEditor;
            if (!editorElement) {
                return;
            }
            
            if (typeof Quill === 'undefined') {
                console.error('Quill.js n\'est pas chargé');
                return;
            }
            
            this.quillEditor = new Quill(editorElement, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'direction': 'rtl' }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['link', 'image', 'video'],
                        ['clean']
                    ]
                },
                placeholder: 'Rédigez la description de l\'activité...'
            });
            
            // Charger le contenu initial
            if (this.editForm.description) {
                this.quillEditor.root.innerHTML = this.editForm.description;
            }
            
            // Mettre à jour editForm.description quand le contenu change
            this.quillEditor.on('text-change', () => {
                this.editForm.description = this.quillEditor.root.innerHTML;
            });
        },
        
        async updateActivity() {
            // Récupérer le contenu HTML de l'éditeur Quill
            if (this.quillEditor) {
                this.editForm.description = this.quillEditor.root.innerHTML;
            }
            
            this.saving = true;
            try {
                const formData = new FormData();
                formData.append('data', JSON.stringify(this.editForm));
                
                const response = await fetch(`/admin/activities/${this.activity.id}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.editForm),
                });
                
                if (response.redirected) {
                    // Si redirection, suivre la redirection
                    window.location.href = response.url;
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (window.showToast) {
                        window.showToast('Activité mise à jour avec succès', 'success');
                    }
                    window.location.href = `/admin/activities/${this.activity.id}`;
                } else {
                    if (window.showToast) {
                        window.showToast(result.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                if (window.showToast) {
                    window.showToast('Erreur lors de la mise à jour', 'error');
                }
            } finally {
                this.saving = false;
            }
        }
    };
}
</script>
{% endblock %}

