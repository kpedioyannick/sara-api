<div class="flex h-full flex-col" x-data="planningEventManager()">
  <!-- Header -->
  <div class="sticky top-0 z-10 border-b border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
        <span x-show="!isEdit && !isView">Nouvel Événement</span>
        <span x-show="isEdit && !isView">Modifier Événement</span>
        <span x-show="isView">Détails de l'Événement</span>
      </h3>
      <button
        @click="closeSheet()"
        class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-800 dark:hover:text-gray-300"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">
    <!-- Mode lecture (view) -->
    <div x-show="isView" class="space-y-6">
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Titre</label>
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="viewData.title || 'N/A'"></span>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90 min-h-[60px]">
          <span x-text="viewData.description || 'Aucune description'"></span>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="viewData.type || 'N/A'"></span>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Statut</label>
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="viewData.status || 'N/A'"></span>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Élève</label>
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="viewData.studentName || 'N/A'"></span>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="viewData.date || 'N/A'"></span>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Heure de début</label>
          <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
            <span x-text="viewData.startTime || 'N/A'"></span>
          </div>
        </div>
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Heure de fin</label>
          <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
            <span x-text="viewData.endTime || 'N/A'"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Mode édition/création -->
    <form x-show="!isView" @submit.prevent="saveEvent()" class="space-y-6">
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Pour *</label>
        {% if app.user.isStudent() %}
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span>Élève</span>
        </div>
        {% else %}
        <select
          x-model="formData.userType"
          @change="onUserTypeChange()"
          required
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        >
          <option value="">Sélectionner un type...</option>
          {% if app.user.isCoach() %}
          <option value="coach">Moi (Coach)</option>
          <option value="student">Élève</option>
          <option value="specialist">Spécialiste</option>
          {% elseif app.user.isParent() %}
          <option value="parent">Moi</option>
          <option value="student">Élève</option>
          {% elseif app.user.isSpecialist() %}
          <option value="specialist">Moi</option>
          <option value="student">Élève</option>
          {% else %}
          <option value="student">Élève</option>
          {% endif %}
        </select>
        {% endif %}
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Titre *</label>
        <div class="space-y-2">
          <select
            x-model="formData.title"
            @change="handleTitleChange($event.target.value)"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          >
            <option value="">Sélectionner un titre...</option>
            {% if app.user.isCoach() or app.user.isSpecialist() %}
            <optgroup label="Disponibilités">
              <option value="Disponibilité pour échanger">Disponibilité pour échanger</option>
              <option value="Disponibilité pour venir sur site">Disponibilité pour venir sur site</option>
              <option value="Disponibilité pour aider à distance">Disponibilité pour aider à distance</option>
            </optgroup>
            {% elseif app.user.isParent() %}
            <optgroup label="Disponibilités">
              <option value="Disponibilité pour échanger">Disponibilité pour échanger</option>
            </optgroup>
            {% endif %}
            <optgroup label="Matières">
              <option value="Français">Français</option>
              <option value="Mathématiques">Mathématiques</option>
              <option value="Histoire">Histoire</option>
              <option value="Géographie">Géographie</option>
              <option value="Sciences">Sciences</option>
              <option value="Physique-Chimie">Physique-Chimie</option>
              <option value="SVT">SVT</option>
              <option value="Anglais">Anglais</option>
              <option value="Espagnol">Espagnol</option>
              <option value="Allemand">Allemand</option>
              <option value="Arts plastiques">Arts plastiques</option>
              <option value="Musique">Musique</option>
              <option value="EPS">EPS</option>
              <option value="Technologie">Technologie</option>
            </optgroup>
            <option value="custom">+ Ajouter un titre personnalisé</option>
          </select>
          <input
            type="text"
            x-model="formData.title"
            x-show="showCustomTitle"
            x-cloak
            placeholder="Entrez le nom de la matière"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          />
        </div>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
        <textarea
          x-model="formData.description"
          rows="3"
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        ></textarea>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Type *</label>
        <select
          x-model="formData.type"
          required
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        >
          <option value="">Sélectionner...</option>
          <optgroup label="Disponibilités">
            <option value="availability_exchange">Disponibilité - Échange</option>
            <option value="availability_activity">Disponibilité - Activités</option>
          </optgroup>
          <optgroup label="Événements scolaires">
            <option value="homework">Devoir</option>
            <option value="revision">Révision</option>
            <option value="task">Tâche</option>
            <option value="assessment">Évaluation</option>
            <option value="course">Cours</option>
            <option value="training">Formation</option>
            <option value="activity">Activité</option>
            <option value="detention">Retenue</option>
            <option value="exam">Examen</option>
            <option value="objective">Objectif</option>
          </optgroup>
          <option value="other">Autre</option>
        </select>
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Statut *</label>
        <select
          x-model="formData.status"
          required
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        >
          <option value="scheduled">Planifié</option>
          <option value="in_progress">En cours</option>
          <option value="to_do">À faire</option>
          <option value="completed">Terminé</option>
        </select>
      </div>
      <div x-show="formData.userType === 'student'{% if app.user.isStudent() %} || true{% endif %}">
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Élève *</label>
        {% if app.user.isStudent() %}
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="window.planningManagerData?.studentsData?.find(s => s.id == window.planningManagerData?.currentUserId) ? (window.planningManagerData.studentsData.find(s => s.id == window.planningManagerData.currentUserId).firstName + ' ' + window.planningManagerData.studentsData.find(s => s.id == window.planningManagerData.currentUserId).lastName) : 'Moi'"></span>
        </div>
        {% else %}
        <select
          x-model="formData.userId"
          :required="formData.userType === 'student'"
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        >
          <option value="">Sélectionner un élève...</option>
          <template x-for="student in (window.planningManagerData?.studentsData || [])" :key="student.id">
            <option :value="student.id" x-text="student.firstName + ' ' + student.lastName"></option>
          </template>
        </select>
        {% endif %}
      </div>
      <div x-show="formData.userType === 'specialist'">
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Spécialiste *</label>
        {% if app.user.isSpecialist() %}
        <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
          <span x-text="window.planningManagerData?.specialistsData?.find(s => s.id == window.planningManagerData?.currentUserId) ? (window.planningManagerData.specialistsData.find(s => s.id == window.planningManagerData.currentUserId).firstName + ' ' + window.planningManagerData.specialistsData.find(s => s.id == window.planningManagerData.currentUserId).lastName) : 'Moi'"></span>
        </div>
        {% else %}
        <select
          x-model="formData.userId"
          :required="formData.userType === 'specialist'"
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        >
          <option value="">Sélectionner un spécialiste...</option>
          <template x-for="specialist in (window.planningManagerData?.specialistsData || [])" :key="specialist.id">
            <option :value="specialist.id" x-text="specialist.firstName + ' ' + specialist.lastName"></option>
          </template>
        </select>
        {% endif %}
      </div>
      <div>
        <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Date *</label>
        <input
          type="date"
          x-model="formData.date"
          @change="updateDateTime()"
          required
          class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
        />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Heure de début *</label>
          <input
            type="time"
            x-model="formData.startTime"
            @change="updateDateTime()"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          />
        </div>
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Heure de fin *</label>
          <input
            type="time"
            x-model="formData.endTime"
            @change="updateDateTime()"
            required
            class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm text-gray-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
          />
        </div>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <div class="sticky bottom-0 border-t border-gray-200 bg-white px-6 py-4 dark:border-gray-800 dark:bg-gray-900">
    <!-- Mode lecture -->
    <div x-show="isView" class="flex gap-3">
      <button
        @click="closeSheet()"
        class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
      >
        Fermer
      </button>
      <button
        @click="openEdit(viewData.id, viewData.title, viewData.startDate, viewData.endDate, viewData.userId, viewData.type, viewData.status)"
        class="flex-1 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600"
      >
        Modifier
      </button>
    </div>
    <!-- Mode édition/création -->
    <div x-show="!isView" class="flex gap-3">
      <button
        @click="closeSheet()"
        class="flex-1 rounded-lg border border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
      >
        Annuler
      </button>
      <button
        @click="saveEvent()"
        class="flex-1 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600"
      >
        Enregistrer
      </button>
    </div>
  </div>
</div>

<script>
// Fonction Alpine.js pour gérer le rightsheet des événements Planning
window.planningEventManager = function() {
  return {
    isEdit: {{ isEdit|default(false)|json_encode|raw }},
    isView: {{ isView|default(false)|json_encode|raw }},
    currentId: {{ currentId|default(null)|json_encode|raw }},
    showCustomTitle: false,
    viewData: {{ viewData|default({})|json_encode|raw }},
    formData: {{ formData|default({})|json_encode|raw }},
    coachData: window.planningManagerData?.coachData || null,
    parentData: window.planningManagerData?.parentData || null,
    currentUserType: window.planningManagerData?.currentUserType || '',
    currentUserId: window.planningManagerData?.currentUserId || null,
    
    handleTitleChange(value) {
      this.showCustomTitle = value === 'custom';
      if (value !== 'custom') {
        this.formData.title = value;
      } else {
        this.formData.title = '';
      }
    },
    
    onUserTypeChange() {
      this.formData.userId = '';
      if (this.formData.userType === 'specialist' && this.currentUserType === 'specialist' && this.currentUserId) {
        this.formData.userId = this.currentUserId;
      }
    },
    
    updateDateTime() {
      if (this.formData.date && this.formData.startTime && this.formData.endTime) {
        const dateTimeStart = new Date(this.formData.date + 'T' + this.formData.startTime);
        const dateTimeEnd = new Date(this.formData.date + 'T' + this.formData.endTime);
        this.formData.startDate = dateTimeStart.toISOString();
        this.formData.endDate = dateTimeEnd.toISOString();
      }
    },
    
    closeSheet() {
      // Dispatcher un événement pour fermer le rightsheet depuis le parent
      document.dispatchEvent(new CustomEvent('close-planning-rightsheet'));
    },
    
    async saveEvent() {
      this.updateDateTime();
      
      if (!this.formData.title || this.formData.title.trim() === '') {
        if (window.planningManagerData?.showMessage) {
          window.planningManagerData.showMessage('Veuillez sélectionner ou entrer un titre', 'error');
        }
        return;
      }
      
      const url = this.isEdit 
        ? `/admin/planning/${this.currentId}/update`
        : '/admin/planning/create';
      
      let userId = this.formData.userId;
      if (this.formData.userType === 'coach' && this.coachData) {
        userId = this.coachData.id;
      } else if (this.formData.userType === 'parent' && this.parentData) {
        userId = this.parentData.id;
      }
      
      const data = {
        title: this.formData.title,
        description: this.formData.description || '',
        type: this.formData.type,
        status: this.formData.status,
        userId: userId,
        startDate: this.formData.startDate,
        endDate: this.formData.endDate,
      };
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify(data),
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (window.planningManagerData?.showMessage) {
            window.planningManagerData.showMessage(result.message || 'Événement enregistré avec succès', 'success');
          }
          // Recharger le contenu du rightsheet en mode view
          if (this.isEdit && this.currentId) {
            // Recharger en mode view après modification
            this.reloadRightSheet('view', this.currentId);
          } else if (!this.isEdit && result.id) {
            // Recharger en mode view après création
            this.reloadRightSheet('view', result.id);
          }
        } else {
          if (window.planningManagerData?.showMessage) {
            window.planningManagerData.showMessage(result.message || 'Erreur lors de l\'enregistrement', 'error');
          }
        }
      } catch (error) {
        console.error('Erreur:', error);
        if (window.planningManagerData?.showMessage) {
          window.planningManagerData.showMessage('Erreur de connexion', 'error');
        }
      }
    },
    
    openEdit(id, title, startDate, endDate, userId, type, status) {
      // Dispatcher un événement pour ouvrir en mode édition depuis le parent
      document.dispatchEvent(new CustomEvent('open-planning-edit', {
        detail: { id, title, startDate, endDate, userId, type, status }
      }));
    },
    
    async reloadRightSheet(mode, id) {
      try {
        const url = `/admin/planning/event-sheet?mode=${mode}&id=${id}`;
        
        const response = await fetch(url, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          }
        });
        
        if (!response.ok) {
          throw new Error('Erreur lors du rechargement');
        }
        
        const html = await response.text();
        
        // Trouver le conteneur du rightsheet
        const container = document.getElementById('planning-rightsheet-container');
        if (!container) return;
        
        // Extraire et exécuter les scripts AVANT d'injecter le HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = tempDiv.querySelectorAll('script');
        const htmlWithoutScripts = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        
        // Exécuter les scripts
        scripts.forEach(script => {
          if (script.src) {
            const newScript = document.createElement('script');
            newScript.src = script.src;
            document.head.appendChild(newScript);
          } else {
            try {
              eval(script.textContent);
            } catch (e) {
              console.error('Erreur lors de l\'exécution du script:', e);
            }
          }
        });
        
        // Injecter le HTML sans les scripts
        container.innerHTML = htmlWithoutScripts;
        
        // Initialiser Alpine.js sur le nouveau contenu
        setTimeout(() => {
          if (window.Alpine) {
            Alpine.initTree(container);
          }
        }, 100);
      } catch (error) {
        console.error('Erreur lors du rechargement du rightsheet:', error);
      }
    },
    
    init() {
      // Initialiser updateDateTime si nécessaire
      if (this.formData.date && this.formData.startTime && this.formData.endTime) {
        this.updateDateTime();
      }
    }
  };
};
</script>

