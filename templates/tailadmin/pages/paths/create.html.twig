{% extends 'tailadmin/layouts/base.html.twig' %}

{% block content %}
<div 
    x-data="pathCreateManager()"
    data-classrooms='{{ classrooms|json_encode|e('html_attr') }}'
    data-module-types='{{ moduleTypes|json_encode|e('html_attr') }}'
    class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6"
>
    {% include 'tailadmin/components/breadcrumb.html.twig' %}

    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
        <div class="px-6 py-5 border-b border-gray-100 dark:border-gray-800">
            <h3 class="text-base font-medium text-gray-800 dark:text-white/90">
                Nouveau parcours scolaire
            </h3>
        </div>

        <form @submit.prevent="submitForm()" class="p-6 space-y-6">
            <!-- S√©lection hi√©rarchique -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe</label>
                    <select x-model="selectedClassroomId" @change="loadSubjects()" required
                        class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
                        <option value="">S√©lectionner une classe</option>
                        <template x-for="classroom in classrooms" :key="classroom.id">
                            <option :value="classroom.id" x-text="classroom.name"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mati√®re</label>
                    <select x-model="selectedSubjectId" @change="loadChapters()" :disabled="!selectedClassroomId" required
                        class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
                        <option value="">S√©lectionner une mati√®re</option>
                        <template x-for="subject in subjects" :key="subject.id">
                            <option :value="subject.id" x-text="subject.name"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chapitre</label>
                    <select x-model="selectedChapterId" @change="loadSubChapters()" :disabled="!selectedSubjectId" required
                        class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
                        <option value="">S√©lectionner un chapitre</option>
                        <template x-for="chapter in chapters" :key="chapter.id">
                            <option :value="chapter.id" x-text="chapter.name"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sous-chapitre</label>
                    <select x-model="selectedSubChapterId" @change="loadPrompts()" :disabled="!selectedChapterId"
                        class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
                        <option value="">S√©lectionner un sous-chapitre (optionnel)</option>
                        <template x-for="subChapter in subChapters" :key="subChapter.id">
                            <option :value="subChapter.id" x-text="subChapter.name"></option>
                        </template>
                    </select>
                </div>
            </div>

            <!-- Type de parcours -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type</label>
                <select x-model="selectedType" @change="onTypeChange()" required
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90">
                    <option value="">S√©lectionner un type</option>
                    <option value="h5p">H5P</option>
                    <option value="video">Vid√©o</option>
                    <option value="link">Lien</option>
                    <option value="kahoot">Kahoot</option>
                </select>
            </div>

            <!-- Lien (si type != h5p) -->
            <div x-show="selectedType && selectedType !== 'h5p'">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lien</label>
                <input type="url" x-model="link" :required="selectedType && selectedType !== 'h5p'"
                    class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                    placeholder="https://...">
            </div>

            <!-- Gestion des prompts personnalis√©s (si type = h5p) -->
            <div x-show="selectedType === 'h5p'">
                <div class="mb-4 rounded-lg border border-blue-200 bg-blue-50 p-4 dark:border-blue-800 dark:bg-blue-900/20">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        <strong>üí° Comment √ßa marche :</strong> S√©lectionnez ou cr√©ez des prompts personnalis√©s (max 5). Chaque prompt personnalis√© sera utilis√© pour g√©n√©rer un module H5P du type sp√©cifi√©.
                    </p>
                </div>

                <!-- Layout en deux colonnes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Colonne gauche : Prompts s√©lectionn√©s -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h5 class="text-sm font-semibold text-gray-800 dark:text-white/90">
                                üìù Mes prompts (<span x-text="selectedPrompts.length"></span>/5)
                            </h5>
                            <button 
                                type="button" 
                                @click="addCustomPrompt()" 
                                :disabled="selectedPrompts.length >= 5"
                                class="inline-flex items-center gap-1 rounded-lg bg-brand-500 px-2.5 py-1.5 text-xs font-medium text-white hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Nouveau
                            </button>
                        </div>
                        
                        <div class="space-y-3 max-h-[600px] overflow-y-auto">
                            <template x-for="(prompt, index) in selectedPrompts" :key="index">
                                <div class="relative rounded-lg border-2 border-gray-200 bg-white p-4 dark:border-gray-700 dark:bg-gray-800/50 hover:border-brand-300 dark:hover:border-brand-700 transition-colors">
                                    <!-- Bouton supprimer (croix en haut √† droite) -->
                                    <button 
                                        type="button"
                                        @click="removePrompt(index)"
                                        class="absolute top-3 right-3 rounded-lg p-1.5 text-gray-400 hover:bg-red-50 hover:text-red-600 dark:hover:bg-red-900/20 dark:hover:text-red-300 transition-colors"
                                        title="Supprimer ce prompt"
                                    >
                                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                    
                                    <!-- Champs toujours √©ditables -->
                                    <div class="space-y-3 pr-8">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                Type de module <span class="text-red-500">*</span>
                                            </label>
                                            <select 
                                                x-model="prompt.type"
                                                required
                                                class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                                            >
                                                <option value="">S√©lectionner un type</option>
                                                <template x-for="moduleType in moduleTypes" :key="moduleType.value">
                                                    <option 
                                                        :value="moduleType.value" 
                                                        :selected="prompt.type === moduleType.value"
                                                        x-text="moduleType.label"
                                                    ></option>
                                                </template>
                                            </select>
                                            <!-- Debug: afficher le type actuel -->
                                            <div x-show="prompt.type" class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                                Type s√©lectionn√©: <span x-text="prompt.type"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                Description <span class="text-red-500">*</span>
                                            </label>
                                            <textarea 
                                                x-model="prompt.prompt_generation"
                                                rows="5"
                                                required
                                                class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-800 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"
                                                placeholder="Description du prompt personnalis√©..."
                                            ></textarea>
                                        </div>
                                        <div x-show="prompt.niveau" class="text-xs text-gray-500 dark:text-gray-400">
                                            Niveau: <span x-text="prompt.niveau"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="selectedPrompts.length === 0" class="rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-6 text-center dark:border-gray-700 dark:bg-gray-800/30">
                                <svg class="mx-auto h-12 w-12 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Aucun prompt s√©lectionn√©</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500">Ajoutez des prompts pr√©d√©finis √† droite ou cr√©ez-en un personnalis√©</p>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite : Prompts pr√©d√©finis disponibles -->
                    <div>
                        <h5 class="text-sm font-semibold text-gray-800 dark:text-white/90 mb-3">
                            üìö Prompts pr√©d√©finis disponibles
                        </h5>
                        
                        <!-- Prompts du sous-chapitre (priorit√©) -->
                        <div x-show="subChapterPrompts.length > 0">
                            <h6 class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2 uppercase tracking-wide">Du sous-chapitre</h6>
                            <div class="space-y-2 max-h-[400px] overflow-y-auto border border-gray-200 rounded-lg p-3 dark:border-gray-800">
                                <template x-for="(prompt, index) in subChapterPrompts" :key="index">
                                    <div class="flex items-start gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-800 dark:bg-gray-800/50 hover:border-brand-300 dark:hover:border-brand-700 transition-colors">
                                        <div class="flex-1 text-left">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span x-show="prompt.type" class="inline-flex items-center rounded-md bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 text-xs font-medium text-blue-700 dark:text-blue-300" x-text="getPromptTypeLabel(prompt.type)"></span>
                                                <span x-show="prompt.niveau" class="text-xs text-gray-500 dark:text-gray-400" x-text="'Niveau: ' + prompt.niveau"></span>
                                            </div>
                                            <p class="text-sm text-gray-700 dark:text-gray-300 line-clamp-3" x-text="prompt.prompt_generation"></p>
                                        </div>
                                        <button
                                            type="button"
                                            @click="addPredefinedPrompt(prompt, 'subchapter')"
                                            :disabled="selectedPrompts.length >= 5 || isPromptAlreadyAdded(prompt)"
                                            class="flex-shrink-0 inline-flex items-center justify-center rounded-lg bg-brand-500 px-2.5 py-2 text-sm font-medium text-white hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            title="Ajouter ce prompt"
                                        >
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Prompts du chapitre (fallback si pas de prompts dans sous-chapitre) -->
                        <div x-show="subChapterPrompts.length === 0 && chapterPrompts.length > 0">
                            <h6 class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2 uppercase tracking-wide">Du chapitre</h6>
                            <div class="space-y-2 max-h-[400px] overflow-y-auto border border-gray-200 rounded-lg p-3 dark:border-gray-800">
                                <template x-for="(prompt, index) in chapterPrompts" :key="index">
                                    <div class="flex items-start gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-800 dark:bg-gray-800/50 hover:border-brand-300 dark:hover:border-brand-700 transition-colors">
                                        <div class="flex-1 text-left">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span x-show="prompt.type" class="inline-flex items-center rounded-md bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 text-xs font-medium text-blue-700 dark:text-blue-300" x-text="getPromptTypeLabel(prompt.type)"></span>
                                                <span x-show="prompt.niveau" class="text-xs text-gray-500 dark:text-gray-400" x-text="'Niveau: ' + prompt.niveau"></span>
                                            </div>
                                            <p class="text-sm text-gray-700 dark:text-gray-300 line-clamp-3" x-text="prompt.prompt_generation"></p>
                                        </div>
                                        <button
                                            type="button"
                                            @click="addPredefinedPrompt(prompt, 'chapter')"
                                            :disabled="selectedPrompts.length >= 5 || isPromptAlreadyAdded(prompt)"
                                            class="flex-shrink-0 inline-flex items-center justify-center rounded-lg bg-brand-500 px-2.5 py-2 text-sm font-medium text-white hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            title="Ajouter ce prompt"
                                        >
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div x-show="chapterPrompts.length === 0 && subChapterPrompts.length === 0" class="rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-6 text-center dark:border-gray-700 dark:bg-gray-800/30">
                            <p class="text-xs text-gray-500 dark:text-gray-400">Aucun prompt pr√©d√©fini disponible</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">S√©lectionnez un chapitre pour voir les prompts</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Boutons -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-800">
                <a href="{{ path('admin_paths_list') }}" 
                    class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03]">
                    Annuler
                </a>
                <button type="submit" :disabled="isGenerating"
                    class="inline-flex items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!isGenerating">Cr√©er le parcours</span>
                    <span x-show="isGenerating">G√©n√©ration en cours...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function pathCreateManager() {
    return {
        classrooms: [],
        subjects: [],
        chapters: [],
        subChapters: [],
        chapterPrompts: [],
        subChapterPrompts: [],
        selectedPrompts: [], // Prompts s√©lectionn√©s (max 5)
        moduleTypes: [],
        selectedClassroomId: '',
        selectedSubjectId: '',
        selectedChapterId: '',
        selectedSubChapterId: '',
        selectedType: '',
        link: '',
        isGenerating: false,

        init() {
            this.classrooms = JSON.parse(this.$el.dataset.classrooms || '[]');
            this.moduleTypes = JSON.parse(this.$el.dataset.moduleTypes || '[]');
        },

        async loadSubjects() {
            if (!this.selectedClassroomId) {
                this.subjects = [];
                return;
            }
            
            try {
                const response = await fetch(`/api/classrooms/${this.selectedClassroomId}/subjects`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.subjects = Array.isArray(data) ? data : [];
                this.selectedSubjectId = '';
                this.chapters = [];
                this.subChapters = [];
                
                console.log('Mati√®res charg√©es:', this.subjects.length, 'mati√®res');
            } catch (error) {
                console.error('Erreur lors du chargement des mati√®res:', error);
                this.subjects = [];
                alert('Erreur lors du chargement des mati√®res. Veuillez r√©essayer.');
            }
        },

        async loadChapters() {
            if (!this.selectedSubjectId) {
                this.chapters = [];
                return;
            }
            try {
                const response = await fetch(`/api/subjects/${this.selectedSubjectId}/chapters`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.chapters = Array.isArray(data) ? data : [];
                this.chapterPrompts = this.chapters.find(c => c.id == this.selectedChapterId)?.prompts || [];
                this.selectedChapterId = '';
                this.subChapters = [];
                
                console.log('Chapitres charg√©s:', this.chapters);
            } catch (error) {
                console.error('Erreur lors du chargement des chapitres:', error);
                this.chapters = [];
                alert('Erreur lors du chargement des chapitres. Veuillez r√©essayer.');
            }
        },

        async loadSubChapters() {
            if (!this.selectedChapterId) {
                this.subChapters = [];
                return;
            }
            try {
                const response = await fetch(`/api/chapters/${this.selectedChapterId}/subchapters`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.subChapters = Array.isArray(data) ? data : [];
                this.chapterPrompts = this.chapters.find(c => c.id == this.selectedChapterId)?.prompts || [];
                this.selectedSubChapterId = '';
                this.subChapterPrompts = [];
                
                console.log('Sous-chapitres charg√©s:', this.subChapters);
            } catch (error) {
                console.error('Erreur lors du chargement des sous-chapitres:', error);
                this.subChapters = [];
                alert('Erreur lors du chargement des sous-chapitres. Veuillez r√©essayer.');
            }
        },

        loadPrompts() {
            if (this.selectedSubChapterId) {
                const subChapter = this.subChapters.find(sc => sc.id == this.selectedSubChapterId);
                this.subChapterPrompts = subChapter?.prompts || [];
            }
        },

        // Gestion des prompts s√©lectionn√©s
        addPredefinedPrompt(prompt, source) {
            if (this.selectedPrompts.length >= 5) {
                alert('Vous ne pouvez s√©lectionner que 5 prompts maximum');
                return;
            }
            
            // V√©rifier si le prompt n'est pas d√©j√† ajout√©
            if (this.isPromptAlreadyAdded(prompt)) {
                alert('Ce prompt est d√©j√† ajout√©');
                return;
            }

            // IMPORTANT: Le type peut √™tre dans prompt.type, prompt.module_type, ou prompt.moduleType
            // Essayer toutes les variantes possibles
            const rawType = prompt.type || prompt.module_type || prompt.moduleType || '';
            
            // Normaliser le type (convertir "fill_in_the_blank" en "Blanks" par exemple)
            const normalizedType = this.normalizePromptType(rawType);
            
            // V√©rifier que le type normalis√© existe dans moduleTypes
            const typeExists = this.moduleTypes.some(mt => mt.value === normalizedType);
            if (!typeExists && normalizedType) {
                console.warn('Type normalis√© non trouv√© dans moduleTypes:', normalizedType, 'rawType:', rawType);
                console.warn('Valeurs disponibles dans moduleTypes:', this.moduleTypes.map(mt => mt.value));
            }
            
            // Ajouter le prompt directement (toujours √©ditable)
            // IMPORTANT: Conserver le type du prompt pr√©d√©fini s'il existe
            // Utiliser une assignation directe pour que Alpine.js d√©tecte le changement
            const newPrompt = {
                type: normalizedType || '', // Type normalis√© (valeur d'enum exacte) - toujours une string
                prompt_generation: prompt.prompt_generation || prompt.content || '',
                niveau: prompt.niveau || null,
                source: source, // 'chapter' ou 'subchapter'
            };
            
            console.log('Ajout prompt pr√©d√©fini:', { 
                original: prompt, 
                rawType: rawType,
                normalizedType: normalizedType,
                typeExists: typeExists,
                moduleTypesValues: this.moduleTypes.map(mt => mt.value),
                newPromptType: newPrompt.type,
                new: newPrompt 
            });
            
            // Ajouter le prompt
            this.selectedPrompts.push(newPrompt);
            
            // Forcer la r√©activit√© d'Alpine.js en acc√©dant √† la propri√©t√©
            const addedIndex = this.selectedPrompts.length - 1;
            const addedPrompt = this.selectedPrompts[addedIndex];
            
            // Double v√©rification : s'assurer que le type est bien assign√©
            if (addedPrompt && normalizedType && addedPrompt.type !== normalizedType) {
                console.log('Correction du type:', addedPrompt.type, '->', normalizedType);
                addedPrompt.type = normalizedType;
            }
            
            // Log final pour v√©rification
            console.log('Prompt ajout√©, type final:', this.selectedPrompts[addedIndex].type);
        },

        addCustomPrompt() {
            if (this.selectedPrompts.length >= 5) {
                alert('Vous ne pouvez s√©lectionner que 5 prompts maximum');
                return;
            }

            const newPrompt = {
                type: '',
                prompt_generation: '',
                niveau: null,
                source: 'custom',
            };
            
            this.selectedPrompts.push(newPrompt);
        },

        removePrompt(index) {
            this.selectedPrompts.splice(index, 1);
        },

        isPromptAlreadyAdded(prompt) {
            // V√©rifier si un prompt avec le m√™me contenu est d√©j√† ajout√©
            return this.selectedPrompts.some(sp => 
                sp.prompt_generation === prompt.prompt_generation &&
                sp.type === prompt.type
            );
        },

        getPromptTypeLabel(type) {
            if (!type) return 'Non d√©fini';
            
            // Mapper les types bruts (snake_case) vers les valeurs de l'enum (PascalCase ou UPPER_CASE)
            const typeMapping = {
                'fill_in_the_blank': 'Blanks',
                'multiple_choice': 'MultiChoice',
                'true_false': 'TrueFalse',
                'short_answer': 'SHORT_ANSWER',
                'open_question': 'OPEN_QUESTION',
                'flashcards': 'Flashcards',
                // Ajouter d'autres mappings si n√©cessaire
            };
            
            // Convertir le type brut en valeur d'enum si n√©cessaire
            const enumValue = typeMapping[type] || type;
            
            // Chercher dans moduleTypes (comparaison exacte et insensible √† la casse)
            const moduleType = this.moduleTypes.find(mt => 
                mt.value === enumValue || 
                mt.value === type ||
                mt.value.toLowerCase() === enumValue.toLowerCase() ||
                mt.value.toLowerCase() === type.toLowerCase()
            );
            
            if (moduleType) {
                return moduleType.label;
            }
            
            // Si pas trouv√©, retourner le type original (pour d√©bogage)
            console.warn('Type de module non trouv√©:', type, 'enumValue:', enumValue, 'moduleTypes:', this.moduleTypes);
            return type;
        },
        
        // Convertir un type brut (ex: "fill_in_the_blank") en valeur d'enum (ex: "Blanks")
        normalizePromptType(type) {
            if (!type || typeof type !== 'string') {
                console.warn('normalizePromptType: type invalide', type);
                return '';
            }
            
            const typeStr = String(type).trim();
            if (!typeStr) return '';
            
            // D'abord, v√©rifier si c'est d√©j√† une valeur d'enum valide (comparaison exacte)
            const exactMatch = this.moduleTypes.find(mt => mt.value === typeStr);
            if (exactMatch) {
                console.log('Type exact trouv√©:', typeStr, '->', exactMatch.value);
                return exactMatch.value;
            }
            
            // Mapping des types bruts (snake_case) vers les valeurs de l'enum (PascalCase ou UPPER_CASE)
            const typeMapping = {
                'fill_in_the_blank': 'Blanks',
                'multiple_choice': 'MultiChoice',
                'true_false': 'TrueFalse',
                'short_answer': 'SHORT_ANSWER',
                'open_question': 'OPEN_QUESTION',
                'flashcards': 'Flashcards',
                // Ajouter d'autres mappings si n√©cessaire
            };
            
            // Convertir via le mapping
            const mappedValue = typeMapping[typeStr];
            if (mappedValue) {
                // V√©rifier que la valeur mapp√©e existe dans moduleTypes
                const mappedMatch = this.moduleTypes.find(mt => mt.value === mappedValue);
                if (mappedMatch) {
                    console.log('Type mapp√© trouv√©:', typeStr, '->', mappedMatch.value);
                    return mappedMatch.value;
                } else {
                    console.warn('Type mapp√© non trouv√© dans moduleTypes:', mappedValue);
                }
            }
            
            // Si rien ne correspond, essayer une recherche insensible √† la casse
            const caseInsensitiveMatch = this.moduleTypes.find(mt => 
                String(mt.value).toLowerCase() === typeStr.toLowerCase()
            );
            if (caseInsensitiveMatch) {
                console.log('Type trouv√© (insensible √† la casse):', typeStr, '->', caseInsensitiveMatch.value);
                return caseInsensitiveMatch.value;
            }
            
            // En dernier recours, retourner le type original
            console.warn('Type non normalis√© trouv√©:', typeStr, 'moduleTypes disponibles:', this.moduleTypes.map(mt => mt.value));
            return typeStr;
        },


        onTypeChange() {
            if (this.selectedType !== 'h5p') {
                this.selectedPrompts = []; // R√©initialiser les prompts si on change de type
            }
        },

        async submitForm() {
            if (this.isGenerating) return;

            // Nettoyer les prompts (enlever les propri√©t√©s internes)
            const cleanedPrompts = this.selectedPrompts
                .filter(p => p.type && p.prompt_generation && p.prompt_generation.trim() !== '') // Filtrer les prompts incomplets
                .map(p => ({
                    type: p.type,
                    prompt_generation: p.prompt_generation || '',
                    niveau: p.niveau || null,
                    source: p.source || 'custom'
                }));

            // Validation : au moins un prompt personnalis√© est requis pour H5P
            if (this.selectedType === 'h5p' && cleanedPrompts.length === 0) {
                alert('Veuillez s√©lectionner ou cr√©er au moins un prompt personnalis√© pour g√©n√©rer le parcours H5P');
                return;
            }

            const formData = {
                classroomId: parseInt(this.selectedClassroomId),
                subjectId: parseInt(this.selectedSubjectId),
                chapterId: parseInt(this.selectedChapterId),
                subChapterId: this.selectedSubChapterId ? parseInt(this.selectedSubChapterId) : null,
                type: this.selectedType,
                link: this.link,
                prompts: cleanedPrompts // Les prompts personnalis√©s remplacent les modules
            };

            this.isGenerating = true;

            try {
                const response = await fetch('/admin/paths/generate', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la cr√©ation');
                }

                if (data.status === 'generating') {
                    // G√©n√©ration asynchrone - polling
                    this.pollPathStatus(data.pathId);
                } else {
                    // G√©n√©ration imm√©diate
                    window.location.href = `/admin/paths/${data.pathId}`;
                }
            } catch (error) {
                alert('Erreur: ' + error.message);
                this.isGenerating = false;
            }
        },

        async pollPathStatus(pathId) {
            const maxAttempts = 60; // 2 minutes max
            let attempts = 0;

            const checkStatus = async () => {
                try {
                    const response = await fetch(`/admin/paths/${pathId}/status`, {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                    });
                    const data = await response.json();

                    if (data.status === 'generated' || data.status === 'published') {
                        window.location.href = `/admin/paths/${pathId}`;
                    } else if (data.status === 'draft' && attempts > 5) {
                        // Probablement une erreur
                        alert('La g√©n√©ration a √©chou√©. Le parcours est rest√© en brouillon.');
                        window.location.href = `/admin/paths/${pathId}`;
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkStatus, 2000); // V√©rifier toutes les 2 secondes
                    } else {
                        alert('Timeout: La g√©n√©ration prend plus de temps que pr√©vu.');
                        window.location.href = `/admin/paths/${pathId}`;
                    }
                } catch (error) {
                    console.error('Erreur lors de la v√©rification du statut:', error);
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkStatus, 2000);
                    }
                }
            };

            checkStatus();
        }
    }
}
</script>
{% endblock %}

